function castSpell() {
  if (turn !== 'player') {
    log('Not your turn!');
    return;
  }
  const spell = spellInput.value.trim().toLowerCase();
  if (!spell) return;

  // Simple command patterns:
  // attack
  // heal
  // strong attack
  // attack if enemy hp below N
  // heal if player hp below N

  let executed = false;

  // Heal command
  if (/^heal$/.test(spell)) {
    player.hp = Math.min(player.hp + 30, 100);
    log(`You heal 30 HP! Player HP: ${player.hp}`);
    executed = true;
  } else if (/^attack$/.test(spell)) {
    const dmg = 20;
    enemy.hp -= dmg;
    log(`You attack! Enemy loses ${dmg} HP (HP left: ${enemy.hp})`);
    executed = true;
  } else if (/^strong attack$/.test(spell)) {
    const dmg = 40;
    enemy.hp -= dmg;
    log(`Strong attack! Enemy loses ${dmg} HP (HP left: ${enemy.hp})`);
    executed = true;
  } else {
    // Conditional commands like: attack if enemy hp below 50
    let m;
    if (m = spell.match(/^attack if enemy hp below (\d+)$/)) {
      const threshold = parseInt(m[1], 10);
      if (enemy.hp < threshold) {
        const dmg = 20;
        enemy.hp -= dmg;
        log(`Conditional attack! Enemy loses ${dmg} HP (HP left: ${enemy.hp})`);
      } else {
        log(`Condition not met. Enemy HP is ${enemy.hp}, needs to be below ${threshold}`);
      }
      executed = true;
    } else if (m = spell.match(/^heal if player hp below (\d+)$/)) {
      const threshold = parseInt(m[1], 10);
      if (player.hp < threshold) {
        player.hp = Math.min(player.hp + 30, 100);
        log(`Conditional heal! Player HP restored to ${player.hp}`);
      } else {
        log(`Condition not met. Player HP is ${player.hp}, needs to be below ${threshold}`);
      }
      executed = true;
    }
  }

  if (!executed) {
    log('Unknown spell command. Try: attack, heal, strong attack, or use conditions like "attack if enemy hp below 50"');
  } else {
    if (enemy.hp <= 0) {
      alert('Enemy defeated! You win!');
      resetGame();
      return;
    }
    turn = 'enemy';
    draw();
    setTimeout(enemyTurn, 500);
  }

  spellInput.value = '';
}
