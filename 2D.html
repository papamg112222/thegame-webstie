<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Warfare: Peer-to-Peer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <!-- PeerJS for Serverless Multiplayer -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Inter:wght@400;600;800&display=swap');

        body { margin: 0; overflow: hidden; background-color: #0f0f11; font-family: 'Inter', sans-serif; user-select: none; color: white; }
        canvas { display: block; }
        
        /* UI Layer */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .pointer-events-auto { pointer-events: auto; }
        
        /* Glassmorphism Panels */
        .glass-panel {
            background: rgba(15, 15, 20, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            transition: all 0.2s;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6); }
        .btn-primary:active { transform: translateY(1px); }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.1); }

        /* HUD Bars */
        .health-bar-container {
            width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; overflow: hidden; margin-top: 6px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.8);
        }
        .health-bar-fill { height: 100%; transition: width 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        /* Animations */
        @keyframes pulse-scan {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .status-dot { animation: pulse-scan 2s infinite; }

        input::placeholder { color: #555; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- Menu UI -->
<div id="menu-screen" class="absolute inset-0 flex items-center justify-center z-50 bg-black bg-opacity-90">
    <!-- Background Grid Effect -->
    <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#444 1px, transparent 1px); background-size: 30px 30px;"></div>

    <div class="glass-panel p-10 rounded-2xl max-w-md w-full text-center relative z-10 border-t border-gray-700">
        <div class="mb-8">
            <h1 class="text-5xl font-black mb-1 tracking-tighter italic bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-white">TACTICAL<span class="text-gray-500">WARFARE</span></h1>
            <p class="text-gray-400 text-xs tracking-widest uppercase font-bold">Peer-to-Peer Tactical Simulator</p>
        </div>

        <div id="main-menu-state">
            <div class="space-y-4">
                <input type="text" id="player-name" placeholder="OPERATIVE NAME" class="w-full bg-gray-900 border border-gray-700 text-white px-4 py-4 rounded-lg font-bold text-center focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition placeholder-gray-600 uppercase tracking-wider">
                
                <div class="grid grid-cols-2 gap-4">
                    <button id="btn-create-mode" class="btn-primary py-4 rounded-xl font-bold text-sm tracking-wide flex flex-col items-center justify-center gap-1">
                        <i class="fas fa-server text-xl"></i> HOST OP
                    </button>
                    <button id="btn-join-mode" class="btn-secondary py-4 rounded-xl font-bold text-sm tracking-wide flex flex-col items-center justify-center gap-1 text-gray-300">
                        <i class="fas fa-satellite-dish text-xl"></i> JOIN OP
                    </button>
                </div>
            </div>
            
            <!-- Join Input Slide-down -->
            <div id="join-input-area" class="hidden mt-4 pt-4 border-t border-gray-700">
                <p class="text-xs text-left text-gray-500 mb-2 font-bold uppercase">Enter 4-Digit Access Code</p>
                <div class="flex gap-2">
                    <input type="text" id="game-code-input" placeholder="0000" maxlength="4" class="flex-1 bg-black border border-gray-600 px-4 py-3 rounded-lg text-white font-mono text-2xl text-center tracking-[0.5em] focus:outline-none focus:border-green-500 focus:text-green-400 transition">
                    <button id="btn-connect" class="bg-green-600 hover:bg-green-500 text-white px-6 rounded-lg font-bold transition"><i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
        </div>

        <!-- Lobby State -->
        <div id="lobby-state" class="hidden text-left">
            <div class="bg-gray-900 p-6 rounded-xl mb-6 border border-gray-800 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fas fa-fingerprint text-6xl"></i></div>
                <p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-1">Mission Access Code</p>
                <div class="flex items-baseline gap-4">
                    <span id="display-code" class="text-5xl font-mono font-bold text-green-400 tracking-widest drop-shadow-lg">....</span>
                    <span class="text-xs text-gray-500 animate-pulse">WAITING FOR UPLINK</span>
                </div>
            </div>

            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3">Select Weapon System</h3>
            <div class="grid grid-cols-3 gap-3 mb-8">
                <button class="loadout-btn relative overflow-hidden bg-gray-800 p-3 rounded-lg border border-gray-700 hover:border-gray-500 transition group" data-gun="glock">
                    <div class="absolute inset-0 bg-yellow-500 opacity-0 group-hover:opacity-5 transition"></div>
                    <div class="font-bold text-sm text-yellow-400">SIDEARM</div>
                    <div class="text-[10px] text-gray-400 mt-1">High Mobility</div>
                </button>
                <button class="loadout-btn relative overflow-hidden bg-gray-800 p-3 rounded-lg border-2 border-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.3)] transition group" data-gun="ar">
                    <div class="absolute inset-0 bg-blue-500 opacity-0 group-hover:opacity-5 transition"></div>
                    <div class="font-bold text-sm text-blue-400">RIFLE</div>
                    <div class="text-[10px] text-gray-400 mt-1">Balanced</div>
                </button>
                <button class="loadout-btn relative overflow-hidden bg-gray-800 p-3 rounded-lg border border-gray-700 hover:border-gray-500 transition group" data-gun="sniper">
                    <div class="absolute inset-0 bg-red-500 opacity-0 group-hover:opacity-5 transition"></div>
                    <div class="font-bold text-sm text-red-400">HEAVY</div>
                    <div class="text-[10px] text-gray-400 mt-1">Long Range</div>
                </button>
            </div>

            <div class="space-y-2 mb-6 text-sm font-mono">
                <div class="flex justify-between items-center p-2 bg-gray-800 rounded">
                    <span class="text-gray-400">HOST</span>
                    <span id="p1-lobby-name" class="font-bold text-white">...</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-gray-800 rounded">
                    <span class="text-gray-400">CLIENT</span>
                    <span id="p2-lobby-name" class="font-bold text-gray-500">SEARCHING...</span>
                </div>
            </div>

            <button id="btn-launch" class="w-full bg-gray-700 text-gray-400 py-4 rounded-xl font-bold text-lg tracking-widest transition cursor-not-allowed" disabled>AWAITING CONNECTION</button>
        </div>
    </div>
</div>

<!-- HUD -->
<div id="hud" class="hidden pointer-events-none absolute inset-0 p-6 flex flex-col justify-between">
    <!-- Top Bar -->
    <div class="flex justify-between items-start w-full">
        <!-- Blue Team (Left) -->
        <div class="glass-panel px-4 py-3 rounded-br-2xl border-l-4 border-blue-500 w-80 pointer-events-auto transform skew-x-[-10deg] origin-top-left">
            <div class="transform skew-x-[10deg]">
                <div class="flex justify-between text-xs font-bold tracking-widest mb-2">
                    <span class="text-blue-400">ALPHA TOWER</span>
                    <span id="blue-hp-text" class="text-white">1000</span>
                </div>
                <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                    <div id="blue-bar" class="h-full bg-blue-500 shadow-[0_0_10px_#3b82f6]" style="width: 100%"></div>
                </div>
            </div>
        </div>

        <!-- Timer/Score -->
        <div class="glass-panel px-8 py-2 rounded-b-xl border-t-0 border-white/10">
            <span class="font-mono text-2xl font-bold tracking-widest text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">00:00</span>
        </div>

        <!-- Red Team (Right) -->
        <div class="glass-panel px-4 py-3 rounded-bl-2xl border-r-4 border-red-500 w-80 pointer-events-auto transform skew-x-[10deg] origin-top-right">
            <div class="transform skew-x-[-10deg]">
                <div class="flex justify-between text-xs font-bold tracking-widest mb-2">
                    <span id="red-hp-text" class="text-white">1000</span>
                    <span class="text-red-400">BRAVO TOWER</span>
                </div>
                <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden flex justify-end">
                    <div id="red-bar" class="h-full bg-red-500 shadow-[0_0_10px_#ef4444]" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Info -->
    <div class="flex items-end justify-between">
        <!-- Player Stats -->
        <div class="glass-panel p-5 rounded-tr-3xl border-l-4 border-green-500 pointer-events-auto min-w-[300px]">
            <div class="flex items-center gap-5">
                <div class="w-16 h-16 bg-gray-800 rounded-lg border border-gray-600 flex items-center justify-center relative overflow-hidden">
                    <i class="fas fa-user-astronaut text-3xl text-gray-500"></i>
                    <div class="absolute inset-0 bg-gradient-to-t from-green-500/20 to-transparent"></div>
                </div>
                <div class="flex-1">
                    <h2 id="hud-name" class="font-black text-2xl uppercase italic leading-none mb-1">OPERATOR</h2>
                    <div class="text-xs text-green-400 font-bold tracking-widest mb-2" id="hud-gun">ASSAULT RIFLE</div>
                    <div class="w-full h-3 bg-gray-800 rounded-sm overflow-hidden relative">
                        <div class="absolute inset-0 bg-repeat-x opacity-20" style="background-image: linear-gradient(90deg, transparent 50%, rgba(0,0,0,0.5) 50%); background-size: 10px 100%;"></div>
                        <div id="hud-hp-bar" class="h-full bg-green-500" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="text-right opacity-60 text-[10px] font-mono space-y-1">
            <div><span class="bg-gray-700 px-1 rounded text-white font-bold">R-CLICK</span> MOVE</div>
            <div><span class="bg-gray-700 px-1 rounded text-white font-bold">L-CLICK</span> FIRE</div>
        </div>
    </div>
</div>

<!-- Game Over Overlay -->
<div id="end-screen" class="hidden absolute inset-0 bg-black/90 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="text-center">
        <h1 id="end-title" class="text-8xl font-black italic tracking-tighter mb-2 drop-shadow-[0_0_30px_rgba(255,255,255,0.2)]">VICTORY</h1>
        <div class="h-1 w-32 bg-white mx-auto mb-6"></div>
        <p id="end-reason" class="text-gray-400 font-mono tracking-widest text-sm mb-8">TARGET DESTROYED</p>
        <button onclick="location.reload()" class="bg-white text-black font-bold py-3 px-8 rounded-full hover:scale-105 transition">RTB (RELOAD)</button>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    // --- Configuration ---
    const PEER_PREFIX = "tactical-warfare-v1-"; // Unique namespace
    const CANVAS = document.getElementById('gameCanvas');
    const CTX = CANVAS.getContext('2d', { alpha: false }); // Optimize
    
    // Core Game Config
    const MAP_W = 2500;
    const MAP_H = 1800;
    const TOWER_MAX_HP = 1500;
    const PLAYER_MAX_HP = 500;

    // --- Asset Generation (Procedural) ---
    const COLORS = {
        bg: '#121214',
        grid: '#1a1a1e',
        blue: '#3b82f6',
        red: '#ef4444',
        wallTop: '#3f3f46',
        wallSide: '#27272a',
        obstacle: '#2a2a30'
    };

    const GUNS = {
        glock: { name: 'GLOCK 19', dmg: 45, rate: 350, speed: 22, spread: 0.08, color: '#fbbf24', length: 25 },
        ar: { name: 'M4A1 CARBINE', dmg: 32, rate: 90, speed: 28, spread: 0.12, color: '#60a5fa', length: 40 },
        sniper: { name: 'AWP .338', dmg: 250, rate: 1400, speed: 45, spread: 0.005, color: '#f87171', length: 60 }
    };

    // --- State ---
    let myPeerId = null;
    let peer = null;
    let conn = null;
    let isHost = false;
    let gameActive = false;
    let lastTime = 0;
    let gameCode = "";

    // Entities
    let localPlayer = { x: 0, y: 0, destX: 0, destY: 0, angle: 0, hp: PLAYER_MAX_HP, gun: 'ar', team: 'blue', moving: false, name: 'You' };
    let remotePlayer = { x: -500, y: -500, angle: 0, hp: PLAYER_MAX_HP, gun: 'ar', team: 'red', moving: false, name: 'Enemy', targetX: -500, targetY: -500 };
    
    let bullets = [];
    let particles = [];
    let decals = []; // Blood, scorch marks
    let damageNumbers = [];
    let walls = [];
    let camera = { x: 0, y: 0, shake: 0 };
    let mouse = { x: 0, y: 0, worldX: 0, worldY: 0 };
    let towers = { blue: { x: 0, y: 0, hp: TOWER_MAX_HP }, red: { x: 0, y: 0, hp: TOWER_MAX_HP } };

    // --- Initialization & Menu ---
    function init() {
        resize();
        window.addEventListener('resize', resize);
        
        // UI Bindings
        document.getElementById('btn-create-mode').onclick = setupHost;
        document.getElementById('btn-join-mode').onclick = () => {
            document.getElementById('join-input-area').classList.remove('hidden');
            document.getElementById('game-code-input').focus();
        };
        document.getElementById('btn-connect').onclick = joinGame;
        
        // Gun Selection
        document.querySelectorAll('.loadout-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.loadout-btn').forEach(b => {
                    b.style.borderColor = 'rgba(255,255,255,0.1)';
                    b.classList.remove('shadow-[0_0_15px_rgba(59,130,246,0.3)]');
                });
                btn.style.borderColor = '#3b82f6';
                btn.classList.add('shadow-[0_0_15px_rgba(59,130,246,0.3)]');
                localPlayer.gun = btn.dataset.gun;
                if(conn) send({ type: 'lobby_update', name: localPlayer.name, gun: localPlayer.gun });
            };
        });

        document.getElementById('btn-launch').onclick = () => {
            const seed = Date.now();
            send({ type: 'start', seed });
            startGame(seed);
        };
    }

    // --- PeerJS Logic (4-Digit Code) ---
    function setupHost() {
        // Generate 4 digit code
        gameCode = Math.floor(1000 + Math.random() * 9000).toString();
        const fullId = PEER_PREFIX + gameCode;
        
        document.getElementById('main-menu-state').classList.add('hidden');
        document.getElementById('lobby-state').classList.remove('hidden');
        document.getElementById('display-code').innerText = gameCode;
        
        localPlayer.name = document.getElementById('player-name').value || "HOST";
        document.getElementById('p1-lobby-name').innerText = localPlayer.name;

        isHost = true;
        localPlayer.team = 'blue';
        remotePlayer.team = 'red';

        peer = new Peer(fullId);
        peer.on('open', (id) => console.log('Host Ready:', id));
        peer.on('connection', (c) => {
            if(conn) { c.close(); return; } // Only 1 player
            conn = c;
            setupConnection();
        });
        peer.on('error', (err) => {
            alert("Connection Error (ID might be taken, try again): " + err);
            location.reload();
        });
    }

    function joinGame() {
        const code = document.getElementById('game-code-input').value;
        if(code.length !== 4) return alert("Enter 4-digit code");
        
        const fullId = PEER_PREFIX + code;
        
        localPlayer.name = document.getElementById('player-name').value || "CLIENT";
        localPlayer.team = 'red';
        remotePlayer.team = 'blue';

        peer = new Peer(); // Random ephemeral ID for client
        peer.on('open', () => {
            conn = peer.connect(fullId);
            setupConnection();
        });
        peer.on('error', (err) => alert("Could not connect: " + err));
    }

    function setupConnection() {
        document.getElementById('main-menu-state').classList.add('hidden');
        document.getElementById('lobby-state').classList.remove('hidden');
        
        conn.on('open', () => {
            console.log("Connected");
            send({ type: 'lobby_update', name: localPlayer.name, gun: localPlayer.gun });
        });

        conn.on('data', (data) => {
            if(data.type === 'lobby_update') {
                remotePlayer.name = data.name;
                remotePlayer.gun = data.gun;
                document.getElementById('p2-lobby-name').innerText = data.name;
                if(isHost) {
                    const btn = document.getElementById('btn-launch');
                    btn.innerText = "LAUNCH MISSION";
                    btn.disabled = false;
                    btn.classList.replace('bg-gray-700', 'bg-green-600');
                    btn.classList.replace('text-gray-400', 'text-white');
                    btn.classList.replace('cursor-not-allowed', 'cursor-pointer');
                    btn.classList.add('hover:bg-green-500');
                } else {
                    document.getElementById('btn-launch').innerText = "WAITING FOR HOST...";
                }
            } else if(data.type === 'start') {
                startGame(data.seed);
            } else if(data.type === 'update') {
                handleGameUpdate(data);
            } else if(data.type === 'event') {
                handleGameEvent(data);
            }
        });
        
        conn.on('close', () => {
            alert("Connection Lost");
            location.reload();
        });
    }

    function send(data) {
        if(conn && conn.open) conn.send(data);
    }

    // --- Game Logic ---
    function generateMap(seed) {
        // Procedural Generation based on seed (mock)
        walls = [];
        // Borders
        walls.push({ x: -100, y: -100, w: MAP_W+200, h: 100 }); // Top
        walls.push({ x: -100, y: MAP_H, w: MAP_W+200, h: 100 }); // Bottom
        walls.push({ x: -100, y: 0, w: 100, h: MAP_H }); // Left
        walls.push({ x: MAP_W, y: 0, w: 100, h: MAP_H }); // Right

        // Center Structure
        walls.push({ x: MAP_W/2 - 50, y: MAP_H/2 - 200, w: 100, h: 400 });
        
        // Flank Covers
        walls.push({ x: 500, y: 400, w: 200, h: 50 });
        walls.push({ x: 500, y: 400, w: 50, h: 200 });
        
        walls.push({ x: MAP_W-700, y: MAP_H-600, w: 200, h: 50 });
        walls.push({ x: MAP_W-550, y: MAP_H-600, w: 50, h: 200 });

        // Random Scatter
        const r = (n) => {
            const x = Math.sin(seed * n) * 10000;
            return x - Math.floor(x);
        };
        
        for(let i=0; i<12; i++) {
            walls.push({
                x: 200 + r(i) * (MAP_W-400),
                y: 200 + r(i+1) * (MAP_H-400),
                w: 60 + r(i+2)*100,
                h: 60 + r(i+3)*100
            });
        }

        // Towers
        towers.blue = { x: 250, y: MAP_H/2, hp: TOWER_MAX_HP, color: COLORS.blue };
        towers.red = { x: MAP_W - 250, y: MAP_H/2, hp: TOWER_MAX_HP, color: COLORS.red };
    }

    function startGame(seed) {
        generateMap(seed);
        
        // Spawns
        if(isHost) {
            localPlayer.x = 350; localPlayer.y = MAP_H/2;
            remotePlayer.x = MAP_W - 350; remotePlayer.y = MAP_H/2;
        } else {
            localPlayer.x = MAP_W - 350; localPlayer.y = MAP_H/2;
            remotePlayer.x = 350; remotePlayer.y = MAP_H/2;
        }
        localPlayer.destX = localPlayer.x;
        localPlayer.destY = localPlayer.y;

        document.getElementById('menu-screen').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('hud-name').innerText = localPlayer.name;
        document.getElementById('hud-gun').innerText = GUNS[localPlayer.gun].name;

        gameActive = true;
        lastTime = performance.now();
        requestAnimationFrame(gameLoop);
        
        // Network Sync Loop (20Hz)
        setInterval(() => {
            if(!gameActive) return;
            send({
                type: 'update',
                x: Math.round(localPlayer.x),
                y: Math.round(localPlayer.y),
                a: parseFloat(localPlayer.angle.toFixed(2)),
                hp: localPlayer.hp,
                m: localPlayer.moving
            });
        }, 50);
    }

    // --- Core Loop ---
    function gameLoop(now) {
        if(!gameActive) return;
        const dt = (now - lastTime) / 1000;
        lastTime = now;

        update(dt);
        draw();
        requestAnimationFrame(gameLoop);
    }

    function update(dt) {
        // 1. Movement
        const dx = localPlayer.destX - localPlayer.x;
        const dy = localPlayer.destY - localPlayer.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        
        if(dist > 5) {
            localPlayer.x += (dx/dist) * 250 * dt; // Speed
            localPlayer.y += (dy/dist) * 250 * dt;
            localPlayer.moving = true;
        } else {
            localPlayer.moving = false;
        }
        
        localPlayer.angle = Math.atan2(mouse.worldY - localPlayer.y, mouse.worldX - localPlayer.x);

        // Remote Interpolation
        remotePlayer.x += (remotePlayer.targetX - remotePlayer.x) * 10 * dt;
        remotePlayer.y += (remotePlayer.targetY - remotePlayer.y) * 10 * dt;

        // 2. Camera (Smooth + Lookahead + Shake)
        const targetCamX = localPlayer.x - CANVAS.width/2 + (Math.cos(localPlayer.angle) * 150);
        const targetCamY = localPlayer.y - CANVAS.height/2 + (Math.sin(localPlayer.angle) * 150);
        
        camera.x += (targetCamX - camera.x) * 5 * dt;
        camera.y += (targetCamY - camera.y) * 5 * dt;
        
        if(camera.shake > 0) {
            camera.x += (Math.random()-0.5) * camera.shake;
            camera.y += (Math.random()-0.5) * camera.shake;
            camera.shake *= 0.9;
            if(camera.shake < 0.5) camera.shake = 0;
        }

        // Clamp Camera
        camera.x = Math.max(-100, Math.min(camera.x, MAP_W - CANVAS.width + 100));
        camera.y = Math.max(-100, Math.min(camera.y, MAP_H - CANVAS.height + 100));

        // 3. Bullets
        for(let i=bullets.length-1; i>=0; i--) {
            let b = bullets[i];
            b.x += b.vx * dt * 60; // Normalize speed
            b.y += b.vy * dt * 60;
            b.dist += Math.hypot(b.vx, b.vy) * dt * 60;

            if(b.dist > b.range) { bullets.splice(i,1); continue; }

            // Wall Hit
            let hit = false;
            for(let w of walls) {
                if(b.x > w.x && b.x < w.x+w.w && b.y > w.y && b.y < w.y+w.h) {
                    hit = true;
                    // Spark Particles
                    spawnParticles(b.x, b.y, 5, '#ffffaa', 2);
                    break;
                }
            }
            if(hit) { bullets.splice(i,1); continue; }

            // Player Hit (Check Local Logic Only)
            // If I shot, I check if I hit enemy
            if(b.owner === localPlayer.team) {
                // Hit Enemy
                if(Math.hypot(b.x - remotePlayer.x, b.y - remotePlayer.y) < 25) {
                    spawnBlood(b.x, b.y);
                    spawnDamageNumber(b.x, b.y, b.dmg);
                    send({ type: 'event', kind: 'hit_player', dmg: b.dmg });
                    bullets.splice(i,1);
                    continue;
                }
                // Hit Tower
                const targetTower = localPlayer.team === 'blue' ? towers.red : towers.blue;
                if(targetTower.hp > 0 && Math.hypot(b.x - targetTower.x, b.y - targetTower.y) < 50) {
                    spawnParticles(b.x, b.y, 8, '#f59e0b', 3);
                    send({ type: 'event', kind: 'hit_tower', dmg: b.dmg, team: localPlayer.team === 'blue' ? 'red' : 'blue' });
                    bullets.splice(i,1);
                    continue;
                }
            }
        }

        // 4. Tower Logic (Simple AI)
        // Check if I am near enemy tower
        const enemyTower = localPlayer.team === 'blue' ? towers.red : towers.blue;
        if(enemyTower.hp > 0) {
            const d = Math.hypot(localPlayer.x - enemyTower.x, localPlayer.y - enemyTower.y);
            if(d < TOWER_RANGE) {
                if(Date.now() - (enemyTower.lastFire || 0) > 1500) {
                    enemyTower.lastFire = Date.now();
                    // Tower Shoots Me
                    const a = Math.atan2(localPlayer.y - enemyTower.y, localPlayer.x - enemyTower.x);
                    bullets.push({
                        x: enemyTower.x, y: enemyTower.y,
                        vx: Math.cos(a) * 15, vy: Math.sin(a) * 15,
                        owner: 'tower', range: 1000, dmg: 100, color: '#fff', size: 6
                    });
                    // Visual Muzzle flash on tower
                    spawnParticles(enemyTower.x, enemyTower.y, 20, '#ffaa00', 5);
                }
            }
        }

        // 5. Particles & Numbers
        updateParticles(dt);
        
        // HUD
        document.getElementById('blue-bar').style.width = (towers.blue.hp/TOWER_MAX_HP*100) + '%';
        document.getElementById('blue-hp-text').innerText = Math.max(0, towers.blue.hp);
        document.getElementById('red-bar').style.width = (towers.red.hp/TOWER_MAX_HP*100) + '%';
        document.getElementById('red-hp-text').innerText = Math.max(0, towers.red.hp);
        document.getElementById('hud-hp-bar').style.width = (localPlayer.hp/PLAYER_MAX_HP*100) + '%';
        
        if((towers.blue.hp <= 0 || towers.red.hp <= 0) && gameActive) endGame();
        if(localPlayer.hp <= 0 && gameActive) { 
            document.body.style.filter = "grayscale(1)"; // Dead effect
        }
    }

    // --- Networking Handlers ---
    function handleGameUpdate(d) {
        remotePlayer.targetX = d.x;
        remotePlayer.targetY = d.y;
        remotePlayer.angle = d.a;
        remotePlayer.hp = d.hp;
        remotePlayer.moving = d.m;
    }

    function handleGameEvent(d) {
        if(d.kind === 'shot') {
            const gun = GUNS[d.gun];
            // Spawn remote bullet
            bullets.push({
                x: remotePlayer.x + Math.cos(d.a)*30, 
                y: remotePlayer.y + Math.sin(d.a)*30,
                vx: Math.cos(d.a + (Math.random()-0.5)*gun.spread) * gun.speed,
                vy: Math.sin(d.a + (Math.random()-0.5)*gun.spread) * gun.speed,
                owner: remotePlayer.team,
                range: gun.range * 20, // rough conversion
                dmg: gun.dmg,
                color: gun.color,
                size: 3
            });
            spawnParticles(remotePlayer.x + Math.cos(d.a)*30, remotePlayer.y + Math.sin(d.a)*30, 5, '#ffff00', 2);
        } else if(d.kind === 'hit_player') {
            localPlayer.hp -= d.dmg;
            camera.shake = 10;
        } else if(d.kind === 'hit_tower') {
            towers[d.team].hp -= d.dmg;
            spawnDamageNumber(towers[d.team].x, towers[d.team].y, d.dmg);
        }
    }

    // --- Rendering (The 1000x Polish) ---
    function draw() {
        // Clear
        CTX.fillStyle = COLORS.bg;
        CTX.fillRect(0,0, CANVAS.width, CANVAS.height);

        CTX.save();
        CTX.translate(-Math.floor(camera.x), -Math.floor(camera.y));

        // 1. Floor Pattern (Grid + Noise)
        CTX.fillStyle = COLORS.grid;
        CTX.lineWidth = 2;
        CTX.beginPath();
        for(let x=0; x<MAP_W; x+=100) { CTX.moveTo(x,0); CTX.lineTo(x, MAP_H); }
        for(let y=0; y<MAP_H; y+=100) { CTX.moveTo(0,y); CTX.lineTo(MAP_W, y); }
        CTX.strokeStyle = '#1e1e24';
        CTX.stroke();

        // 2. Decals (Blood/Scorch) - Drawn underneath everything
        decals.forEach(d => {
            CTX.globalAlpha = d.alpha;
            CTX.fillStyle = d.color;
            CTX.beginPath();
            CTX.arc(d.x, d.y, d.size, 0, Math.PI*2);
            CTX.fill();
        });
        CTX.globalAlpha = 1;

        // 3. Walls (Faux 3D)
        walls.forEach(w => {
            // Side Face (Darker)
            CTX.fillStyle = COLORS.wallSide;
            CTX.fillRect(w.x, w.y + w.h, w.w, 30); // 30px height simulation

            // Top Face
            CTX.fillStyle = COLORS.wallTop;
            CTX.fillRect(w.x, w.y, w.w, w.h);
            
            // Highlight Edge
            CTX.fillStyle = 'rgba(255,255,255,0.05)';
            CTX.fillRect(w.x, w.y, w.w, 4);
        });

        // 4. Towers
        drawTower(towers.blue, 'blue');
        drawTower(towers.red, 'red');

        // 5. Players
        drawPlayer(localPlayer);
        drawPlayer(remotePlayer);

        // 6. Bullets (Glowing)
        CTX.shadowBlur = 10;
        bullets.forEach(b => {
            CTX.shadowColor = b.color;
            CTX.fillStyle = b.color;
            CTX.beginPath();
            CTX.arc(b.x, b.y, b.size || 3, 0, Math.PI*2);
            CTX.fill();
        });
        CTX.shadowBlur = 0;

        // 7. Particles
        particles.forEach(p => {
            CTX.fillStyle = p.color;
            CTX.globalAlpha = p.life;
            CTX.beginPath();
            CTX.arc(p.x, p.y, p.size, 0, Math.PI*2);
            CTX.fill();
        });
        CTX.globalAlpha = 1;

        // 8. Damage Numbers
        CTX.font = "bold 20px 'Inter'";
        CTX.textAlign = "center";
        damageNumbers.forEach(n => {
            CTX.fillStyle = `rgba(255, 255, 255, ${n.life})`;
            CTX.fillText(n.val, n.x, n.y - (1-n.life)*30);
        });

        // 9. Lighting / Fog of War (Simple Vignette)
        // CTX.globalCompositeOperation = 'multiply';
        // But for performance in canvas, simple radial overlay is better
        // Let's skip heavy lighting for fps, just subtle vignette
        CTX.restore();
    }

    function drawTower(t, color) {
        const c = t.color;
        // Base
        CTX.fillStyle = '#27272a';
        CTX.beginPath(); CTX.arc(t.x, t.y, 60, 0, Math.PI*2); CTX.fill();
        // Core
        CTX.shadowColor = c;
        CTX.shadowBlur = 30;
        CTX.fillStyle = c;
        CTX.beginPath(); CTX.arc(t.x, t.y, 30, 0, Math.PI*2); CTX.fill();
        CTX.shadowBlur = 0;
        
        // Ring
        CTX.strokeStyle = 'rgba(255,255,255,0.2)';
        CTX.lineWidth = 3;
        CTX.beginPath(); CTX.arc(t.x, t.y, 45, 0, Math.PI*2); CTX.stroke();
    }

    function drawPlayer(p) {
        if(p.hp <= 0) return;
        CTX.save();
        CTX.translate(p.x, p.y);
        CTX.rotate(p.angle);

        // Feet (Animate)
        if(p.moving) {
            const shift = Math.sin(Date.now()/100) * 8;
            CTX.fillStyle = '#000';
            CTX.beginPath(); CTX.arc(5, 10+shift, 6, 0, Math.PI*2); CTX.fill();
            CTX.beginPath(); CTX.arc(5, -10-shift, 6, 0, Math.PI*2); CTX.fill();
        }

        // Body
        CTX.fillStyle = p.team === 'blue' ? '#1e40af' : '#991b1b'; // Vest
        CTX.beginPath(); CTX.roundRect(-15, -12, 25, 24, 5); CTX.fill();

        // Head
        CTX.fillStyle = p.team === 'blue' ? '#60a5fa' : '#f87171'; // Helmet
        CTX.beginPath(); CTX.arc(0, 0, 11, 0, Math.PI*2); CTX.fill();

        // Arms & Gun
        CTX.fillStyle = '#18181b'; // Arms
        CTX.beginPath(); CTX.arc(10, 8, 5, 0, Math.PI*2); CTX.fill(); // Right Hand
        CTX.beginPath(); CTX.arc(15, -5, 5, 0, Math.PI*2); CTX.fill(); // Left Hand
        
        // Gun
        CTX.fillStyle = '#000';
        CTX.fillRect(10, 4, GUNS[p.gun].length || 30, 6);

        CTX.restore();

        // Nameplate
        CTX.fillStyle = 'rgba(0,0,0,0.5)';
        CTX.fillRect(p.x-30, p.y-50, 60, 16);
        CTX.fillStyle = '#fff';
        CTX.font = 'bold 10px Inter';
        CTX.textAlign = 'center';
        CTX.fillText(p.name, p.x, p.y-38);
        // HP Line
        CTX.fillStyle = '#22c55e';
        CTX.fillRect(p.x-30, p.y-34, 60 * (p.hp/PLAYER_MAX_HP), 3);
    }

    // --- Inputs ---
    window.addEventListener('mousedown', (e) => {
        if(gameActive && localPlayer.hp > 0 && e.button === 0) tryShoot();
    });
    
    window.addEventListener('mousemove', (e) => {
        const r = CANVAS.getBoundingClientRect();
        mouse.x = e.clientX - r.left;
        mouse.y = e.clientY - r.top;
        mouse.worldX = mouse.x + camera.x;
        mouse.worldY = mouse.y + camera.y;
    });

    window.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        localPlayer.destX = mouse.worldX;
        localPlayer.destY = mouse.worldY;
        // Marker
        particles.push({x: mouse.worldX, y: mouse.worldY, vx:0, vy:0, life:1, size:10, color:'#22c55e'});
    });

    function tryShoot() {
        const gun = GUNS[localPlayer.gun];
        // Rate limit logic needed (omitted for brevity, assume click spam for now or add cooldown)
        if(Date.now() - (localPlayer.lastShot || 0) < 60000/gun.rate) return;
        localPlayer.lastShot = Date.now();

        // Bullet Logic
        const spread = (Math.random()-0.5) * gun.spread;
        const angle = localPlayer.angle + spread;
        
        bullets.push({
            x: localPlayer.x + Math.cos(localPlayer.angle)*30,
            y: localPlayer.y + Math.sin(localPlayer.angle)*30,
            vx: Math.cos(angle) * gun.speed,
            vy: Math.sin(angle) * gun.speed,
            range: gun.range * 20, // rough conversion
            dmg: gun.dmg,
            color: gun.color,
            owner: localPlayer.team
        });

        camera.shake = 5;
        // Shell Casing Particle
        const shellAngle = localPlayer.angle + Math.PI/2;
        particles.push({
            x: localPlayer.x, y: localPlayer.y,
            vx: Math.cos(shellAngle)*5, vy: Math.sin(shellAngle)*5,
            life: 0.5, size: 2, color: '#fbbf24', decay: 0.02
        });
        
        // Muzzle Flash
        spawnParticles(localPlayer.x + Math.cos(localPlayer.angle)*40, localPlayer.y + Math.sin(localPlayer.angle)*40, 3, '#fff', 3);

        send({ type: 'event', kind: 'shot', gun: localPlayer.gun, a: angle });
    }

    // --- Particle System ---
    function spawnParticles(x, y, count, color, speed) {
        for(let i=0; i<count; i++) {
            particles.push({
                x: x, y: y,
                vx: (Math.random()-0.5) * 10 * speed,
                vy: (Math.random()-0.5) * 10 * speed,
                life: 1.0,
                color: color,
                size: Math.random() * 3,
                decay: 0.05 + Math.random()*0.05
            });
        }
    }

    function spawnBlood(x, y) {
        // Active particles
        spawnParticles(x, y, 10, '#dc2626', 1);
        // Permanent Decal
        decals.push({
            x: x + (Math.random()-0.5)*20,
            y: y + (Math.random()-0.5)*20,
            size: 5 + Math.random()*10,
            color: '#7f1d1d',
            alpha: 0.8
        });
        if(decals.length > 50) decals.shift();
    }

    function spawnDamageNumber(x, y, val) {
        damageNumbers.push({ x, y, val, life: 1.0 });
    }

    function updateParticles(dt) {
        // Sparks/Smoke
        for(let i=particles.length-1; i>=0; i--) {
            let p = particles[i];
            p.x += p.vx; p.y += p.vy;
            p.life -= p.decay;
            if(p.life <= 0) particles.splice(i,1);
        }
        // Damage Numbers
        for(let i=damageNumbers.length-1; i>=0; i--) {
            let n = damageNumbers[i];
            n.y -= 1; // float up
            n.life -= 0.02;
            if(n.life <= 0) damageNumbers.splice(i,1);
        }
    }

    function resize() {
        CANVAS.width = window.innerWidth;
        CANVAS.height = window.innerHeight;
    }

    function endGame() {
        gameActive = false;
        document.getElementById('end-screen').classList.remove('hidden');
        const won = (localPlayer.team === 'blue' && towers.red.hp <= 0) || (localPlayer.team === 'red' && towers.blue.hp <= 0);
        document.getElementById('end-title').innerText = won ? "VICTORY" : "DEFEAT";
        document.getElementById('end-title').className = won ? "text-8xl font-black italic tracking-tighter mb-2 text-green-500" : "text-8xl font-black italic tracking-tighter mb-2 text-red-500";
    }

    init();
</script>
</body>
</html>
