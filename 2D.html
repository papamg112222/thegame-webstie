<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Warfare: Peer-to-Peer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <!-- PeerJS for Serverless Multiplayer -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Inter:wght@400;600;800&display=swap');

        body { margin: 0; overflow: hidden; background-color: #050a05; font-family: 'Inter', sans-serif; user-select: none; color: white; }
        canvas { display: block; background-color: #0f180f; cursor: crosshair; }
        
        /* UI Layer */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .pointer-events-auto { pointer-events: auto; }
        
        /* Glassmorphism Panels */
        .glass-panel {
            background: rgba(10, 15, 10, 0.9);
            border: 1px solid rgba(100, 255, 100, 0.1);
            backdrop-filter: blur(12px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #15803d 0%, #166534 100%);
            box-shadow: 0 4px 15px rgba(22, 101, 52, 0.4);
            transition: all 0.2s;
            border: 1px solid #4ade80;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(22, 101, 52, 0.6); }
        .btn-primary:active { transform: translateY(1px); }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.1); }

        /* HUD Bars */
        .health-bar-container {
            width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; overflow: hidden; margin-top: 6px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.8);
        }
        .health-bar-fill { height: 100%; transition: width 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        /* Animations */
        @keyframes pulse-scan {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .status-dot { animation: pulse-scan 2s infinite; }

        input::placeholder { color: #555; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- Menu UI -->
<div id="menu-screen" class="absolute inset-0 flex items-center justify-center z-50 bg-black bg-opacity-90">
    <!-- Background Grid Effect -->
    <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#3f3 1px, transparent 1px); background-size: 30px 30px;"></div>

    <div class="glass-panel p-10 rounded-2xl max-w-md w-full text-center relative z-10 border-t border-gray-700">
        <div class="mb-8">
            <h1 class="text-5xl font-black mb-1 tracking-tighter italic bg-clip-text text-transparent bg-gradient-to-r from-green-500 to-emerald-200">TACTICAL<span class="text-gray-500">WARFARE</span></h1>
            <p class="text-gray-400 text-xs tracking-widest uppercase font-bold">Combat Simulation</p>
        </div>

        <div id="main-menu-state">
            <div class="space-y-4">
                <input type="text" id="player-name" placeholder="OPERATIVE NAME" class="w-full bg-gray-900 border border-gray-700 text-white px-4 py-4 rounded-lg font-bold text-center focus:outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500 transition placeholder-gray-600 uppercase tracking-wider">
                
                <div class="grid grid-cols-2 gap-4">
                    <button id="btn-create-mode" class="btn-primary py-4 rounded-xl font-bold text-sm tracking-wide flex flex-col items-center justify-center gap-1">
                        <i class="fas fa-server text-xl"></i> HOST OP
                    </button>
                    <button id="btn-join-mode" class="btn-secondary py-4 rounded-xl font-bold text-sm tracking-wide flex flex-col items-center justify-center gap-1 text-gray-300">
                        <i class="fas fa-satellite-dish text-xl"></i> JOIN OP
                    </button>
                </div>
            </div>
            
            <!-- Join Input Slide-down -->
            <div id="join-input-area" class="hidden mt-4 pt-4 border-t border-gray-700">
                <p class="text-xs text-left text-gray-500 mb-2 font-bold uppercase">Enter 4-Digit Access Code</p>
                <div class="flex gap-2">
                    <input type="text" id="game-code-input" placeholder="0000" maxlength="4" class="flex-1 bg-black border border-gray-600 px-4 py-3 rounded-lg text-white font-mono text-2xl text-center tracking-[0.5em] focus:outline-none focus:border-green-500 focus:text-green-400 transition">
                    <button id="btn-connect" class="bg-green-600 hover:bg-green-500 text-white px-6 rounded-lg font-bold transition"><i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
        </div>

        <!-- Lobby State -->
        <div id="lobby-state" class="hidden text-left">
            <div class="bg-gray-900 p-6 rounded-xl mb-6 border border-gray-800 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fas fa-fingerprint text-6xl"></i></div>
                <p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-1">Mission Access Code</p>
                <div class="flex items-baseline gap-4">
                    <span id="display-code" class="text-5xl font-mono font-bold text-green-400 tracking-widest drop-shadow-lg">....</span>
                    <span class="text-xs text-gray-500 animate-pulse">WAITING FOR UPLINK</span>
                </div>
            </div>

            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3">Select Weapon System</h3>
            <div class="grid grid-cols-3 gap-3 mb-8">
                <button class="loadout-btn relative overflow-hidden bg-gray-800 p-3 rounded-lg border border-gray-700 hover:border-gray-500 transition group" data-gun="glock">
                    <div class="absolute inset-0 bg-yellow-500 opacity-0 group-hover:opacity-5 transition"></div>
                    <div class="font-bold text-sm text-yellow-400">SIDEARM</div>
                    <div class="text-[10px] text-gray-400 mt-1">High Mobility</div>
                </button>
                <button class="loadout-btn relative overflow-hidden bg-gray-800 p-3 rounded-lg border-2 border-green-500 shadow-[0_0_15px_rgba(59,130,246,0.3)] transition group" data-gun="ar">
                    <div class="absolute inset-0 bg-green-500 opacity-0 group-hover:opacity-5 transition"></div>
                    <div class="font-bold text-sm text-green-400">RIFLE</div>
                    <div class="text-[10px] text-gray-400 mt-1">Balanced</div>
                </button>
                <button class="loadout-btn relative overflow-hidden bg-gray-800 p-3 rounded-lg border border-gray-700 hover:border-gray-500 transition group" data-gun="sniper">
                    <div class="absolute inset-0 bg-red-500 opacity-0 group-hover:opacity-5 transition"></div>
                    <div class="font-bold text-sm text-red-400">HEAVY</div>
                    <div class="text-[10px] text-gray-400 mt-1">Long Range</div>
                </button>
            </div>

            <div class="space-y-2 mb-6 text-sm font-mono">
                <div class="flex justify-between items-center p-2 bg-gray-800 rounded">
                    <span class="text-gray-400">HOST</span>
                    <span id="p1-lobby-name" class="font-bold text-white">...</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-gray-800 rounded">
                    <span class="text-gray-400">CLIENT</span>
                    <span id="p2-lobby-name" class="font-bold text-gray-500">SEARCHING...</span>
                </div>
            </div>

            <button id="btn-launch" class="w-full bg-gray-700 text-gray-400 py-4 rounded-xl font-bold text-lg tracking-widest transition cursor-not-allowed" disabled>AWAITING CONNECTION</button>
        </div>
    </div>
</div>

<!-- HUD -->
<div id="hud" class="hidden pointer-events-none absolute inset-0 p-6 flex flex-col justify-between">
    <!-- Top Bar -->
    <div class="flex justify-between items-start w-full">
        <!-- Blue Team (Left) -->
        <div class="glass-panel px-4 py-3 rounded-br-2xl border-l-4 border-blue-600 w-80 pointer-events-auto transform skew-x-[-10deg] origin-top-left">
            <div class="transform skew-x-[10deg]">
                <div class="flex justify-between text-xs font-bold tracking-widest mb-2">
                    <span class="text-blue-400">ALPHA TOWER</span>
                    <span id="blue-hp-text" class="text-white">1000</span>
                </div>
                <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                    <div id="blue-bar" class="h-full bg-blue-500 shadow-[0_0_10px_#3b82f6]" style="width: 100%"></div>
                </div>
            </div>
        </div>

        <!-- Timer/Score -->
        <div class="glass-panel px-8 py-2 rounded-b-xl border-t-0 border-white/10 text-center">
            <div class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Operation Time</div>
            <span id="game-timer" class="font-mono text-3xl font-bold tracking-widest text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">03:00</span>
        </div>

        <!-- Red Team (Right) -->
        <div class="glass-panel px-4 py-3 rounded-bl-2xl border-r-4 border-red-600 w-80 pointer-events-auto transform skew-x-[10deg] origin-top-right">
            <div class="transform skew-x-[-10deg]">
                <div class="flex justify-between text-xs font-bold tracking-widest mb-2">
                    <span id="red-hp-text" class="text-white">1000</span>
                    <span class="text-red-400">BRAVO TOWER</span>
                </div>
                <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden flex justify-end">
                    <div id="red-bar" class="h-full bg-red-500 shadow-[0_0_10px_#ef4444]" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Info -->
    <div class="flex items-end justify-between">
        <!-- Player Stats -->
        <div class="glass-panel p-5 rounded-tr-3xl border-l-4 border-emerald-500 pointer-events-auto min-w-[300px]">
            <div class="flex items-center gap-5">
                <div class="w-16 h-16 bg-gray-800 rounded-lg border border-gray-600 flex items-center justify-center relative overflow-hidden">
                    <i class="fas fa-user-shield text-3xl text-emerald-500"></i>
                    <div class="absolute inset-0 bg-gradient-to-t from-emerald-500/20 to-transparent"></div>
                </div>
                <div class="flex-1">
                    <h2 id="hud-name" class="font-black text-2xl uppercase italic leading-none mb-1">OPERATOR</h2>
                    <div class="text-xs text-emerald-400 font-bold tracking-widest mb-2" id="hud-gun">ASSAULT RIFLE</div>
                    <div class="w-full h-3 bg-gray-800 rounded-sm overflow-hidden relative">
                        <div class="absolute inset-0 bg-repeat-x opacity-20" style="background-image: linear-gradient(90deg, transparent 50%, rgba(0,0,0,0.5) 50%); background-size: 10px 100%;"></div>
                        <div id="hud-hp-bar" class="h-full bg-emerald-500" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="text-right opacity-60 text-[10px] font-mono space-y-1">
            <div><span class="bg-gray-700 px-1 rounded text-white font-bold">R-CLICK</span> MOVE</div>
            <div><span class="bg-gray-700 px-1 rounded text-white font-bold">L-CLICK</span> FIRE</div>
        </div>
    </div>
</div>

<!-- Game Over Overlay -->
<div id="end-screen" class="hidden absolute inset-0 bg-black/90 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="text-center">
        <h1 id="end-title" class="text-8xl font-black italic tracking-tighter mb-2 drop-shadow-[0_0_30px_rgba(255,255,255,0.2)]">VICTORY</h1>
        <div class="h-1 w-32 bg-white mx-auto mb-6"></div>
        <p id="end-reason" class="text-gray-400 font-mono tracking-widest text-sm mb-8">TARGET DESTROYED</p>
        <button onclick="location.reload()" class="bg-white text-black font-bold py-3 px-8 rounded-full hover:scale-105 transition">RTB (RELOAD)</button>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    // --- Configuration ---
    const PEER_PREFIX = "tactical-warfare-v1-"; 
    const CANVAS = document.getElementById('gameCanvas');
    const CTX = CANVAS.getContext('2d');
    
    // Core Game Config
    const MAP_W = 2500;
    const MAP_H = 1800;
    const TOWER_MAX_HP = 1500;
    const PLAYER_MAX_HP = 500;
    const GAME_DURATION = 180; 

    // --- Asset Generation ---
    const COLORS = {
        bg: '#0a1a0a',
        grassDark: '#0f220f',
        grassLight: '#142a14',
        blue: '#2563eb',
        red: '#dc2626',
        wallTop: '#403d39',
        wallSide: '#252422',
    };

    const GUNS = {
        glock: { name: 'GLOCK 19', dmg: 45, rate: 350, speed: 22, spread: 0.08, color: '#d4d4d8', length: 14, width: 4 },
        ar: { name: 'M4A1 CARBINE', dmg: 32, rate: 90, speed: 28, spread: 0.12, color: '#71717a', length: 28, width: 4 },
        sniper: { name: 'AWP .338', dmg: 250, rate: 1400, speed: 45, spread: 0.005, color: '#52525b', length: 42, width: 5 }
    };

    // --- State ---
    let myPeerId = null;
    let peer = null;
    let conn = null;
    let isHost = false;
    let gameActive = false;
    let lastTime = 0;
    let gameCode = "";
    let timeLeft = GAME_DURATION;

    // Entities
    let localPlayer = { x: 0, y: 0, destX: 0, destY: 0, angle: 0, hp: PLAYER_MAX_HP, gun: 'ar', team: 'blue', moving: false, name: 'You', recoil: 0 };
    let remotePlayer = { x: -500, y: -500, angle: 0, hp: PLAYER_MAX_HP, gun: 'ar', team: 'red', moving: false, name: 'Enemy', targetX: -500, targetY: -500, recoil: 0 };
    
    let bullets = [];
    let particles = [];
    let decals = [];
    let damageNumbers = [];
    let walls = [];
    let camera = { x: 0, y: 0, shake: 0 };
    let mouse = { x: 0, y: 0, worldX: 0, worldY: 0 };
    let towers = { blue: { x: 0, y: 0, hp: TOWER_MAX_HP }, red: { x: 0, y: 0, hp: TOWER_MAX_HP } };

    // --- Initialization & Menu ---
    function init() {
        resize();
        window.addEventListener('resize', resize);
        
        CTX.fillStyle = COLORS.bg;
        CTX.fillRect(0,0, CANVAS.width, CANVAS.height);

        document.getElementById('btn-create-mode').onclick = setupHost;
        document.getElementById('btn-join-mode').onclick = () => {
            document.getElementById('join-input-area').classList.remove('hidden');
            document.getElementById('game-code-input').focus();
        };
        document.getElementById('btn-connect').onclick = joinGame;
        
        document.querySelectorAll('.loadout-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.loadout-btn').forEach(b => {
                    b.style.borderColor = 'rgba(255,255,255,0.1)';
                    b.classList.remove('shadow-[0_0_15px_rgba(59,130,246,0.3)]');
                });
                btn.style.borderColor = '#4ade80';
                btn.classList.add('shadow-[0_0_15px_rgba(74,222,128,0.3)]');
                localPlayer.gun = btn.dataset.gun;
                if(conn) send({ type: 'lobby_update', name: localPlayer.name, gun: localPlayer.gun });
            };
        });

        document.getElementById('btn-launch').onclick = () => {
            const seed = Date.now();
            send({ type: 'start', seed });
            startGame(seed);
        };
    }

    // --- PeerJS Logic ---
    function setupHost() {
        gameCode = Math.floor(1000 + Math.random() * 9000).toString();
        const fullId = PEER_PREFIX + gameCode;
        
        document.getElementById('main-menu-state').classList.add('hidden');
        document.getElementById('lobby-state').classList.remove('hidden');
        document.getElementById('display-code').innerText = gameCode;
        
        localPlayer.name = document.getElementById('player-name').value || "HOST";
        document.getElementById('p1-lobby-name').innerText = localPlayer.name;

        isHost = true;
        localPlayer.team = 'blue';
        remotePlayer.team = 'red';

        peer = new Peer(fullId);
        peer.on('open', (id) => console.log('Host Ready:', id));
        peer.on('connection', (c) => {
            if(conn) { c.close(); return; }
            conn = c;
            setupConnection();
        });
        peer.on('error', (err) => {
            alert("Connection Error: " + err);
            location.reload();
        });
    }

    function joinGame() {
        const code = document.getElementById('game-code-input').value;
        if(code.length !== 4) return alert("Enter 4-digit code");
        const fullId = PEER_PREFIX + code;
        
        localPlayer.name = document.getElementById('player-name').value || "CLIENT";
        localPlayer.team = 'red';
        remotePlayer.team = 'blue';

        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(fullId);
            setupConnection();
        });
        peer.on('error', (err) => alert("Could not connect: " + err));
    }

    function setupConnection() {
        document.getElementById('main-menu-state').classList.add('hidden');
        document.getElementById('lobby-state').classList.remove('hidden');
        
        conn.on('open', () => {
            console.log("Connected");
            send({ type: 'lobby_update', name: localPlayer.name, gun: localPlayer.gun });
        });

        conn.on('data', (data) => {
            if(data.type === 'lobby_update') {
                remotePlayer.name = data.name;
                remotePlayer.gun = data.gun;
                document.getElementById('p2-lobby-name').innerText = data.name;
                if(isHost) {
                    const btn = document.getElementById('btn-launch');
                    btn.innerText = "LAUNCH MISSION";
                    btn.disabled = false;
                    btn.classList.replace('bg-gray-700', 'bg-green-600');
                    btn.classList.replace('text-gray-400', 'text-white');
                    btn.classList.replace('cursor-not-allowed', 'cursor-pointer');
                    btn.classList.add('hover:bg-green-500');
                } else {
                    document.getElementById('btn-launch').innerText = "WAITING FOR HOST...";
                }
            } else if(data.type === 'start') {
                startGame(data.seed);
            } else if(data.type === 'update') {
                handleGameUpdate(data);
            } else if(data.type === 'event') {
                handleGameEvent(data);
            }
        });
        
        conn.on('close', () => {
            alert("Connection Lost");
            location.reload();
        });
    }

    function send(data) {
        if(conn && conn.open) conn.send(data);
    }

    // --- Game Logic ---
    function generateMap(seed) {
        walls = [];
        // Borders
        walls.push({ x: -100, y: -100, w: MAP_W+200, h: 100 });
        walls.push({ x: -100, y: MAP_H, w: MAP_W+200, h: 100 });
        walls.push({ x: -100, y: 0, w: 100, h: MAP_H });
        walls.push({ x: MAP_W, y: 0, w: 100, h: MAP_H });
        
        // Mid Structures (Sandbags/Concrete)
        walls.push({ x: MAP_W/2 - 60, y: MAP_H/2 - 250, w: 120, h: 500, type: 'bunker' }); // Center
        
        walls.push({ x: 400, y: 400, w: 200, h: 60, type: 'sandbag' });
        walls.push({ x: 400, y: 460, w: 60, h: 150, type: 'sandbag' });
        
        walls.push({ x: MAP_W-600, y: MAP_H-460, w: 200, h: 60, type: 'sandbag' });
        walls.push({ x: MAP_W-460, y: MAP_H-610, w: 60, h: 150, type: 'sandbag' });

        const r = (n) => {
            const x = Math.sin(seed * n) * 10000;
            return x - Math.floor(x);
        };
        for(let i=0; i<15; i++) {
            walls.push({
                x: 200 + r(i) * (MAP_W-400),
                y: 200 + r(i+1) * (MAP_H-400),
                w: 80 + r(i+2)*80,
                h: 80 + r(i+3)*80,
                type: r(i+4) > 0.5 ? 'crate' : 'bunker'
            });
        }

        towers.blue = { x: 200, y: MAP_H/2, hp: TOWER_MAX_HP, color: '#3b82f6' };
        towers.red = { x: MAP_W - 200, y: MAP_H/2, hp: TOWER_MAX_HP, color: '#ef4444' };
    }

    function startGame(seed) {
        generateMap(seed);
        timeLeft = GAME_DURATION;
        
        if(isHost) {
            localPlayer.x = 300; localPlayer.y = MAP_H/2;
            remotePlayer.x = MAP_W - 300; remotePlayer.y = MAP_H/2;
        } else {
            localPlayer.x = MAP_W - 300; localPlayer.y = MAP_H/2;
            remotePlayer.x = 300; remotePlayer.y = MAP_H/2;
        }
        localPlayer.destX = localPlayer.x;
        localPlayer.destY = localPlayer.y;

        document.getElementById('menu-screen').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('hud-name').innerText = localPlayer.name;
        document.getElementById('hud-gun').innerText = GUNS[localPlayer.gun].name;

        gameActive = true;
        lastTime = performance.now();
        requestAnimationFrame(gameLoop);
        
        setInterval(() => {
            if(!gameActive) return;
            const payload = {
                type: 'update',
                x: Math.round(localPlayer.x),
                y: Math.round(localPlayer.y),
                a: parseFloat(localPlayer.angle.toFixed(2)),
                hp: localPlayer.hp,
                m: localPlayer.moving
            };
            if(isHost) payload.t = Math.ceil(timeLeft);
            send(payload);
        }, 50);
    }

    function gameLoop(now) {
        if(!gameActive) return;
        const dt = (now - lastTime) / 1000;
        lastTime = now;

        update(dt);
        draw();
        requestAnimationFrame(gameLoop);
    }

    function checkCollision(x, y, r) {
        for(let w of walls) {
            let testX = x;
            let testY = y;
            if (x < w.x) testX = w.x;
            else if (x > w.x + w.w) testX = w.x + w.w;
            if (y < w.y) testY = w.y;
            else if (y > w.y + w.h) testY = w.y + w.h;

            let distX = x - testX;
            let distY = y - testY;
            let distance = Math.sqrt((distX*distX) + (distY*distY));

            if (distance <= r) {
                return true;
            }
        }
        return false;
    }

    function update(dt) {
        if(isHost) {
            timeLeft -= dt;
            if(timeLeft <= 0) {
                timeLeft = 0;
                endGame('timeout');
            }
        }
        
        const m = Math.floor(timeLeft / 60);
        const s = Math.floor(timeLeft % 60);
        document.getElementById('game-timer').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

        // Movement with Collision
        const dx = localPlayer.destX - localPlayer.x;
        const dy = localPlayer.destY - localPlayer.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const speed = 250;
        
        if(dist > 5) {
            let moveStep = speed * dt;
            let nextX = localPlayer.x + (dx/dist) * moveStep;
            let nextY = localPlayer.y + (dy/dist) * moveStep;

            // Collision Check (Slide)
            if(!checkCollision(nextX, localPlayer.y, 16)) localPlayer.x = nextX;
            if(!checkCollision(localPlayer.x, nextY, 16)) localPlayer.y = nextY;
            
            localPlayer.moving = true;
        } else {
            localPlayer.moving = false;
        }
        
        localPlayer.angle = Math.atan2(mouse.worldY - localPlayer.y, mouse.worldX - localPlayer.x);
        if(localPlayer.recoil > 0) localPlayer.recoil *= 0.8;

        // Remote Interpolation
        remotePlayer.x += (remotePlayer.targetX - remotePlayer.x) * 10 * dt;
        remotePlayer.y += (remotePlayer.targetY - remotePlayer.y) * 10 * dt;
        if(remotePlayer.recoil > 0) remotePlayer.recoil *= 0.8;

        // Camera
        const targetCamX = localPlayer.x - CANVAS.width/2 + (Math.cos(localPlayer.angle) * 100);
        const targetCamY = localPlayer.y - CANVAS.height/2 + (Math.sin(localPlayer.angle) * 100);
        camera.x += (targetCamX - camera.x) * 5 * dt;
        camera.y += (targetCamY - camera.y) * 5 * dt;
        
        if(camera.shake > 0) {
            camera.x += (Math.random()-0.5) * camera.shake;
            camera.y += (Math.random()-0.5) * camera.shake;
            camera.shake *= 0.9;
        }
        camera.x = Math.max(-100, Math.min(camera.x, MAP_W - CANVAS.width + 100));
        camera.y = Math.max(-100, Math.min(camera.y, MAP_H - CANVAS.height + 100));

        // Bullets
        for(let i=bullets.length-1; i>=0; i--) {
            let b = bullets[i];
            b.x += b.vx * dt * 60;
            b.y += b.vy * dt * 60;
            b.dist += Math.hypot(b.vx, b.vy) * dt * 60;

            if(b.dist > b.range) { bullets.splice(i,1); continue; }

            let hit = false;
            for(let w of walls) {
                if(b.x > w.x && b.x < w.x+w.w && b.y > w.y && b.y < w.y+w.h) {
                    hit = true;
                    spawnParticles(b.x, b.y, 5, '#bbb', 2); // Dust
                    break;
                }
            }
            if(hit) { bullets.splice(i,1); continue; }

            if(b.owner === localPlayer.team) {
                if(Math.hypot(b.x - remotePlayer.x, b.y - remotePlayer.y) < 25) {
                    spawnBlood(b.x, b.y);
                    spawnDamageNumber(b.x, b.y, b.dmg);
                    send({ type: 'event', kind: 'hit_player', dmg: b.dmg });
                    bullets.splice(i,1);
                    continue;
                }
                const targetTower = localPlayer.team === 'blue' ? towers.red : towers.blue;
                if(targetTower.hp > 0 && Math.hypot(b.x - targetTower.x, b.y - targetTower.y) < 50) {
                    spawnParticles(b.x, b.y, 8, '#f59e0b', 3);
                    send({ type: 'event', kind: 'hit_tower', dmg: b.dmg, team: localPlayer.team === 'blue' ? 'red' : 'blue' });
                    bullets.splice(i,1);
                    continue;
                }
            }
        }

        const enemyTower = localPlayer.team === 'blue' ? towers.red : towers.blue;
        if(enemyTower.hp > 0) {
            const d = Math.hypot(localPlayer.x - enemyTower.x, localPlayer.y - enemyTower.y);
            if(d < 500) { 
                if(Date.now() - (enemyTower.lastFire || 0) > 1500) {
                    enemyTower.lastFire = Date.now();
                    const a = Math.atan2(localPlayer.y - enemyTower.y, localPlayer.x - enemyTower.x);
                    bullets.push({
                        x: enemyTower.x, y: enemyTower.y,
                        vx: Math.cos(a) * 15, vy: Math.sin(a) * 15,
                        owner: 'tower', range: 1000, dmg: 100, color: '#fff', size: 6
                    });
                    spawnParticles(enemyTower.x, enemyTower.y, 20, '#ffaa00', 5);
                }
            }
        }

        updateParticles(dt);
        
        document.getElementById('blue-bar').style.width = (towers.blue.hp/TOWER_MAX_HP*100) + '%';
        document.getElementById('blue-hp-text').innerText = Math.max(0, towers.blue.hp);
        document.getElementById('red-bar').style.width = (towers.red.hp/TOWER_MAX_HP*100) + '%';
        document.getElementById('red-hp-text').innerText = Math.max(0, towers.red.hp);
        document.getElementById('hud-hp-bar').style.width = (localPlayer.hp/PLAYER_MAX_HP*100) + '%';
        
        if((towers.blue.hp <= 0 || towers.red.hp <= 0) && gameActive) endGame('destruction');
        if(localPlayer.hp <= 0 && gameActive) document.body.style.filter = "grayscale(1)";
    }

    function handleGameUpdate(d) {
        remotePlayer.targetX = d.x;
        remotePlayer.targetY = d.y;
        remotePlayer.angle = d.a;
        remotePlayer.hp = d.hp;
        remotePlayer.moving = d.m;
        if(d.t !== undefined) timeLeft = d.t;
    }

    function handleGameEvent(d) {
        if(d.kind === 'shot') {
            const gun = GUNS[d.gun];
            remotePlayer.recoil = 10;
            bullets.push({
                x: remotePlayer.x + Math.cos(d.a)*30, 
                y: remotePlayer.y + Math.sin(d.a)*30,
                vx: Math.cos(d.a + (Math.random()-0.5)*gun.spread) * gun.speed,
                vy: Math.sin(d.a + (Math.random()-0.5)*gun.spread) * gun.speed,
                owner: remotePlayer.team,
                range: gun.range * 20, dmg: gun.dmg, color: gun.color, size: 3
            });
            spawnParticles(remotePlayer.x + Math.cos(d.a)*30, remotePlayer.y + Math.sin(d.a)*30, 8, '#fff', 4);
        } else if(d.kind === 'hit_player') {
            localPlayer.hp -= d.dmg;
            camera.shake = 10;
        } else if(d.kind === 'hit_tower') {
            towers[d.team].hp -= d.dmg;
            spawnDamageNumber(towers[d.team].x, towers[d.team].y, d.dmg);
        } else if(d.kind === 'game_over') {
             endGameDisplay(d.winner, d.reason);
        }
    }

    function draw() {
        CTX.fillStyle = COLORS.bg;
        CTX.fillRect(0,0, CANVAS.width, CANVAS.height);

        CTX.save();
        CTX.translate(-Math.floor(camera.x), -Math.floor(camera.y));

        // Grass Pattern
        CTX.fillStyle = COLORS.grassDark;
        CTX.fillRect(0,0, MAP_W, MAP_H);
        CTX.fillStyle = COLORS.grassLight;
        for(let i=0; i<MAP_W; i+=100) {
            for(let j=0; j<MAP_H; j+=100) {
                 if((i+j)%200===0) CTX.fillRect(i,j,100,100);
            }
        }
        // Grid lines overlay
        CTX.strokeStyle = 'rgba(0,0,0,0.2)';
        CTX.lineWidth = 1;
        CTX.beginPath();
        for(let x=0; x<=MAP_W; x+=100) { CTX.moveTo(x,0); CTX.lineTo(x, MAP_H); }
        for(let y=0; y<=MAP_H; y+=100) { CTX.moveTo(0,y); CTX.lineTo(MAP_W, y); }
        CTX.stroke();

        decals.forEach(d => {
            CTX.globalAlpha = d.alpha;
            CTX.fillStyle = d.color;
            CTX.beginPath(); CTX.arc(d.x, d.y, d.size, 0, Math.PI*2); CTX.fill();
        });
        CTX.globalAlpha = 1;

        // Walls (Better Rendering)
        walls.forEach(w => {
            // Shadow
            CTX.fillStyle = 'rgba(0,0,0,0.5)';
            CTX.fillRect(w.x+10, w.y+10, w.w, w.h);
            
            // Texture Color
            let colorTop = COLORS.wallTop;
            let colorSide = COLORS.wallSide;
            if(w.type === 'crate') { colorTop = '#78350f'; colorSide = '#451a03'; }
            if(w.type === 'sandbag') { colorTop = '#a3a375'; colorSide = '#6b6b47'; }

            // Side Face
            CTX.fillStyle = colorSide; CTX.fillRect(w.x, w.y + w.h, w.w, 20);
            // Top Face
            CTX.fillStyle = colorTop; CTX.fillRect(w.x, w.y, w.w, w.h);
            
            // Detail
            CTX.fillStyle = 'rgba(255,255,255,0.05)'; 
            CTX.fillRect(w.x, w.y, w.w, 5); // top edge
            
            // X pattern for crates
            if(w.type === 'crate') {
                CTX.strokeStyle = 'rgba(0,0,0,0.2)';
                CTX.lineWidth = 5;
                CTX.beginPath();
                CTX.moveTo(w.x, w.y); CTX.lineTo(w.x+w.w, w.y+w.h);
                CTX.moveTo(w.x+w.w, w.y); CTX.lineTo(w.x, w.y+w.h);
                CTX.stroke();
            }
        });

        drawTower(towers.blue, 'blue');
        drawTower(towers.red, 'red');
        drawPlayer(localPlayer);
        drawPlayer(remotePlayer);

        CTX.shadowBlur = 8;
        bullets.forEach(b => {
            CTX.shadowColor = b.color; CTX.fillStyle = b.color;
            CTX.beginPath(); CTX.arc(b.x, b.y, b.size || 3, 0, Math.PI*2); CTX.fill();
        });
        CTX.shadowBlur = 0;

        particles.forEach(p => {
            CTX.fillStyle = p.color; CTX.globalAlpha = p.life;
            CTX.beginPath(); CTX.arc(p.x, p.y, p.size, 0, Math.PI*2); CTX.fill();
        });
        CTX.globalAlpha = 1;

        CTX.font = "bold 20px 'Inter'";
        CTX.textAlign = "center";
        damageNumbers.forEach(n => {
            CTX.fillStyle = `rgba(255, 255, 255, ${n.life})`;
            CTX.fillText(n.val, n.x, n.y - (1-n.life)*30);
        });

        CTX.restore();
    }

    function drawTower(t, color) {
        CTX.fillStyle = '#1c1917';
        CTX.beginPath(); CTX.arc(t.x, t.y, 60, 0, Math.PI*2); CTX.fill();
        CTX.shadowColor = t.color; CTX.shadowBlur = 20; CTX.fillStyle = t.color;
        CTX.beginPath(); CTX.arc(t.x, t.y, 25, 0, Math.PI*2); CTX.fill();
        CTX.shadowBlur = 0;
        CTX.strokeStyle = '#555'; CTX.lineWidth = 5;
        CTX.beginPath(); CTX.arc(t.x, t.y, 45, 0, Math.PI*2); CTX.stroke();
        
        // Turret Barrel
        CTX.fillStyle = '#333';
        CTX.save(); CTX.translate(t.x, t.y);
        // Rotate turret towards closest player (visual only)
        // Omitted for simplicity, just fixed or rotating
        CTX.fillRect(-8, -8, 16, 16);
        CTX.restore();
    }

    function drawPlayer(p) {
        if(p.hp <= 0) return;
        CTX.save();
        CTX.translate(p.x, p.y);
        CTX.rotate(p.angle);

        // Uniform Colors
        let vestColor = p.team === 'blue' ? '#1e3a8a' : '#7f1d1d';
        let helmetColor = p.team === 'blue' ? '#3b82f6' : '#ef4444';
        let skinColor = '#e5c29f';

        // Legs (Animated)
        if(p.moving) {
            const shift = Math.sin(Date.now()/80) * 10;
            CTX.fillStyle = '#18181b'; // Black pants
            CTX.beginPath(); CTX.roundRect(0, 8+shift, 14, 10, 4); CTX.fill(); // R Leg
            CTX.beginPath(); CTX.roundRect(0, -18-shift, 14, 10, 4); CTX.fill(); // L Leg
        } else {
             CTX.fillStyle = '#18181b';
             CTX.beginPath(); CTX.roundRect(0, 8, 14, 10, 4); CTX.fill();
             CTX.beginPath(); CTX.roundRect(0, -18, 14, 10, 4); CTX.fill();
        }

        // Body Armor / Shoulders
        CTX.fillStyle = vestColor;
        CTX.beginPath(); CTX.arc(0, 0, 18, 0, Math.PI*2); CTX.fill(); // Torso
        
        // Backpack
        CTX.fillStyle = '#27272a';
        CTX.beginPath(); CTX.roundRect(-18, -12, 8, 24, 3); CTX.fill();

        // Helmet
        CTX.fillStyle = helmetColor;
        CTX.beginPath(); CTX.arc(2, 0, 12, 0, Math.PI*2); CTX.fill();
        // Visor/Goggles
        CTX.fillStyle = '#111';
        CTX.fillRect(8, -6, 4, 12);

        // Arms
        CTX.fillStyle = vestColor; // Sleeves
        CTX.beginPath(); CTX.arc(6, 16, 7, 0, Math.PI*2); CTX.fill(); // R Shoulder
        CTX.beginPath(); CTX.arc(6, -16, 7, 0, Math.PI*2); CTX.fill(); // L Shoulder

        // Hands (holding gun)
        CTX.fillStyle = '#333'; // Gloves
        CTX.beginPath(); CTX.arc(15, 8, 5, 0, Math.PI*2); CTX.fill(); // R Hand
        CTX.beginPath(); CTX.arc(25, -2, 5, 0, Math.PI*2); CTX.fill(); // L Hand (Front)

        // GUN Rendering
        const gun = GUNS[p.gun];
        const recoilX = - (p.recoil || 0);
        
        CTX.translate(10 + recoilX, 5); // Gun Position
        
        CTX.fillStyle = gun.color; // Gun Body
        CTX.fillRect(0, -gun.width/2, gun.length, gun.width);
        
        // Gun Details based on type
        if(p.gun === 'ar') {
            CTX.fillStyle = '#111'; // Stock
            CTX.fillRect(-10, -3, 10, 6);
            CTX.fillStyle = '#222'; // Magazine
            CTX.fillRect(10, 2, 4, 8);
            CTX.fillStyle = '#000'; // Rails
            CTX.fillRect(5, -4, 20, 2);
        } else if(p.gun === 'sniper') {
            CTX.fillStyle = '#111'; // Stock
            CTX.fillRect(-15, -3, 15, 6);
            CTX.fillStyle = '#000'; // Scope
            CTX.fillRect(5, -5, 15, 3);
            CTX.fillStyle = '#222'; // Barrel tip
            CTX.fillRect(gun.length, -3, 5, 6);
        }

        CTX.restore();

        // Nameplate
        CTX.fillStyle = 'rgba(0,0,0,0.6)';
        CTX.fillRect(p.x-30, p.y-55, 60, 16);
        CTX.fillStyle = '#fff'; CTX.font = 'bold 10px Inter'; CTX.textAlign = 'center';
        CTX.fillText(p.name, p.x, p.y-43);
        CTX.fillStyle = '#22c55e'; CTX.fillRect(p.x-30, p.y-39, 60 * (p.hp/PLAYER_MAX_HP), 3);
    }

    // --- Inputs ---
    window.addEventListener('mousedown', (e) => {
        if(gameActive && localPlayer.hp > 0 && e.button === 0) tryShoot();
    });
    
    window.addEventListener('mousemove', (e) => {
        const r = CANVAS.getBoundingClientRect();
        mouse.x = e.clientX - r.left;
        mouse.y = e.clientY - r.top;
        mouse.worldX = mouse.x + camera.x;
        mouse.worldY = mouse.y + camera.y;
    });

    window.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        // Just move, no marker
        localPlayer.destX = mouse.worldX;
        localPlayer.destY = mouse.worldY;
    });

    function tryShoot() {
        const gun = GUNS[localPlayer.gun];
        if(Date.now() - (localPlayer.lastShot || 0) < 60000/gun.rate) return;
        localPlayer.lastShot = Date.now();
        
        localPlayer.recoil = 8; // Visual Kick

        const spread = (Math.random()-0.5) * gun.spread;
        const angle = localPlayer.angle + spread;
        bullets.push({
            x: localPlayer.x + Math.cos(localPlayer.angle)*30,
            y: localPlayer.y + Math.sin(localPlayer.angle)*30,
            vx: Math.cos(angle) * gun.speed,
            vy: Math.sin(angle) * gun.speed,
            range: gun.range * 20, dmg: gun.dmg, color: '#fffae3', owner: localPlayer.team
        });
        camera.shake = 5;
        
        // Shell
        const shellAngle = localPlayer.angle + Math.PI/2;
        particles.push({
            x: localPlayer.x, y: localPlayer.y,
            vx: Math.cos(shellAngle)*4 + (Math.random()-0.5), vy: Math.sin(shellAngle)*4 + (Math.random()-0.5),
            life: 0.8, size: 2, color: '#fbbf24', decay: 0.02
        });
        // Muzzle Flash
        spawnParticles(localPlayer.x + Math.cos(localPlayer.angle)*40, localPlayer.y + Math.sin(localPlayer.angle)*40, 6, '#fff', 4);
        
        send({ type: 'event', kind: 'shot', gun: localPlayer.gun, a: angle });
    }

    function spawnParticles(x, y, count, color, speed) {
        for(let i=0; i<count; i++) {
            particles.push({
                x: x, y: y,
                vx: (Math.random()-0.5) * 10 * speed,
                vy: (Math.random()-0.5) * 10 * speed,
                life: 1.0, color: color, size: Math.random() * 3 + 1, decay: 0.05 + Math.random()*0.05
            });
        }
    }

    function spawnBlood(x, y) {
        spawnParticles(x, y, 12, '#991b1b', 1.5);
        decals.push({
            x: x + (Math.random()-0.5)*15, y: y + (Math.random()-0.5)*15,
            size: 5 + Math.random()*8, color: '#450a0a', alpha: 0.7
        });
        if(decals.length > 50) decals.shift();
    }

    function spawnDamageNumber(x, y, val) {
        damageNumbers.push({ x, y, val, life: 1.0 });
    }

    function updateParticles(dt) {
        for(let i=particles.length-1; i>=0; i--) {
            let p = particles[i];
            p.x += p.vx; p.y += p.vy;
            p.life -= p.decay;
            if(p.life <= 0) particles.splice(i,1);
        }
        for(let i=damageNumbers.length-1; i>=0; i--) {
            let n = damageNumbers[i];
            n.y -= 1; n.life -= 0.02;
            if(n.life <= 0) damageNumbers.splice(i,1);
        }
    }

    function resize() {
        CANVAS.width = window.innerWidth;
        CANVAS.height = window.innerHeight;
        CTX.fillStyle = COLORS.bg;
        CTX.fillRect(0,0, CANVAS.width, CANVAS.height);
    }

    function endGame(reason) {
        if(!gameActive) return;
        gameActive = false;
        
        let winner = 'draw';
        let winReasonText = "MISSION ENDED";

        if(reason === 'timeout') {
            winReasonText = "TIME LIMIT REACHED";
            if(towers.blue.hp > towers.red.hp) winner = 'blue';
            else if(towers.red.hp > towers.blue.hp) winner = 'red';
            else winner = 'draw';
        } else {
            winReasonText = "TARGET DESTROYED";
            if(towers.blue.hp <= 0 && towers.red.hp > 0) winner = 'red';
            else if(towers.red.hp <= 0 && towers.blue.hp > 0) winner = 'blue';
            else winner = 'draw';
        }

        endGameDisplay(winner, winReasonText);
        send({ type: 'event', kind: 'game_over', winner: winner, reason: winReasonText });
    }

    function endGameDisplay(winner, reasonText) {
        gameActive = false;
        document.getElementById('end-screen').classList.remove('hidden');
        const title = document.getElementById('end-title');
        const reason = document.getElementById('end-reason');
        
        reason.innerText = reasonText;

        if(winner === localPlayer.team) {
            title.innerText = "VICTORY";
            title.className = "text-8xl font-black italic tracking-tighter mb-2 text-green-500";
        } else if(winner === 'draw') {
            title.innerText = "DRAW";
            title.className = "text-8xl font-black italic tracking-tighter mb-2 text-yellow-500";
        } else {
            title.innerText = "DEFEAT";
            title.className = "text-8xl font-black italic tracking-tighter mb-2 text-red-500";
        }
    }

    init();
</script>
</body>
</html>
