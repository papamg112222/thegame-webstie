<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Rise and Fall: Chapter 1</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; }
        
        /* UI Elements */
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 8px; height: 8px;
            background: white; border: 1px solid black; border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 5;
        }
        
        #hud {
            position: absolute; top: 20px; left: 20px; color: white;
            text-shadow: 1px 1px 2px black; font-size: 18px; pointer-events: none;
        }
        
        #objective-box {
            background: rgba(0, 0, 0, 0.5); padding: 10px 20px; border-left: 4px solid #00e5ff;
        }

        #chat-ui {
            display: none; position: absolute; bottom: 30px; left: 50%;
            transform: translateX(-50%); width: 600px; background: rgba(20, 20, 20, 0.95);
            border: 1px solid #444; border-radius: 8px; font-family: 'Consolas', monospace;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); z-index: 10;
        }
        
        #chat-log {
            height: 200px; overflow-y: auto; padding: 10px; border-bottom: 1px solid #333;
            display: flex; flex-direction: column; justify-content: flex-end;
        }
        
        #chat-input {
            width: 100%; background: transparent; border: none; color: white;
            font-size: 16px; padding: 15px; outline: none; box-sizing: border-box;
        }

        .msg-line { margin: 4px 0; line-height: 1.4; font-size: 14px; }
        .u-msg { color: #00e5ff; }
        .ai-msg { color: #ffd700; }
        .sys-msg { color: #aaaaaa; font-style: italic; }

        #blocker {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); color: white; display: flex;
            justify-content: center; align-items: center; flex-direction: column; z-index: 20;
        }
        
        h1 { margin: 0 0 10px 0; letter-spacing: 5px; }
        .controls { font-size: 14px; color: #888; margin-top: 20px; }
    </style>
</head>
<body>

<div id="crosshair"></div>

<div id="hud">
    <div id="objective-box">
        <strong>OBJECTIVE:</strong> <span id="objective-text">Find the Red Memory Cube (0/3)</span>
    </div>
</div>

<div id="blocker">
    <h1>SIMULATION: RESET</h1>
    <p>Click to Start</p>
    <div class="controls">WASD: Move | MOUSE: Look | /: Chat</div>
</div>

<div id="chat-ui">
    <div id="chat-log">
        <div class="msg-line sys-msg">System: Press '/' to toggle chat. Type naturally.</div>
    </div>
    <input type="text" id="chat-input" placeholder="Say something..." autocomplete="off">
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

    // --- CONFIGURATION ---
    const WALK_SPEED = 60.0; // Much slower, realistic walk speed
    const RUN_SPEED = 100.0;
    
    // --- VARIABLES ---
    let camera, scene, renderer, controls;
    let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
    let prevTime = performance.now();
    let velocity = new THREE.Vector3();
    let direction = new THREE.Vector3();
    
    // Game State
    let orbsCollected = 0;
    let storyPhase = 0; // 0: Normal, 1: Fame, 2: Hate
    const orbs = [];
    const npcs = [];
    
    // Speech
    const synth = window.speechSynthesis;

    init();
    animate();

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x88ccee);
        scene.fog = new THREE.Fog(0x88ccee, 0, 80);

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.y = 1.6;

        const light = new THREE.HemisphereLight(0xffffff, 0x444444, 2);
        light.position.set(0, 20, 0);
        scene.add(light);
        
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(10, 20, 10);
        dirLight.castShadow = true;
        scene.add(dirLight);

        controls = new PointerLockControls(camera, document.body);

        const blocker = document.getElementById('blocker');
        blocker.addEventListener('click', () => controls.lock());
        
        controls.addEventListener('lock', () => {
            blocker.style.display = 'none';
        });
        
        controls.addEventListener('unlock', () => {
            if (document.getElementById('chat-ui').style.display !== 'block') {
                blocker.style.display = 'flex';
            }
        });
        
        scene.add(controls.getObject());

        // Inputs
        const onKeyDown = (event) => {
            switch (event.code) {
                case 'KeyW': moveForward = true; break;
                case 'KeyA': moveLeft = true; break;
                case 'KeyS': moveBackward = true; break;
                case 'KeyD': moveRight = true; break;
                case 'Slash': 
                    event.preventDefault();
                    toggleChat();
                    break;
            }
        };

        const onKeyUp = (event) => {
            switch (event.code) {
                case 'KeyW': moveForward = false; break;
                case 'KeyA': moveLeft = false; break;
                case 'KeyS': moveBackward = false; break;
                case 'KeyD': moveRight = false; break;
            }
        };

        document.addEventListener('keydown', onKeyDown);
        document.addEventListener('keyup', onKeyUp);

        // Build Level
        createEnvironment();

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);
        window.addEventListener('resize', onWindowResize);
    }

    function createEnvironment() {
        // Ground
        const ground = new THREE.Mesh(
            new THREE.PlaneGeometry(2000, 2000),
            new THREE.MeshStandardMaterial({ color: 0x228b22 })
        );
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Houses
        createHouse(0, 0, -20); // Player house
        createHouse(30, 0, 20);
        createHouse(-30, 0, 20);
        createHouse(30, 0, -40);
        createHouse(-30, 0, -40);
        createHouse(0, 0, 60);

        // Create 20 NPCs
        for(let i=0; i<20; i++) createNPC();

        // Create 3 Orbs (Objectives) hidden around
        createOrb(30, 1.5, 30);   // Near house 1
        createOrb(-40, 1.5, -10); // Behind start
        createOrb(0, 1.5, 80);    // Far away
    }

    function createHouse(x, y, z) {
        const group = new THREE.Group();
        const w = new THREE.Mesh(new THREE.BoxGeometry(12, 6, 12), new THREE.MeshStandardMaterial({ color: 0xdddddd }));
        w.position.y = 3;
        w.castShadow = true; w.receiveShadow = true;
        const r = new THREE.Mesh(new THREE.ConeGeometry(9, 4, 4), new THREE.MeshStandardMaterial({ color: 0xa52a2a }));
        r.position.y = 8; r.rotation.y = Math.PI/4;
        group.add(w); group.add(r);
        group.position.set(x, y, z);
        scene.add(group);
    }

    function createNPC() {
        const group = new THREE.Group();
        // Simple human shape
        const mat = new THREE.MeshStandardMaterial({ color: Math.random() * 0xffffff });
        const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1.0, 4, 8), mat);
        body.position.y = 0.9;
        const head = new THREE.Mesh(new THREE.SphereGeometry(0.3, 16, 16), new THREE.MeshStandardMaterial({ color: 0xffccaa }));
        head.position.y = 1.7;
        
        group.add(body); group.add(head);
        
        // Random pos not near 0,0
        let rx = (Math.random() - 0.5) * 100;
        let rz = (Math.random() - 0.5) * 100;
        if(Math.abs(rx) < 10) rx += 20;
        
        group.position.set(rx, 0, rz);
        scene.add(group);

        npcs.push({
            mesh: group,
            dir: new THREE.Vector3(Math.random()-0.5, 0, Math.random()-0.5).normalize(),
            speed: 0.01 + Math.random() * 0.02,
            voicePitch: 0.5 + Math.random() * 1.0,
            lastChat: 0
        });
    }

    function createOrb(x, y, z) {
        const geo = new THREE.BoxGeometry(1, 1, 1);
        const mat = new THREE.MeshStandardMaterial({ color: 0xff0000, emissive: 0xff0000, emissiveIntensity: 2 });
        const orb = new THREE.Mesh(geo, mat);
        orb.position.set(x, y, z);
        scene.add(orb);
        orbs.push(orb);
    }

    function animate() {
        requestAnimationFrame(animate);
        const time = performance.now();
        const delta = (time - prevTime) / 1000;

        if (controls.isLocked) {
            // -- BETTER PHYSICS --
            velocity.x -= velocity.x * 10.0 * delta; // Friction
            velocity.z -= velocity.z * 10.0 * delta;

            direction.z = Number(moveForward) - Number(moveBackward);
            direction.x = Number(moveRight) - Number(moveLeft);
            direction.normalize();

            // Reduced multiplier for slower walk
            if (moveForward || moveBackward) velocity.z -= direction.z * WALK_SPEED * delta;
            if (moveLeft || moveRight) velocity.x -= direction.x * WALK_SPEED * delta;

            controls.moveRight(-velocity.x * delta);
            controls.moveForward(-velocity.z * delta);
            
            // -- OBJECTIVE CHECK --
            orbs.forEach((orb, index) => {
                if(orb.visible && controls.getObject().position.distanceTo(orb.position) < 2) {
                    collectOrb(orb);
                }
                // Rotate orbs
                orb.rotation.y += delta;
                orb.rotation.x += delta;
            });
        }

        // NPC AI Logic
        npcs.forEach(npc => {
            const dist = npc.mesh.position.distanceTo(camera.position);
            
            // Movement Logic based on Story Phase
            if (storyPhase === 0) {
                // Wandering normally
                npc.mesh.position.addScaledVector(npc.dir, npc.speed);
                if(Math.random() < 0.005) npc.dir.set(Math.random()-0.5, 0, Math.random()-0.5).normalize();
            } else if (storyPhase === 1) {
                // FAME: They gather around you
                npc.mesh.lookAt(camera.position.x, 1, camera.position.z);
                if (dist > 4) {
                     const toPlayer = new THREE.Vector3().subVectors(camera.position, npc.mesh.position).normalize();
                     toPlayer.y = 0;
                     npc.mesh.position.addScaledVector(toPlayer, npc.speed * 1.5);
                }
            } else if (storyPhase === 2) {
                // HATE: They stop and stare menacingly
                npc.mesh.lookAt(camera.position.x, 1, camera.position.z);
            }
        });

        prevTime = time;
        renderer.render(scene, camera);
    }

    function collectOrb(orb) {
        orb.visible = false;
        orbsCollected++;
        
        // Update Objective Text
        document.getElementById('objective-text').innerText = `Find the Red Memory Cube (${orbsCollected}/3)`;

        if(orbsCollected === 1) {
            storyPhase = 1; // Fame starts
            updateStatus("Objective Updated: People are starting to notice you...");
        } else if (orbsCollected === 3) {
            storyPhase = 2; // Hate starts
            updateStatus("Objective Complete. Something feels wrong...");
            document.getElementById('objective-text').innerText = "SURVIVE / ESCAPE";
            document.getElementById('objective-box').style.borderLeft = "4px solid red";
        }
    }

    function updateStatus(text) {
        const div = document.createElement('div');
        div.className = 'msg-line sys-msg';
        div.innerText = `>> SYSTEM: ${text}`;
        document.getElementById('chat-log').appendChild(div);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // --- ADVANCED CHAT SYSTEM ---
    
    const chatUI = document.getElementById('chat-ui');
    const chatInput = document.getElementById('chat-input');
    const chatLog = document.getElementById('chat-log');

    function toggleChat() {
        if (chatUI.style.display === 'block') {
            chatUI.style.display = 'none';
            controls.lock();
            chatInput.blur();
        } else {
            controls.unlock();
            chatUI.style.display = 'block';
            chatInput.focus();
        }
    }

    chatInput.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' && chatInput.value.trim() !== "") {
            const txt = chatInput.value.trim();
            addLog("You", txt);
            chatInput.value = "";
            
            // AI Thinking Delay
            setTimeout(() => {
                respondAI(txt);
            }, 600 + Math.random() * 500);
        }
    });

    function addLog(name, text) {
        const div = document.createElement('div');
        div.className = name === "You" ? 'msg-line u-msg' : 'msg-line ai-msg';
        div.innerHTML = `<strong>${name}:</strong> ${text}`;
        chatLog.appendChild(div);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    // --- THE RESPONSE ENGINE (1000+ Combinations Logic) ---
    
    // Arrays of response fragments
    const openers = ["Well,", "Honestly,", "Look,", "Hey,", "Um,", "Listen,", "Oh,"];
    const neutral_generic = ["Nice weather.", "I'm busy building my house.", "Did you see the news?", "Just walking around.", "Not much happening today.", "Who are you again?", "Have a nice day."];
    
    const fame_greetings = ["It's really him!", "Oh my god!", "Sir!", "Can I have a moment?", "I love your work!", "You're my hero!", "Is it really you?"];
    const fame_praises = ["You are absolutely brilliant!", "You look stunning today.", "How do you do it?", "Please sign my shirt.", "We are not worthy!", "You are the best person ever."];
    
    const hate_insults = ["Get lost.", "You disgust me.", "Why are you still here?", "Nobody wants you here.", "Traitor.", "Pathetic.", "Just leave.", "Don't talk to me."];
    const hate_threats = ["Watch your back.", "We know what you did.", "I'm calling the police.", "You're finished.", "You ruined everything."];

    function respondAI(input) {
        const text = input.toLowerCase();
        let reply = "...";
        let mood = "neutral";

        // 1. Analyze Context (Story Phase)
        if (storyPhase === 0) {
            // PHASE 0: NEUTRAL
            if(text.includes("hi") || text.includes("hello")) reply = "Hi there neighbor. Lovely morning.";
            else if(text.includes("who")) reply = "I'm just a villager. We are all just code, aren't we?";
            else if(text.includes("cube") || text.includes("red")) reply = "I saw something red glowing behind the big house.";
            else if(text.includes("where")) reply = "You are in the simulation test village.";
            else reply = getRandom(neutral_generic);
        } 
        else if (storyPhase === 1) {
            // PHASE 1: FAME (Obsessive Love)
            mood = "happy";
            if(text.includes("hi") || text.includes("hello")) reply = getRandom(fame_greetings) + " " + getRandom(fame_praises);
            else if(text.includes("stop")) reply = "I can't stop! You're too famous!";
            else if(text.includes("thank")) reply = "No, thank YOU for existing!";
            else if(text.includes("why")) reply = "Because you are the chosen one! Look at you!";
            else if(text.includes("no")) reply = "Don't be modest, you're a legend.";
            else reply = getRandom(openers) + " " + getRandom(fame_praises) + " I saw you on TV!";
        } 
        else if (storyPhase === 2) {
            // PHASE 2: HATE (Unreasonable Anger)
            mood = "angry";
            if(text.includes("help")) reply = "I hope nobody helps you.";
            else if(text.includes("sorry")) reply = "Sorry doesn't fix what you did.";
            else if(text.includes("why")) reply = "You know exactly why. Don't play dumb.";
            else if(text.includes("please")) reply = "Begging won't save you.";
            else reply = getRandom(hate_insults) + " " + getRandom(hate_threats);
        }

        // 2. Pick a random NPC nearby to "Say" it
        const speaker = npcs[Math.floor(Math.random() * npcs.length)];
        
        // 3. Audio & Log
        addLog("Villager", reply);
        speak(reply, speaker);
    }

    function getRandom(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }

    function speak(text, npc) {
        if(synth.speaking) synth.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        
        // Randomize voice characteristics to make them feel unique
        utter.pitch = npc.voicePitch; 
        utter.rate = 0.9 + (Math.random() * 0.2); // slight speed variation
        
        // Try to get a decent voice
        const voices = synth.getVoices();
        const preferred = voices.find(v => v.lang === 'en-US' || v.lang === 'en-GB');
        if(preferred) utter.voice = preferred;

        synth.speak(utter);
    }

</script>
</body>
</html>
