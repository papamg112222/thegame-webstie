<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gas Laws Simulator</title>
    <style>
        body {
            margin: 0;
            overflow: hidden; /* Hide scrollbars due to particle canvas */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Ensure body takes full viewport height */
            position: relative;
        }

        /* Particle Canvas for background */
        #particleCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background-color: #1a1a2e; /* Dark background for particles */
        }

        /* Main Menu Styling */
        #mainMenu {
            display: flex;
            flex-direction: column;
            gap: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 40px 50px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 1; /* Above particles */
            max-width: 500px;
            width: 90%;
            box-sizing: border-box;
        }

        #mainMenu h1 {
            color: #4a90e2; /* Blue title */
            margin-bottom: 25px;
            font-size: 2.5em;
            letter-spacing: 1px;
        }

        #mainMenu button {
            background-color: #ff5a5f; /* Pinkish-red button */
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        #mainMenu button:hover {
            background-color: #e64d52;
            transform: translateY(-2px);
        }

        #mainMenu button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* General Game Mode Container */
        .gameMode {
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            width: 90%;
            max-width: 800px;
            min-height: 60vh;
            box-sizing: border-box;
            z-index: 1;
        }

        .game-mode-title {
            color: #4a90e2;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .explanation-text {
            margin-bottom: 30px;
            line-height: 1.6;
            font-size: 1.05em;
            max-width: 600px;
        }

        .return-btn {
            background-color: #888;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 30px;
        }

        .return-btn:hover {
            background-color: #666;
        }

        /* Common Slider and Value Display */
        .slider-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        .slider-group label {
            font-weight: bold;
            margin-bottom: 10px;
            color: #555;
            font-size: 1.1em;
        }

        .slider-group input[type="range"] {
            width: 80%;
            max-width: 400px;
            -webkit-appearance: none;
            height: 8px;
            background: #ddd;
            border-radius: 5px;
            outline: none;
            transition: opacity .2s;
            margin-bottom: 15px;
        }

        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ff5a5f;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .slider-group input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ff5a5f;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .value-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #4a90e2;
        }

        /* Boyle's Law Specific Styles */
        #boyle .canvas-container {
            width: 90%;
            max-width: 600px;
            height: 300px;
            border: 2px solid #ccc;
            background-color: #e0f2f7; /* Light blue container for gas */
            position: relative;
            overflow: hidden;
            margin: 20px auto;
            border-radius: 8px;
        }

        #boyleCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Charles's Law Specific Styles */
        #charles .balloon-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 30px;
            position: relative; /* For molecule-teller-bg positioning */
        }

        #charlesBalloon {
            width: 100px;
            height: 150px;
            background: radial-gradient(circle at 25% 25%, #ffbaba, #ff7a7f 30%, #ff5a5f 60%, #cc0000 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            transition: width 0.3s ease, height 0.3s ease;
            position: relative;
            z-index: 2; /* Ensure balloon is above molecules */
            margin: 0 auto; /* Center the balloon */
        }

        #charlesMoleculeBg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em; /* Large number in the background */
            color: rgba(255, 255, 255, 0.1); /* Very faint */
            font-weight: bold;
            z-index: 1; /* Behind balloon */
            pointer-events: none; /* Allow clicks to pass through */
        }

        /* Gay-Lussac's Law Specific Styles */
        #gayLussac .canvas-container {
            width: 90%;
            max-width: 600px;
            height: 300px;
            border: 2px solid #ccc;
            background-color: #e0f2f7;
            position: relative;
            overflow: hidden;
            margin: 20px auto;
            border-radius: 8px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        #gayLussacCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #gayLussac .pressure-display {
            margin-top: 20px;
            font-size: 1.4em;
            font-weight: bold;
            color: #e28d4a; /* Orange for pressure */
        }


        /* Avogadro's Law Specific Styles */
        #avogadro .balloon-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 30px;
            position: relative;
        }

        #avogadroBalloon {
            width: 100px;
            height: 150px;
            background: radial-gradient(circle at 25% 25%, #ffbaba, #ff7a7f 30%, #ff5a5f 60%, #cc0000 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            transition: width 0.3s ease, height 0.3s ease;
            position: relative;
            z-index: 2;
            margin: 0 auto;
        }
        /* Pop animation for Avogadro's balloon */
        #avogadroBalloon.pop {
            animation: popAnimation 0.6s forwards;
        }

        @keyframes popAnimation {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(0); opacity: 0; }
        }

        #avogadroMoleculeBg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            color: rgba(255, 255, 255, 0.1);
            font-weight: bold;
            z-index: 1;
            pointer-events: none;
        }

        #avogadroTopLeftCounter {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 1.1em;
            z-index: 3; /* Ensure it's on top */
        }

        .avogadro-increase-btn {
            background-color: #4CAF50; /* Green */
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 25px;
        }

        .avogadro-increase-btn:hover {
            background-color: #45a049;
        }

        .rainbow-button {
            background-image: linear-gradient(to right, #FFC700, #FF0000, #FF00FF, #0000FF, #00FFFF, #00FF00, #FFFF00, #FFC700);
            background-size: 200% auto;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.5s ease;
            animation: rainbowBorder 4s linear infinite;
            margin-top: 25px;
        }

        .rainbow-button:hover {
            background-position: right center; /* change the direction of the change */
        }

        @keyframes rainbowBorder {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        /* Member Page Specific Styles */
        #memberPage ul {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        #memberPage li {
            background-color: #f9f9f9;
            margin-bottom: 10px;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            font-size: 1.1em;
            color: #666;
            transition: transform 0.2s ease;
            /* Added padding-left for the "10/1" prefix */
            padding-left: 30px; /* Adjust as needed */
            position: relative;
        }

        #memberPage li:hover {
            transform: translateX(5px);
            background-color: #f0f0f0;
        }

        /* Style for the member button in main menu */
        #mainMenu .member-button {
            background-image: linear-gradient(to right, #6A11CB 0%, #2575FC 100%); /* A nice purple-blue gradient */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            font-weight: bold;
            letter-spacing: 0.5px;
            padding: 18px 28px; /* Slightly larger padding */
        }

        #mainMenu .member-button:hover {
            background-position: right center; /* Shift gradient on hover */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transform: translateY(-3px) scale(1.02); /* More pronounced lift */
        }
        #mainMenu .member-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

    </style>
</head>
<body>
    <canvas id="particleCanvas"></canvas>

    <div id="mainMenu" class="gameMode" style="display: flex;">
        <h1>Gas Laws Playground</h1>
        <button onclick="showMode('boyle')">Boyle's Law</button>
        <button onclick="showMode('charles')">Charles's Law</button>
        <button onclick="showMode('gayLussac')">Gay-Lussac's Law</button>
        <button onclick="showMode('avogadro')">Avogadro's Law</button>
        <button class="member-button" onclick="showMemberPage()">Our Amazing Team</button>
    </div>

    <div id="boyle" class="gameMode">
        <h2 class="game-mode-title">Boyle's Law</h2>
        <p class="explanation-text">
            In Boyle's Law, when **temperature** and **number of particles** are constant, the **pressure** of a gas
            is inversely proportional to its **volume**.
            Increase the mass on the piston (pressure) and watch the volume decrease.
        </p>
        <div class="slider-group">
            <label for="boyleMass">Mass on Piston (Pressure): <span id="boyleMassVal">10</span></label>
            <input type="range" id="boyleMass" min="1" max="20" value="10">
        </div>
        <div class="slider-group">
            <label for="boyleTemp">Temperature (Speed of Particles): <span id="boyleTempVal">50</span></label>
            <input type="range" id="boyleTemp" min="0" max="100" value="50">
        </div>
        <div class="canvas-container">
            <canvas id="boyleCanvas"></canvas>
        </div>
        <button class="return-btn" onclick="returnToMenu()">Return to Menu</button>
    </div>

    <div id="charles" class="gameMode">
        <h2 class="game-mode-title">Charles's Law</h2>
        <p class="explanation-text">
            In Charles's Law, when **pressure** and **number of particles** are constant,
            the **volume** of a gas is directly proportional to its **temperature**.
            Increase the temperature and watch the balloon expand!
        </p>
        <div class="slider-group">
            <label for="charlesTemp">Temperature: <span id="charlesTempVal">50</span></label>
            <input type="range" id="charlesTemp" min="0" max="100" value="50">
        </div>
        <div class="balloon-container">
            <div id="charlesBalloon" class="balloon" style="width:100px; height:150px; z-index: 2;"></div>
            <div id="charlesMoleculeBg" class="molecule-teller-bg">0</div>
        </div>
        <button class="return-btn" onclick="returnToMenu()">Return to Menu</button>
    </div>

    <div id="gayLussac" class="gameMode">
        <h2 class="game-mode-title">Gay-Lussac's Law</h2>
        <p class="explanation-text">
            In Gay-Lussac's Law, when **volume** and **number of particles** are constant,
            the **pressure** of a gas is directly proportional to its **temperature**.
            Observe how increasing temperature increases particle speed and collisions, leading to higher pressure.
        </p>
        <div class="slider-group">
            <label for="gayLussacTemp">Temperature: <span id="gayLussacTempVal">50</span></label>
            <input type="range" id="gayLussacTemp" min="0" max="100" value="50">
        </div>
        <div class="pressure-display">
            Calculated Pressure: <span id="gayLussacPressureVal">1.00</span> atm
        </div>
        <div class="canvas-container">
            <canvas id="gayLussacCanvas"></canvas>
        </div>
        <button class="return-btn" onclick="returnToMenu()">Return to Menu</button>
    </div>

    <div id="avogadro" class="gameMode">
        <h2 class="game-mode-title">Avogadro's Law</h2>
        <p class="explanation-text">
            In Avogadro's Law, when **temperature** and **pressure** are constant,
            the **volume** of a gas is directly proportional to the **number of particles**.
            Increase the number of molecules and watch the balloon expand until it pops!
        </p>
        <div class="container" style="position: relative;">
            <div id="avogadroTopLeftCounter" class="molecule-counter">Molecules: 0</div>

            <div class="balloon-container">
                <div id="avogadroBalloon" class="balloon" style="width:100px; height:150px; z-index: 2;"></div>
                <div id="avogadroMoleculeBg" class="molecule-teller-bg">0</div>
                <button id="getNewOneBtn" class="rainbow-button" style="display: none;">GET NEW ONE!!!</button>
            </div>

            <button id="increaseMoleculeBtn" class="avogadro-increase-btn">Increase Molecules</button>
        </div>
        <button class="return-btn" onclick="returnToMenu()">Return to Menu</button>
    </div>

    <div id="memberPage" class="gameMode">
        <h2>Our Amazing Team</h2>
        <ul>
            <li>10/1 Jittanan Pasartkeaw</li>
            <li>10/1 Thanunya Udomchaipon</li>
            <li>10/1 Hasana Pathan</li>
            <li>10/1 Phattaraporn Preeda</li>
            <li>10/1 Narisara Eiamsa-ard</li>
            <li>10/1 Chalita Ruttapoom</li>
            <li>10/1 Yanisa Singh</li>
        </ul>
        <button class="return-btn" onclick="returnToMenu()">Return to Menu</button>
    </div>

    <audio id="popSound" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg" preload="auto"></audio>

    <script>
        // === Animated Particles Background ===
        const canvas = document.getElementById('particleCanvas'), ctx = canvas.getContext('2d');
        let particles = [], width, height;
        function initParticles() {
            width = window.innerWidth; height = window.innerHeight;
            canvas.width = width; canvas.height = height;
            particles = [];
            for (let i = 0; i < 80; i++) {
                particles.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    radius: Math.random() * 6 + 2,
                    speedY: Math.random() * 1.5 + 0.5,
                    speedX: (Math.random() - 0.5) * 0.5,
                    color: 'rgba(255, 90, 95, 0.4)', /* Pinkish-red particles */
                    alpha: Math.random() * 0.5 + 0.3,
                    type: Math.random() > 0.5 ? 'circle' : 'atom'
                });
            }
        }

        function drawAtom(x, y, r) {
            ctx.strokeStyle = 'rgba(255,90,95,0.6)'; /* Pinkish-red atom lines */
            ctx.lineWidth = 1.2;
            ctx.beginPath(); ctx.arc(x, y, r * 0.6, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255,90,95,0.7)'; /* Pinkish-red atom fill */
            ctx.fill(); ctx.closePath();
            ctx.beginPath(); ctx.ellipse(x, y, r * 1.2, r * 0.5, 0, 0, Math.PI * 2); ctx.stroke();
            ctx.beginPath(); ctx.ellipse(x, y, r * 0.5, r * 1.2, Math.PI / 4, 0, Math.PI * 2); ctx.stroke();
        }

        function draw() {
            ctx.clearRect(0, 0, width, height);
            for (const p of particles) {
                p.y += p.speedY; p.x += p.speedX;
                if (p.y - p.radius > height) p.y = -p.radius;
                if (p.x - p.radius > width) p.x = -p.radius;
                else if (p.x + p.radius < 0) p.x = width + p.radius;
                ctx.globalAlpha = p.alpha;
                if (p.type === 'circle') {
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.closePath();
                } else {
                    drawAtom(p.x, p.y, p.radius);
                }
                ctx.globalAlpha = 1;
            }
            requestAnimationFrame(draw);
        }
        window.addEventListener('resize', initParticles);
        initParticles();
        draw();

        // === Main Menu & Mode Handling ===
        const modes = ['boyle','charles','gayLussac','avogadro','memberPage']; // Added memberPage
        function showMode(mode) {
            document.getElementById('mainMenu').style.display = 'none';
            modes.forEach(m => {
                document.getElementById(m).style.display = (m === mode ? 'flex' : 'none');
            });
            // Cancel all animations before starting a new one
            cancelAllAnimations();

            if(mode==='boyle') initBoyle();
            else if(mode==='charles') initCharles();
            else if(mode==='gayLussac') initGayLussac();
            else if(mode==='avogadro') initAvogadro();
            // No init function needed for memberPage as it's static HTML
        }
        function returnToMenu() {
            document.getElementById('mainMenu').style.display = 'flex';
            modes.forEach(m => {
                document.getElementById(m).style.display = 'none';
            });
            cancelAllAnimations(); // Cancel all animations when returning to menu
        }

        function cancelAllAnimations() {
            cancelBoyleAnimation();
            cancelCharlesAnimation();
            cancelGayLussacAnimation();
            cancelAvogadroIncrease();
        }

        // Member button function
        function showMemberPage() {
            showMode('memberPage'); // This will handle hiding other modes and displaying memberPage
        }

        // === BOYLE MODE ===
        const boyleMassSlider = document.getElementById('boyleMass');
        const boyleTempSlider = document.getElementById('boyleTemp');
        const boyleMassVal = document.getElementById('boyleMassVal');
        const boyleTempVal = document.getElementById('boyleTempVal');
        const boyleCanvas = document.getElementById('boyleCanvas');
        const bCtx = boyleCanvas.getContext('2d');

        let boyleBalls = [];
        let boyleAnimId;
        const BOYLE_BALL_RADIUS = 6; // Fixed radius for consistency
        const MAX_MASS_VALUE = 20; // Max value of the mass slider
        const MIN_TEMP_VALUE = 0;
        const MAX_TEMP_VALUE = 100;

        function initBoyle() {
            const container = boyleCanvas.parentElement;
            boyleCanvas.width = container.clientWidth;
            boyleCanvas.height = container.clientHeight;

            boyleMassVal.textContent = boyleMassSlider.value;
            boyleTempVal.textContent = boyleTempSlider.value;
            
            boyleBalls = []; // Clear balls initially
            addRemoveBoyleBalls(parseInt(boyleMassSlider.value)); // Populate with initial count
            updateBoyleBallSpeeds(); // Set initial speeds
            
            animateBoyle();
        }

        function addRemoveBoyleBalls(newMass) {
            const currentBallCount = boyleBalls.length;
            
            const containerArea = boyleCanvas.width * boyleCanvas.height;
            const ballArea = Math.PI * BOYLE_BALL_RADIUS * BOYLE_BALL_RADIUS;
            const IDEAL_MAX_BALLS = Math.floor(containerArea / (ballArea * 2.5));

            const targetBallCount = Math.floor((newMass / MAX_MASS_VALUE) * IDEAL_MAX_BALLS);
            
            if (targetBallCount > currentBallCount) {
                for (let i = 0; i < (targetBallCount - currentBallCount); i++) {
                    let newBall = {
                        x: Math.random() * (boyleCanvas.width - 2 * BOYLE_BALL_RADIUS) + BOYLE_BALL_RADIUS,
                        y: Math.random() * (boyleCanvas.height - 2 * BOYLE_BALL_RADIUS) + BOYLE_BALL_RADIUS,
                        radius: BOYLE_BALL_RADIUS,
                        speedX: 0,
                        speedY: 0,
                        color: '#ff5a5f'
                    };
                    boyleBalls.push(newBall);
                }
            } else if (targetBallCount < currentBallCount) {
                boyleBalls.splice(0, currentBallCount - targetBallCount);
            }
        }

        function updateBoyleBallSpeeds() {
            const temp = parseInt(boyleTempSlider.value);
            const mass = parseInt(boyleMassSlider.value);

            const baseSpeed = 1.5;
            const tempFactor = 0.5 + (temp / MAX_TEMP_VALUE) * 2.5;
            const massFactor = 1.0 - ( (mass - 1) / (MAX_MASS_VALUE - 1) ) * 0.7;

            const combinedSpeedFactor = baseSpeed * tempFactor * massFactor;
            
            boyleBalls.forEach(ball => {
                let currentSpeedMagnitude = Math.sqrt(ball.speedX * ball.speedX + ball.speedY * ball.speedY);
                
                if (currentSpeedMagnitude === 0 || isNaN(currentSpeedMagnitude) || currentSpeedMagnitude < 0.01) { 
                    let angle = Math.random() * Math.PI * 2;
                    ball.speedX = Math.cos(angle) * combinedSpeedFactor;
                    ball.speedY = Math.sin(angle) * combinedSpeedFactor;
                } else {
                    const scaleRatio = combinedSpeedFactor / currentSpeedMagnitude;
                    ball.speedX *= scaleRatio;
                    ball.speedY *= scaleRatio;
                }
            });
        }

        // This function is general enough to be used by Boyle and Gay-Lussac
        // *** COMMENTED OUT TO DISABLE BALL-TO-BALL COLLISIONS ***
        /*
        function resolveBoyleCollision(ball1, ball2) {
            const dx = ball2.x - ball1.x;
            const dy = ball2.y - ball1.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const minDistance = ball1.radius + ball2.radius;

            if (distance < minDistance && distance > 0) {
                const overlap = minDistance - distance;
                const nx = dx / distance;
                const ny = dy / distance;
                const separationAmount = overlap / 2 + 0.05;

                ball1.x -= nx * separationAmount;
                ball1.y -= ny * separationAmount;
                ball2.x += nx * separationAmount;
                ball2.y += ny * separationAmount;

                const vrx = ball1.speedX - ball2.speedX;
                const vry = ball1.speedY - ball2.speedY;
                const speedAlongNormal = vrx * nx + vry * ny;

                if (speedAlongNormal > 0) return;

                const elasticity = 0.95;
                const impulseMagnitude = -(1 + elasticity) * speedAlongNormal;

                ball1.speedX += impulseMagnitude * nx;
                ball1.speedY += impulseMagnitude * ny;
                ball2.speedX -= impulseMagnitude * nx;
                ball2.speedY -= impulseMagnitude * ny;
            }
        }
        */

        function animateBoyle() {
            const container = boyleCanvas.parentElement;
            if (boyleCanvas.width !== container.clientWidth || boyleCanvas.height !== container.clientHeight) {
                boyleCanvas.width = container.clientWidth;
                boyleCanvas.height = container.clientHeight;
                boyleBalls.forEach(ball => {
                    ball.x = Math.max(ball.radius, Math.min(ball.x, boyleCanvas.width - ball.radius));
                    ball.y = Math.max(ball.radius, Math.min(ball.y, boyleCanvas.height - ball.radius));
                });
            }

            bCtx.clearRect(0, 0, boyleCanvas.width, boyleCanvas.height);

            boyleBalls.forEach(ball => {
                ball.x += ball.speedX;
                ball.y += ball.speedY;
            });

            boyleBalls.forEach(ball => {
                if (ball.x + ball.radius > boyleCanvas.width) { ball.x = boyleCanvas.width - ball.radius; ball.speedX *= -1; }
                if (ball.x - ball.radius < 0) { ball.x = ball.radius; ball.speedX *= -1; }
                if (ball.y + ball.radius > boyleCanvas.height) { ball.y = boyleCanvas.height - ball.radius; ball.speedY *= -1; }
                if (ball.y - ball.radius < 0) { ball.y = ball.radius; ball.speedY *= -1; }
            });

            // *** COMMENTED OUT TO DISABLE BALL-TO-BALL COLLISIONS ***
            /*
            const numCollisionIterations = 3;
            for (let k = 0; k < numCollisionIterations; k++) {
                for (let i = 0; i < boyleBalls.length; i++) {
                    for (let j = i + 1; j < boyleBalls.length; j++) {
                        resolveBoyleCollision(boyleBalls[i], boyleBalls[j]);
                    }
                }
            }
            */

            boyleBalls.forEach(ball => {
                bCtx.fillStyle = ball.color;
                bCtx.beginPath();
                bCtx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                bCtx.fill();
                bCtx.closePath(); // Ensure path is closed
            });
            boyleAnimId = requestAnimationFrame(animateBoyle);
        }

        function cancelBoyleAnimation() {
            if (boyleAnimId) cancelAnimationFrame(boyleAnimId);
            boyleAnimId = null;
        }

        boyleMassSlider.oninput = () => {
            const newMass = parseInt(boyleMassSlider.value);
            boyleMassVal.textContent = newMass;
            addRemoveBoyleBalls(newMass);
            updateBoyleBallSpeeds();
        };

        boyleTempSlider.oninput = () => {
            boyleTempVal.textContent = boyleTempSlider.value;
            updateBoyleBallSpeeds();
        };

        // === CHARLES MODE ===
        const charlesTempSlider = document.getElementById('charlesTemp');
        const charlesTempVal = document.getElementById('charlesTempVal');
        const charlesBalloon = document.getElementById('charlesBalloon');
        const charlesMoleculeBg = document.getElementById('charlesMoleculeBg');
        let charlesAnimId = null;

        function initCharles() {
            charlesTempVal.textContent = charlesTempSlider.value;
            updateCharlesBalloon();
        }
        function updateCharlesBalloon() {
            const temp = parseInt(charlesTempSlider.value);
            charlesTempVal.textContent = temp;
            const minWidth = 80, minHeight = 120;
            const maxWidth = 140, maxHeight = 210;
            const width = minWidth + (maxWidth - minWidth) * (temp / 100);
            const height = minHeight + (maxHeight - minHeight) * (temp / 100);
            charlesBalloon.style.width = width + 'px';
            charlesBalloon.style.height = height + 'px';
            charlesBalloon.style.background = 'radial-gradient(circle at 25% 25%, #ffbaba, #ff7a7f 30%, #ff5a5f 60%, #cc0000 100%)';
            charlesBalloon.style.boxShadow = '0 8px 20px rgba(0,0,0,0.4)';
            charlesBalloon.style.position = 'relative';
            charlesBalloon.style.margin = '0 auto';
            charlesMoleculeBg.textContent = temp; // Display temp for conceptual clarity in background
        }
        charlesTempSlider.oninput = () => {
            updateCharlesBalloon();
        };
        function cancelCharlesAnimation() {
            if (charlesAnimId) cancelAnimationFrame(charlesAnimId);
            charlesAnimId = null;
        }


        // === GAY-LUSSAC MODE ===
        const gayLussacTempSlider = document.getElementById('gayLussacTemp');
        const gayLussacTempVal = document.getElementById('gayLussacTempVal');
        const gayLussacPressureVal = document.getElementById('gayLussacPressureVal');
        const gayLussacCanvas = document.getElementById('gayLussacCanvas');
        const gCtx = gayLussacCanvas.getContext('2d');

        let gayLussacBalls = [];
        let gayLussacAnimId;
        const GAYLUSSAC_BALL_RADIUS = 5;
        const GAYLUSSAC_NUM_BALLS = 80;
        const GAYLUSSAC_MIN_TEMP = 0;
        const GAYLUSSAC_MAX_TEMP = 100;

        function initGayLussac() {
            const container = gayLussacCanvas.parentElement;
            gayLussacCanvas.width = container.clientWidth - 40;
            gayLussacCanvas.height = container.clientHeight - 40;

            gayLussacTempVal.textContent = gayLussacTempSlider.value;
            updateGayLussacPressureDisplay(parseInt(gayLussacTempSlider.value));

            gayLussacBalls = [];
            for (let i = 0; i < GAYLUSSAC_NUM_BALLS; i++) {
                let newBall = {
                    x: Math.random() * (gayLussacCanvas.width - 2 * GAYLUSSAC_BALL_RADIUS) + GAYLUSSAC_BALL_RADIUS,
                    y: Math.random() * (gayLussacCanvas.height - 2 * GAYLUSSAC_BALL_RADIUS) + GAYLUSSAC_BALL_RADIUS,
                    radius: GAYLUSSAC_BALL_RADIUS,
                    speedX: 0,
                    speedY: 0,
                    color: 'rgba(74, 144, 226, 0.9)'
                };
                gayLussacBalls.push(newBall);
            }
            updateGayLussacSpeeds();
            
            animateGayLussac();
        }

        function updateGayLussacSpeeds() {
            const temp = parseInt(gayLussacTempSlider.value);
            const minEffectiveTemp = 273.15; // 0 Celsius in Kelvin
            const maxEffectiveTemp = 373.15; // 100 Celsius in Kelvin

            const currentEffectiveTemp = minEffectiveTemp + (temp / GAYLUSSAC_MAX_TEMP) * (maxEffectiveTemp - minEffectiveTemp);
            const speedScale = 0.05; // Adjust this value to control overall speed
            const targetSpeedMagnitude = currentEffectiveTemp * speedScale;

            gayLussacBalls.forEach(ball => {
                let currentSpeedMagnitude = Math.sqrt(ball.speedX * ball.speedX + ball.speedY * ball.speedY);
                
                if (currentSpeedMagnitude === 0 || isNaN(currentSpeedMagnitude) || currentSpeedMagnitude < 0.01) { 
                    let angle = Math.random() * Math.PI * 2;
                    ball.speedX = Math.cos(angle) * targetSpeedMagnitude;
                    ball.speedY = Math.sin(angle) * targetSpeedMagnitude;
                } else {
                    const scaleRatio = targetSpeedMagnitude / currentSpeedMagnitude;
                    ball.speedX *= scaleRatio;
                    ball.speedY *= scaleRatio;
                }
            });
        }

        function updateGayLussacPressureDisplay(tempCelsius) {
            const KELVIN_OFFSET = 273.15;
            // Assuming initial pressure is 1.0 atm at 0Â°C (273.15 K)
            const initialTempK = KELVIN_OFFSET;
            const currentTempK = tempCelsius + KELVIN_OFFSET;
            const pressureValue = (currentTempK / initialTempK) * 1.0;
            gayLussacPressureVal.textContent = pressureValue.toFixed(2);
        }


        function animateGayLussac() {
            const container = gayLussacCanvas.parentElement;
            const newCanvasWidth = container.clientWidth - 40;
            const newCanvasHeight = container.clientHeight - 40;

            if (gayLussacCanvas.width !== newCanvasWidth || gayLussacCanvas.height !== newCanvasHeight) {
                gayLussacCanvas.width = newCanvasWidth;
                gayLussacCanvas.height = newCanvasHeight;
                gayLussacBalls.forEach(ball => {
                    ball.x = Math.max(ball.radius, Math.min(ball.x, gayLussacCanvas.width - ball.radius));
                    ball.y = Math.max(ball.radius, Math.min(ball.y, gayLussacCanvas.height - ball.radius));
                });
            }

            gCtx.clearRect(0, 0, gayLussacCanvas.width, gayLussacCanvas.height);

            gayLussacBalls.forEach(ball => {
                ball.x += ball.speedX;
                ball.y += ball.speedY;
            });

            gayLussacBalls.forEach(ball => {
                if (ball.x + ball.radius > gayLussacCanvas.width) { ball.x = gayLussacCanvas.width - ball.radius; ball.speedX *= -1; }
                if (ball.x - ball.radius < 0) { ball.x = ball.radius; ball.speedX *= -1; }
                if (ball.y + ball.radius > gayLussacCanvas.height) { ball.y = gayLussacCanvas.height - ball.radius; ball.speedY *= -1; }
                if (ball.y - ball.radius < 0) { ball.y = ball.radius; ball.speedY *= -1; }
            });

            // *** COMMENTED OUT TO DISABLE BALL-TO-BALL COLLISIONS ***
            /*
            const numCollisionIterations = 3;
            for (let k = 0; k < numCollisionIterations; k++) {
                for (let i = 0; i < gayLussacBalls.length; i++) {
                    for (let j = i + 1; j < gayLussacBalls.length; j++) {
                        resolveBoyleCollision(gayLussacBalls[i], gayLussacBalls[j]);
                    }
                }
            }
            */

            gayLussacBalls.forEach(ball => {
                gCtx.fillStyle = ball.color;
                gCtx.beginPath();
                gCtx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                gCtx.fill();
                gCtx.closePath(); // Ensure path is closed
            });
            gayLussacAnimId = requestAnimationFrame(animateGayLussac);
        }

        function cancelGayLussacAnimation() {
            if (gayLussacAnimId) cancelAnimationFrame(gayLussacAnimId);
            gayLussacAnimId = null;
        }

        gayLussacTempSlider.oninput = () => {
            const temp = parseInt(gayLussacTempSlider.value);
            gayLussacTempVal.textContent = temp;
            updateGayLussacSpeeds();
            updateGayLussacPressureDisplay(temp);
        };

        // === AVOGADRO MODE ===
        const avogadroBalloon = document.getElementById('avogadroBalloon');
        const avogadroMoleculeBg = document.getElementById('avogadroMoleculeBg');
        const avogadroTopLeftCounter = document.getElementById('avogadroTopLeftCounter');
        const increaseMoleculeBtn = document.getElementById('increaseMoleculeBtn');
        const getNewOneBtn = document.getElementById('getNewOneBtn');
        const popSound = document.getElementById('popSound');

        let avogadroMolecules = 0;
        const MAX_MOLECULES = 20; // The number of molecules at which the balloon pops
        const INITIAL_BALLOON_WIDTH = 100;
        const INITIAL_BALLOON_HEIGHT = 150;
        const WIDTH_INCREMENT_PER_MOLECULE = 6; // How much width increases per molecule
        const HEIGHT_INCREMENT_PER_MOLECULE = 9; // How much height increases per molecule
        let avogadroPopTimeout; // To clear any pending pop animations

        function initAvogadro() {
            avogadroMolecules = 0; // Reset molecules when entering the mode
            updateAvogadroDisplay();
            // Reset balloon's appearance for a new simulation
            avogadroBalloon.classList.remove('pop'); // Ensure no pop animation remains
            avogadroBalloon.style.width = INITIAL_BALLOON_WIDTH + 'px';
            avogadroBalloon.style.height = INITIAL_BALLOON_HEIGHT + 'px';
            avogadroBalloon.style.background = 'radial-gradient(circle at 25% 25%, #ffbaba, #ff7a7f 30%, #ff5a5f 60%, #cc0000 100%)';
            avogadroBalloon.style.boxShadow = '0 8px 20px rgba(0,0,0,0.4)';
            avogadroBalloon.style.display = 'block'; // Make sure balloon is visible
            increaseMoleculeBtn.style.display = 'block'; // Show "Increase Molecules" button
            getNewOneBtn.style.display = 'none'; // Hide "GET NEW ONE!!!" button
            clearTimeout(avogadroPopTimeout); // Clear any lingering pop timeouts to prevent unexpected behavior
        }

        function updateAvogadroDisplay() {
            avogadroTopLeftCounter.textContent = `Molecules: ${avogadroMolecules}`;
            avogadroMoleculeBg.textContent = avogadroMolecules;

            let targetWidth = INITIAL_BALLOON_WIDTH + (avogadroMolecules * WIDTH_INCREMENT_PER_MOLECULE);
            let targetHeight = INITIAL_BALLOON_HEIGHT + (avogadroMolecules * HEIGHT_INCREMENT_PER_MOLECULE);

            // Cap the size at the maximum before pop for visual consistency
            if (avogadroMolecules >= MAX_MOLECULES) {
                targetWidth = INITIAL_BALLOON_WIDTH + (MAX_MOLECULES * WIDTH_INCREMENT_PER_MOLECULE);
                targetHeight = INITIAL_BALLOON_HEIGHT + (MAX_MOLECULES * HEIGHT_INCREMENT_PER_MOLECULE);
            }
            
            avogadroBalloon.style.width = targetWidth + 'px';
            avogadroBalloon.style.height = targetHeight + 'px';
        }

        function addMolecules() {
            if (avogadroMolecules < MAX_MOLECULES) {
                avogadroMolecules++;
                updateAvogadroDisplay();
                if (avogadroMolecules === MAX_MOLECULES) {
                    popBalloon();
                }
            }
        }

        function popBalloon() {
            if (popSound) {
                popSound.currentTime = 0; // Rewind to start, so sound plays every time
                popSound.play().catch(e => console.error("Error playing pop sound:", e));
            }
            avogadroBalloon.classList.add('pop'); // Trigger the pop animation
            increaseMoleculeBtn.style.display = 'none'; // Hide "Increase Molecules" button
            getNewOneBtn.style.display = 'block'; // Show "GET NEW ONE!!!" button

            // Hide the balloon after the animation finishes
            avogadroPopTimeout = setTimeout(() => {
                avogadroBalloon.style.display = 'none';
            }, 600); // Matches the animation duration (0.6s) defined in CSS
        }

        // Function to cancel ongoing Avogadro animations/state when switching modes
        function cancelAvogadroIncrease() {
            clearTimeout(avogadroPopTimeout); // Clear any scheduled pop hiding
            avogadroBalloon.classList.remove('pop'); // Remove pop class
            avogadroBalloon.style.display = 'block'; // Ensure balloon is visible if we come back later
            increaseMoleculeBtn.style.display = 'block'; // Show "Increase Molecules"
            getNewOneBtn.style.display = 'none'; // Hide "GET NEW ONE!!!"
        }

        // Event listeners for the Avogadro mode buttons
        increaseMoleculeBtn.addEventListener('click', addMolecules);
        getNewOneBtn.addEventListener('click', initAvogadro); // Re-initialize for a new balloon simulation
    </script>
</body>
</html>
