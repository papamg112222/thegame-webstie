import React, { useState, useEffect } from 'react';
import { HomeIcon, UserIcon, MailIcon, SparklesIcon, QrCodeIcon, ExternalLinkIcon, LockIcon, SettingsIcon, ScissorsIcon } from './components/Icons';
import { removeBackgroundSmart } from './utils/imageProcessing';

// --- Types ---
enum Tab {
  HOME = 'HOME',
  ABOUT = 'ABOUT',
  CONTACT = 'CONTACT'
}

type NavItem = {
    id: Tab;
    label: string;
    icon: React.FC<{ size?: number; className?: string }>;
};

// --- Components ---

const Navigation = ({ activeTab, onTabChange, isVisible }: { activeTab: Tab, onTabChange: (t: Tab) => void, isVisible: boolean }) => {
  const navItems: NavItem[] = [
    { id: Tab.HOME, label: 'Home', icon: HomeIcon },
    { id: Tab.ABOUT, label: 'About', icon: UserIcon },
    { id: Tab.CONTACT, label: 'Contact', icon: MailIcon },
  ];

  return (
    <div 
      className={`transition-all duration-1000 ease-out transform ${
        isVisible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-10'
      } flex justify-center w-full mt-6`}
    >
      <div className="flex space-x-2 bg-white/70 backdrop-blur-xl border border-zinc-200 p-2 rounded-full shadow-xl shadow-indigo-100/50">
        {navItems.map((item) => {
          const Icon = item.icon;
          const isActive = activeTab === item.id;
          
          return (
            <button
              key={item.id}
              onClick={() => onTabChange(item.id)}
              className={`
                relative px-6 py-2 rounded-full text-sm font-medium transition-all duration-300 flex items-center gap-2
                ${isActive 
                  ? 'bg-zinc-900 text-white shadow-lg scale-105' 
                  : 'text-zinc-500 hover:text-zinc-900 hover:bg-white'}
              `}
            >
              <Icon size={16} />
              <span>{item.label}</span>
            </button>
          );
        })}
      </div>
    </div>
  );
};

const ContactCard = () => {
  const handleLineClick = () => {
    window.open('https://line.me/ti/p/~arm42.rst', '_blank');
  };

  return (
    <div className="w-full max-w-md mx-auto animate-slide-up mt-12">
      <div className="bg-white/80 border border-zinc-200 rounded-2xl p-8 backdrop-blur-lg shadow-2xl shadow-zinc-200/50">
        <h2 className="text-2xl font-bold text-zinc-900 mb-6 flex items-center gap-2">
          <span className="bg-zinc-100 p-2 rounded-lg text-zinc-900"><UserIcon size={20} /></span>
          Contact Information
        </h2>

        <div className="space-y-6">
          <div className="group">
            <label className="text-xs font-bold text-zinc-400 uppercase tracking-wider mb-1 block">Name</label>
            <div className="text-lg text-zinc-800 font-semibold group-hover:text-zinc-950 transition-colors">
              T.Aphilak Kapangnoy
            </div>
          </div>

          <div className="group">
            <label className="text-xs font-bold text-zinc-400 uppercase tracking-wider mb-1 block">Email</label>
            <a 
              href="mailto:arm.rst2542@gmail.com" 
              className="flex items-center gap-2 text-lg text-zinc-700 font-medium hover:text-blue-600 transition-colors"
            >
              <MailIcon size={18} />
              arm.rst2542@gmail.com
            </a>
          </div>

          <div className="h-px bg-zinc-100 my-6"></div>

          <div className="space-y-3">
             <label className="text-xs font-bold text-zinc-400 uppercase tracking-wider block">
               Instant Messaging
             </label>
             <div className="bg-slate-50 rounded-xl p-4 border border-zinc-100 flex flex-col items-center text-center space-y-4">
                <div className="bg-white p-2 rounded-lg border border-zinc-100 shadow-sm">
                   <QrCodeIcon size={64} className="text-zinc-900" />
                </div>
                <div className="space-y-1">
                    <p className="text-zinc-600 text-sm">Line ID: <span className="text-zinc-900 font-mono font-bold">arm42.rst</span></p>
                    <p className="text-xs text-zinc-400">Scan QR or click below to chat</p>
                </div>
                
                <button 
                  onClick={handleLineClick}
                  className="w-full bg-[#06C755] hover:bg-[#05b34c] text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 shadow-lg shadow-green-500/20 flex items-center justify-center gap-2 group"
                >
                  <span>Chat on Line</span>
                  <ExternalLinkIcon size={16} className="group-hover:translate-x-1 transition-transform" />
                </button>
             </div>
          </div>
        </div>
      </div>
    </div>
  );
};

const HeaderSection = ({ introPhase, activeTab, onTabChange }: { introPhase: string, activeTab: Tab, onTabChange: (t: Tab) => void }) => {
    // Determine dynamic classes for the header transition
    const isStarted = introPhase !== 'start';
    
    return (
        <div 
            className={`
                relative w-full overflow-hidden transition-all duration-[2000ms] cubic-bezier(0.16, 1, 0.3, 1) rounded-b-[40px] shadow-sm
                ${isStarted ? 'h-auto py-12 bg-indigo-50/80 border-b border-indigo-100/50' : 'h-screen flex flex-col justify-center items-center bg-transparent'}
            `}
        >
            {/* Playful Background Elements specifically for this section */}
            <div className="absolute inset-0 overflow-hidden pointer-events-none">
                <div className={`absolute top-0 left-1/4 w-64 h-64 bg-yellow-200/40 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob ${!isStarted ? 'scale-150' : ''}`} />
                <div className={`absolute top-0 right-1/4 w-64 h-64 bg-pink-200/40 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-2000 ${!isStarted ? 'scale-150' : ''}`} />
                <div className={`absolute -bottom-8 left-1/2 -translate-x-1/2 w-64 h-64 bg-purple-200/40 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-4000 ${!isStarted ? 'scale-150' : ''}`} />
            </div>

            <div className={`relative z-10 w-full flex flex-col items-center justify-center transition-all duration-[2000ms] ${isStarted ? 'translate-y-0' : 'translate-y-[10vh]'}`}>
                <h1 
                  className={`
                    font-bold text-zinc-900 text-center
                    transition-all duration-[2000ms] cubic-bezier(0.16, 1, 0.3, 1)
                    ${isStarted ? 'text-4xl md:text-5xl tracking-tight' : 'text-5xl md:text-8xl tracking-tighter'}
                  `}
                >
                  Welcome, to Army Website
                </h1>

                <Navigation 
                  activeTab={activeTab} 
                  onTabChange={onTabChange} 
                  isVisible={isStarted}
                />
            </div>
        </div>
    );
};

const App = () => {
  const [introPhase, setIntroPhase] = useState('start');
  const [activeTab, setActiveTab] = useState(Tab.HOME);

  // About / Image State
  const [base64Input, setBase64Input] = useState('');
  const [renderedImage, setRenderedImage] = useState<string | null>(null);
  const [showReset, setShowReset] = useState(false);
  
  // Cut Logic
  const [showStyleSelector, setShowStyleSelector] = useState(false);
  const [pendingImage, setPendingImage] = useState<string | null>(null);
  const [isProcessing, setIsProcessing] = useState(false);

  // Home Slider State
  const [homeImages, setHomeImages] = useState<string[]>(Array(5).fill(''));
  const [isEditingHome, setIsEditingHome] = useState(false);
  const [currentSlide, setCurrentSlide] = useState(0);

  // Password Modal State
  const [showPasswordModal, setShowPasswordModal] = useState(false);
  const [passwordInput, setPasswordInput] = useState('');
  const [passwordError, setPasswordError] = useState(false);
  
  // Track what action requires the password
  const [pendingAction, setPendingAction] = useState< 'RESET_PROFILE' | 'EDIT_HOME' | null>(null);

  // Load saved data on startup
  useEffect(() => {
    const savedImage = localStorage.getItem('army_profile_pic');
    if (savedImage) setRenderedImage(savedImage);

    const savedHome = localStorage.getItem('army_home_images');
    if (savedHome) {
      setHomeImages(JSON.parse(savedHome));
    } else {
      setIsEditingHome(true);
    }
  }, []);

  useEffect(() => {
    const timer1 = setTimeout(() => setIntroPhase('transition'), 100); 
    const timer2 = setTimeout(() => setIntroPhase('finished'), 2100);
    return () => {
      clearTimeout(timer1);
      clearTimeout(timer2);
    };
  }, []);

  // Slider Timer - Horizontal Loop
  useEffect(() => {
    const validImages = homeImages.filter(img => img && img.trim().length > 0);
    if (activeTab === Tab.HOME && !isEditingHome && validImages.length > 1) {
       const timer = setInterval(() => {
          setCurrentSlide(prev => (prev + 1) % validImages.length);
       }, 3000); // 3 seconds per slide
       return () => clearInterval(timer);
    }
  }, [activeTab, isEditingHome, homeImages]);

  // --- About Logic ---
  const handleImageInput = () => {
    if (!base64Input.trim()) return;
    let finalSrc = base64Input.trim();
    if (!finalSrc.startsWith('data:')) finalSrc = `data:image/png;base64,${finalSrc}`;
    
    setPendingImage(finalSrc);
    setShowStyleSelector(true);
  };

  const processImage = async (mode: 'NORMAL' | 'CUT') => {
    if (!pendingImage) return;

    if (mode === 'NORMAL') {
        setRenderedImage(pendingImage);
        localStorage.setItem('army_profile_pic', pendingImage);
        finalizeImageProcess();
    } else {
        setIsProcessing(true);
        try {
            // Using logic to detect top-left pixel color and remove similar pixels
            const processed = await removeBackgroundSmart(pendingImage);
            setRenderedImage(processed);
            localStorage.setItem('army_profile_pic', processed);
        } catch (e) {
            console.error("Failed to cut background", e);
            alert("Could not process image automatically. Using original.");
            setRenderedImage(pendingImage);
            localStorage.setItem('army_profile_pic', pendingImage);
        } finally {
            setIsProcessing(false);
            finalizeImageProcess();
        }
    }
  };

  const finalizeImageProcess = () => {
    setShowStyleSelector(false);
    setPendingImage(null);
    setShowReset(false);
    setBase64Input(''); 
  };

  const handleResetRequest = () => {
    setPendingAction('RESET_PROFILE');
    setShowPasswordModal(true);
  };

  // --- Home Logic ---
  const handleHomeImageChange = (index: number, value: string) => {
    const newImages = [...homeImages];
    newImages[index] = value;
    setHomeImages(newImages);
  };

  const saveHomeImages = () => {
    localStorage.setItem('army_home_images', JSON.stringify(homeImages));
    setIsEditingHome(false);
    setCurrentSlide(0);
  };

  const requestEditHome = () => {
    setPendingAction('EDIT_HOME');
    setShowPasswordModal(true);
  };

  // --- Password Logic ---
  const confirmReset = (e: React.FormEvent) => {
    e.preventDefault();
    if (passwordInput === '1090') {
      if (pendingAction === 'RESET_PROFILE') {
        setRenderedImage(null);
        localStorage.removeItem('army_profile_pic');
        setShowReset(false);
      } else if (pendingAction === 'EDIT_HOME') {
        setIsEditingHome(true);
      }
      
      // Clean up modal
      setShowPasswordModal(false);
      setPasswordInput('');
      setPasswordError(false);
      setPendingAction(null);
    } else {
      setPasswordError(true);
      setTimeout(() => setPasswordError(false), 500); 
    }
  };

  const closePasswordModal = () => {
    setShowPasswordModal(false);
    setPasswordInput('');
    setPasswordError(false);
    setPendingAction(null);
  };

  const handleTabChange = (tab: Tab) => {
    setActiveTab(tab);
    setShowReset(false);
  };

  const renderContent = () => {
    switch (activeTab) {
      case Tab.HOME:
        if (isEditingHome) {
           return (
            <div className="animate-slide-up max-w-4xl mx-auto space-y-6 mt-8">
              <div className="text-center mb-8">
                 <h3 className="text-xl font-bold text-zinc-900">Setup Home Slider</h3>
                 <p className="text-zinc-500 text-sm">Paste Base64 strings for the 5 sliding images.</p>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {homeImages.map((img, index) => (
                  <div key={index} className="space-y-2">
                     <label className="text-xs font-bold text-zinc-400">Image {index + 1}</label>
                     <textarea 
                       value={img}
                       onChange={(e) => handleHomeImageChange(index, e.target.value)}
                       className="w-full h-20 p-2 text-[10px] font-mono border rounded-lg bg-white resize-none focus:ring-2 focus:ring-zinc-900 outline-none"
                       placeholder={`Base64 for Image ${index+1}`}
                     />
                  </div>
                ))}
              </div>
              <div className="flex justify-center pt-4">
                 <button 
                   onClick={saveHomeImages}
                   className="px-8 py-3 bg-zinc-900 text-white rounded-full font-bold shadow-lg hover:scale-105 transition-transform"
                 >
                   Save & Launch Slider
                 </button>
              </div>
            </div>
           );
        }

        // The Frame/Slider View
        const validImages = homeImages.filter(src => src && src.trim() !== '');
        const hasImages = validImages.length > 0;

        return (
          <div className="animate-slide-up w-full space-y-8 mt-8">
            <div className="max-w-2xl mx-auto text-center space-y-4">
               <div className="inline-flex items-center justify-center p-3 bg-white rounded-full shadow-sm ring-1 ring-zinc-200">
                  <SparklesIcon className="text-amber-500 mr-2" size={20} />
                  <span className="text-zinc-600 text-sm font-medium">Welcome to my professional portfolio</span>
               </div>
            </div>

            {/* Slim Rectangle Slider Container Frame - Horizontal Swipe */}
            <div className="relative w-full max-w-4xl mx-auto h-64 md:h-80 bg-zinc-900 rounded-3xl overflow-hidden shadow-2xl ring-4 ring-white border border-zinc-200">
              {hasImages ? (
                <div 
                  className="absolute inset-0 flex flex-row transition-transform duration-700 ease-in-out h-full"
                  style={{ 
                    width: `${validImages.length * 100}%`,
                    transform: `translateX(-${(currentSlide / validImages.length) * 100}%)` 
                  }}
                >
                  {validImages.map((src, index) => {
                     let finalSrc = src.trim();
                     if (!finalSrc.startsWith('data:')) finalSrc = `data:image/png;base64,${finalSrc}`;
                     
                     return (
                        <div 
                          key={index} 
                          className="h-full relative flex-shrink-0 overflow-hidden" 
                          style={{ width: `${100 / validImages.length}%` }}
                        >
                          {/* Blurred Background for fit adjustment */}
                          <div 
                            className="absolute inset-0 bg-cover bg-center opacity-40 blur-2xl scale-125"
                            style={{ backgroundImage: `url(${finalSrc})` }}
                          ></div>
                          {/* Main Image - Object Cover for slim rectangle look */}
                          <div className="absolute inset-0 flex items-center justify-center p-0">
                             <img src={finalSrc} alt="" className="w-full h-full object-cover" />
                          </div>
                        </div>
                     );
                  })}
                </div>
              ) : (
                <div className="absolute inset-0 flex flex-col items-center justify-center text-zinc-400 bg-zinc-50">
                  <span className="mb-2">No images configured</span>
                  <span className="text-xs">Click settings to add content</span>
                </div>
              )}
              
              {/* Frame Glare/Shadow Effect */}
              <div className="absolute inset-0 pointer-events-none shadow-[inset_0_0_50px_rgba(0,0,0,0.5)] z-20"></div>
              
              {/* Horizontal Indicators (Bottom Center) */}
              {hasImages && validImages.length > 1 && (
                 <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 z-30">
                    {validImages.map((_, idx) => (
                       <div 
                         key={idx} 
                         className={`h-1.5 rounded-full transition-all duration-300 shadow-sm ${currentSlide === idx ? 'w-8 bg-white' : 'w-2 bg-white/50'}`}
                       ></div>
                    ))}
                 </div>
              )}
            </div>

            {/* Edit Button */}
            <div className="flex justify-center mt-4">
              <button 
                onClick={requestEditHome}
                className="flex items-center gap-2 text-zinc-400 hover:text-zinc-900 text-xs font-semibold uppercase tracking-wider transition-colors px-4 py-2 rounded-full hover:bg-white/50"
              >
                <SettingsIcon size={14} />
                Manage Slider
              </button>
            </div>
          </div>
        );

      case Tab.ABOUT:
        if (renderedImage) {
          return (
            <div className="animate-slide-up flex flex-col items-center min-h-[50vh] justify-center mt-8">
               <img
                  src={renderedImage}
                  alt="Rendered Content"
                  className="max-w-full max-h-[60vh] rounded-xl shadow-2xl cursor-pointer hover:scale-[1.01] transition-transform duration-300 ring-4 ring-white/50"
                  onClick={() => setShowReset(true)}
               />
               <p className="mt-4 text-xs text-zinc-400">Tap image to show reset option</p>
            </div>
          );
        }
        return (
          <div className="animate-slide-up max-w-4xl mx-auto text-center py-12 px-8 border-2 border-dashed border-zinc-300 rounded-3xl bg-white/50 backdrop-blur-sm mt-8">
            <h3 className="text-xl font-bold text-zinc-800 mb-4">Insert Base64</h3>
            <p className="text-zinc-500 text-sm mb-6">Paste your image data below to render it.</p>
            
            {/* Rectangular Input */}
            <textarea
                value={base64Input}
                onChange={(e) => setBase64Input(e.target.value)}
                placeholder="Paste base64 string here..."
                className="w-full h-32 md:h-48 p-4 rounded-xl border border-zinc-200 bg-white focus:ring-2 focus:ring-zinc-400 focus:border-transparent outline-none resize-none text-xs font-mono text-zinc-600 mb-6 shadow-inner"
            />
            
            <button 
                onClick={handleImageInput}
                disabled={!base64Input}
                className="px-8 py-3 bg-zinc-900 text-white rounded-full font-semibold hover:bg-zinc-800 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl active:scale-95"
            >
                Preview & Process
            </button>
          </div>
        );
      case Tab.CONTACT:
        return <ContactCard />;
      default:
        return null;
    }
  };

  return (
    <div className="min-h-screen w-full bg-slate-50 text-zinc-900 selection:bg-black selection:text-white overflow-hidden relative">
      
      {/* Background Mode Selection Modal */}
      {showStyleSelector && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
             <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md relative overflow-hidden">
                <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-purple-500"></div>
                <h3 className="text-2xl font-bold text-center mb-6 text-zinc-900">Choose Style</h3>
                
                {isProcessing ? (
                    <div className="flex flex-col items-center py-8">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-zinc-900 mb-4"></div>
                        <p className="text-sm text-zinc-500">Processing background...</p>
                    </div>
                ) : (
                    <div className="grid grid-cols-2 gap-4">
                        <button 
                            onClick={() => processImage('NORMAL')}
                            className="flex flex-col items-center justify-center p-6 border-2 border-zinc-100 rounded-2xl hover:border-zinc-300 hover:bg-zinc-50 transition-all group"
                        >
                            <div className="w-12 h-12 bg-zinc-200 rounded-lg mb-3 flex items-center justify-center group-hover:bg-white shadow-sm">
                                <UserIcon className="text-zinc-500" />
                            </div>
                            <span className="font-bold text-zinc-700">Normal</span>
                            <span className="text-xs text-zinc-400 mt-1">Keep original</span>
                        </button>

                        <button 
                            onClick={() => processImage('CUT')}
                            className="flex flex-col items-center justify-center p-6 border-2 border-indigo-100 rounded-2xl hover:border-indigo-300 hover:bg-indigo-50 transition-all group"
                        >
                            <div className="w-12 h-12 bg-indigo-100 rounded-lg mb-3 flex items-center justify-center group-hover:bg-white shadow-sm">
                                <ScissorsIcon className="text-indigo-600" />
                            </div>
                            <span className="font-bold text-indigo-700">Auto Cut</span>
                            <span className="text-xs text-indigo-400 mt-1">Smart Remove</span>
                        </button>
                    </div>
                )}
                
                {!isProcessing && (
                    <button 
                        onClick={() => setShowStyleSelector(false)}
                        className="mt-6 w-full py-2 text-zinc-400 hover:text-zinc-600 text-sm font-medium"
                    >
                        Cancel
                    </button>
                )}
             </div>
        </div>
      )}

      {/* Password Modal */}
      {showPasswordModal && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
          <div className={`bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm ${passwordError ? 'animate-shake' : ''}`}>
            <h3 className="text-lg font-bold text-zinc-900 mb-4 flex items-center gap-2">
              <LockIcon size={20} className="text-red-500"/>
              Security Verification
            </h3>
            <p className="text-sm text-zinc-500 mb-4">
              {pendingAction === 'RESET_PROFILE' ? 'Enter code to delete profile image.' : 'Enter code to edit slider.'}
            </p>
            
            <form onSubmit={confirmReset}>
              <input
                type="password"
                autoFocus
                placeholder="Enter Password"
                value={passwordInput}
                onChange={(e) => setPasswordInput(e.target.value)}
                className="w-full p-3 rounded-lg border border-zinc-200 bg-zinc-50 focus:ring-2 focus:ring-zinc-900 outline-none mb-4 text-center font-mono tracking-widest"
              />
              <div className="flex gap-2">
                <button 
                  type="button" 
                  onClick={closePasswordModal}
                  className="flex-1 py-2 text-zinc-600 font-medium hover:bg-zinc-100 rounded-lg transition-colors"
                >
                  Cancel
                </button>
                <button 
                  type="submit"
                  className="flex-1 py-2 bg-red-500 hover:bg-red-600 text-white font-medium rounded-lg transition-colors shadow-md"
                >
                  Confirm
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Reset Button (Only for Profile) */}
      {showReset && activeTab === Tab.ABOUT && renderedImage && !showPasswordModal && !showStyleSelector && (
        <button
          onClick={handleResetRequest}
          className="fixed top-6 right-6 z-50 bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-full font-bold shadow-lg transition-all animate-fade-in hover:shadow-red-500/30 active:scale-95"
        >
          Reset
        </button>
      )}

      {/* Main Body Background (Minimal/Clean) */}
      <div className="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
        <div className="absolute top-[20%] right-[-10%] w-[500px] h-[500px] bg-slate-200/50 rounded-full mix-blend-multiply filter blur-3xl opacity-50" />
        <div className="absolute bottom-[-10%] left-[-10%] w-[600px] h-[600px] bg-zinc-200/50 rounded-full mix-blend-multiply filter blur-3xl opacity-50" />
      </div>

      <div className="relative z-10 flex flex-col items-center w-full min-h-screen pb-12">
        {/* New Header Section with dedicated Playful Background */}
        <HeaderSection 
            introPhase={introPhase} 
            activeTab={activeTab} 
            onTabChange={handleTabChange} 
        />

        <main className={`
          w-full max-w-4xl transition-opacity duration-1000 delay-200 px-4
          ${introPhase !== 'start' ? 'opacity-100' : 'opacity-0 pointer-events-none'}
        `}>
          {renderContent()}
        </main>

        <footer className={`
           fixed bottom-4 text-center w-full text-zinc-400 text-xs transition-opacity duration-1000 delay-500
           ${introPhase === 'finished' ? 'opacity-100' : 'opacity-0'}
        `}>
          Â© {new Date().getFullYear()} Army Website. All rights reserved.
        </footer>
      </div>
    </div>
  );
};

export default App;
