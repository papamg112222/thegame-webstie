<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create the Virus - Architect Edition [ULTRA]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&family=Share+Tech+Mono&display=swap');

        :root {
            --primary: #00ff41;
            --secondary: #008F11;
            --accent: #cdfc93;
            --danger: #ff3333;
            --bg-dark: #020402;
            --glass: rgba(0, 20, 0, 0.6);
            --border-glow: 0 0 10px rgba(0, 255, 65, 0.3);
        }

        /* --- GLOBAL SCROLL & LAYOUT --- */
        body {
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--primary);
            font-family: 'Share Tech Mono', monospace;
            background-image: 
                radial-gradient(circle at 50% 50%, #051a05 0%, #000000 100%);
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll */
            overflow-y: auto;   /* Allow vertical scroll */
        }

        /* --- CRT & SCANLINE FX --- */
        .crt::before {
            content: " ";
            display: block; position: fixed; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 999; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }
        
        .scanline {
            width: 100%; height: 100px; z-index: 998;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(0, 255, 65, 0.04) 50%, rgba(0,0,0,0) 100%);
            opacity: 0.1; position: fixed; bottom: 100%; pointer-events: none;
            animation: scanline 10s linear infinite;
        }
        @keyframes scanline { 0% { bottom: 100%; } 100% { bottom: -100px; } }

        #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.3; pointer-events: none; }

        /* --- SCREENS --- */
        #introScreen, #gameScreen {
            position: relative; /* Changed from fixed to allow scrolling */
            width: 100%; min-height: 100vh; z-index: 10;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s ease;
            padding: 40px 20px; box-sizing: border-box;
        }

        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        /* --- INTRO TYPOGRAPHY --- */
        h1 {
            font-family: 'Orbitron', sans-serif; font-weight: 900; 
            font-size: clamp(2.5rem, 8vw, 6rem); /* Responsive font */
            color: #fff;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.8), 2px 2px 0px var(--danger);
            margin-bottom: 0.5rem; text-align: center; letter-spacing: 5px; text-transform: uppercase;
            position: relative;
        }
        
        .glitch-text { animation: textGlitch 3s infinite; }
        @keyframes textGlitch {
            0% { transform: translate(0); text-shadow: 2px 2px 0px var(--danger); }
            2% { transform: translate(-2px, 2px); text-shadow: -2px -2px 0px var(--primary); }
            4% { transform: translate(2px, -2px); text-shadow: 2px 2px 0px var(--danger); }
            6% { transform: translate(0); text-shadow: 2px 2px 0px var(--danger); }
            100% { transform: translate(0); }
        }

        #bootLog {
            font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; color: #444;
            width: 300px; height: 150px; overflow: hidden; margin-bottom: 20px;
            border-left: 1px solid #333; padding-left: 10px; display: flex; flex-direction: column; justify-content: flex-end;
        }
        .log-line { color: #004400; margin: 1px 0; }
        .log-success { color: var(--primary); }
        .log-warn { color: #aaaa00; }

        .btn-start {
            background: rgba(0, 20, 0, 0.8); border: 1px solid var(--primary); color: var(--primary);
            padding: 1.5rem 5rem; font-size: 1.2rem; cursor: pointer;
            font-family: 'Orbitron', sans-serif; text-transform: uppercase; letter-spacing: 4px;
            transition: all 0.3s; position: relative; overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.1); opacity: 0; transform: translateY(20px);
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }
        .btn-start.visible { opacity: 1; transform: translateY(0); animation: float 4s ease-in-out infinite; }
        .btn-start:hover { background: var(--primary); color: #000; box-shadow: 0 0 60px rgba(0, 255, 65, 0.4); }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* --- GAME UI PANELS --- */
        .grid-bg {
            background-image: linear-gradient(rgba(0, 255, 65, 0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 255, 65, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .control-panel {
            background: var(--glass); border: 1px solid rgba(0, 255, 65, 0.2);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: 30px; width: 100%; max-width: 900px;
            display: flex; flex-direction: column; gap: 20px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8), inset 0 0 20px rgba(0, 50, 0, 0.3);
            position: relative; margin-top: 20px;
            border-radius: 2px;
        }
        /* Tech Corners */
        .corner { position: absolute; width: 15px; height: 15px; border: 2px solid var(--primary); transition: all 0.3s; pointer-events: none; }
        .c-tl { top: -1px; left: -1px; border-right: none; border-bottom: none; }
        .c-tr { top: -1px; right: -1px; border-left: none; border-bottom: none; }
        .c-bl { bottom: -1px; left: -1px; border-right: none; border-top: none; }
        .c-br { bottom: -1px; right: -1px; border-left: none; border-top: none; }

        /* Inputs */
        .select-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .input-wrapper { position: relative; }
        label { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.9rem; color: #698f6e; margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 2px; }
        select {
            background: rgba(0, 10, 0, 0.8); color: #fff; border: 1px solid #1a331a; padding: 15px;
            font-family: 'Share Tech Mono', monospace; width: 100%; cursor: pointer; font-size: 1rem; 
            transition: all 0.3s; appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300ff41%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 1rem center; background-size: 0.8em;
        }
        select:hover { border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 255, 65, 0.1); }
        select:focus { outline: none; border-color: var(--primary); background-color: #001a05; box-shadow: 0 0 20px rgba(0, 255, 65, 0.2); }

        /* Actions */
        .action-group { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 10px; }
        .btn-action {
            padding: 18px; font-weight: 700; font-family: 'Orbitron', sans-serif; font-size: 1.1rem;
            cursor: pointer; text-transform: uppercase; border: none;
            transition: all 0.2s; letter-spacing: 2px; position: relative; overflow: hidden;
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
        }
        /* Fancy Glitch Effect on buttons */
        .btn-action::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: skewX(-25deg); transition: 0.5s;
        }
        .btn-action:hover::after { left: 150%; }

        .btn-create { background: #003300; border: 1px solid var(--primary); color: var(--primary); }
        .btn-create:hover { background: var(--primary); color: #000; box-shadow: 0 0 30px var(--primary); }
        
        .btn-ignite { background: #220000; border: 1px solid var(--danger); color: var(--danger); }
        .btn-ignite:hover { background: var(--danger); color: #000; box-shadow: 0 0 30px var(--danger); }

        .btn-preview {
            background: rgba(0, 100, 200, 0.1); color: #00ffff; border: 1px solid rgba(0, 255, 255, 0.3);
            margin-top: 15px; width: 100%; padding: 15px; font-family: 'Rajdhani'; font-weight: bold; font-size: 1.2rem;
            cursor: pointer; text-transform: uppercase; letter-spacing: 3px; transition: 0.2s;
            clip-path: polygon(0 0, 100% 0, 99% 100%, 1% 100%); opacity: 0.3; pointer-events: none;
        }
        .btn-preview.active { opacity: 1; pointer-events: auto; }
        .btn-preview:hover { background: rgba(0, 255, 255, 0.2); box-shadow: 0 0 20px rgba(0, 255, 255, 0.2); border-color: #00ffff; }

        /* --- THE STAGE --- */
        #virusStageWrapper {
            position: relative; margin-bottom: 30px; 
            padding: 5px; border: 1px solid #111;
            background: linear-gradient(135deg, #111 0%, #000 100%);
            box-shadow: 0 0 40px rgba(0,0,0,1);
        }
        #virusStage {
            width: 360px; height: 360px;
            background: #000;
            position: relative; display: flex; align-items: center; justify-content: center;
            overflow: hidden;
            background-image: 
                radial-gradient(circle at center, #051005 0%, #000 70%);
        }
        #virusCanvas { 
            filter: drop-shadow(0 0 15px rgba(0,0,0,0.8)); 
            z-index: 2;
        }
        /* Animated Stage Elements */
        .stage-grid {
            position: absolute; top:0; left:0; width: 100%; height: 100%; opacity: 0.2;
            background-size: 40px 40px;
            background-image: linear-gradient(to right, #003300 1px, transparent 1px), linear-gradient(to bottom, #003300 1px, transparent 1px);
            z-index: 1; pointer-events: none;
        }

        /* --- READOUT --- */
        .data-readout {
            min-height: 180px; background: rgba(0,0,0,0.5); border-left: 2px solid var(--secondary);
            padding: 20px; font-size: 0.9rem; color: #bbb; display: grid; gap: 10px;
            font-family: 'Share Tech Mono'; position: relative;
        }
        .data-readout::before { content: "ANALYSIS_BUFFER"; position: absolute; top: -10px; right: 0; font-size: 0.6rem; color: #333; background: var(--primary); padding: 0 5px; color: #000; font-weight: bold; }
        
        .stat-line { display: grid; grid-template-columns: 140px 1fr; gap: 15px; align-items: center; border-bottom: 1px solid rgba(0, 255, 65, 0.1); padding-bottom: 6px; }
        .stat-label { color: #558855; font-weight: bold; font-size: 0.7rem; letter-spacing: 1px; text-transform: uppercase; }

        /* --- OVERLAYS --- */
        #scanOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 5, 0, 0.98); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding-top: 50px;
            opacity: 0; pointer-events: none; transition: opacity 0.5s; 
            overflow-y: auto;
        }
        #scanOverlay.active { opacity: 1; pointer-events: auto; }

        /* --- ADMIN OVERLAYS & UI --- */
        #adminCog {
            position: fixed; top: 10px; left: 10px; z-index: 3000;
            cursor: pointer; opacity: 0; transition: opacity 2s;
            font-size: 20px; filter: grayscale(100%);
        }
        #adminCog:hover { filter: grayscale(0%); transform: rotate(90deg); transition: transform 0.5s; }

        #adminModal, #adminPanel {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 10, 0, 0.95); border: 1px solid var(--primary);
            padding: 20px; z-index: 4000; box-shadow: 0 0 50px rgba(0,255,65,0.2);
            color: var(--primary); font-family: 'Share Tech Mono';
            min-width: 300px; text-align: center;
        }
        #adminPanel { width: 90%; max-width: 800px; height: 80vh; display: flex; flex-direction: column; text-align: left; }
        
        .code-input {
            background: #000; border: 1px solid #333; color: var(--primary);
            padding: 10px; font-size: 1.5rem; text-align: center; letter-spacing: 10px; width: 100%;
            outline: none; margin-bottom: 10px;
        }
        .code-input:focus { border-color: var(--primary); box-shadow: 0 0 10px var(--primary); }

        .admin-tab-btn {
            background: #002200; border: 1px solid #004400; color: #66aa66; padding: 10px; cursor: pointer; flex: 1;
        }
        .admin-tab-btn.active { background: var(--primary); color: #000; font-weight: bold; }
        
        .user-list { flex: 1; overflow-y: auto; border: 1px solid #003300; background: #000500; padding: 10px; margin-top: 10px; }
        .user-row {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #002200; padding: 10px 0; font-size: 0.9rem;
        }
        .user-row:last-child { border-bottom: none; }
        
        .btn-kick { background: #330000; color: red; border: 1px solid red; padding: 5px 10px; cursor: pointer; font-size: 0.7rem; }
        .btn-kick:hover { background: red; color: white; }
        .btn-grant { background: #003300; color: lime; border: 1px solid lime; padding: 5px 10px; cursor: pointer; font-size: 0.7rem; margin-right: 5px; }
        .btn-grant:hover { background: lime; color: black; }

        /* Waiting Screen */
        #waitingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2500; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-family: 'Orbitron'; text-align: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        #waitingScreen.active { opacity: 1; pointer-events: auto; }

        
        /* Mobile Tweaks */
        @media (max-width: 768px) {
            .select-group { grid-template-columns: 1fr; }
            h1 { font-size: 2.5rem; letter-spacing: 2px; }
            .btn-start { padding: 1rem 3rem; width: 100%; }
            #virusStage { width: 300px; height: 300px; }
            .action-group { grid-template-columns: 1fr; }
            .control-panel { padding: 15px; }
        }
    </style>
</head>
<body class="crt">
    <div class="scanline"></div>
    <canvas id="bgCanvas"></canvas>

    <!-- ADMIN COG -->
    <div id="adminCog" onclick="toggleAdminUI()">⚙️</div>

    <!-- ADMIN AUTH MODAL -->
    <div id="adminModal" class="hidden">
        <h3 class="mb-4 text-green-500 font-bold tracking-widest">SECURITY OVERRIDE</h3>
        <input type="password" maxlength="4" id="adminCodeInput" class="code-input" placeholder="____" onkeyup="checkAdminCode()">
        <div id="adminMsg" class="text-xs text-red-500 h-4 mt-2"></div>
        <button class="mt-4 border border-red-900 text-red-900 text-xs px-2 py-1 hover:bg-red-900 hover:text-black" onclick="closeAdminAuth()">CANCEL</button>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="hidden">
        <div class="flex justify-between items-center mb-4 border-b border-green-800 pb-2">
            <h2 class="text-xl font-bold tracking-widest text-white">COMMAND_CONSOLE // <span id="adminNameDisplay">ADMIN</span></h2>
            <button class="text-red-500 hover:text-white" onclick="closeAdminPanel()">[X]</button>
        </div>
        
        <div class="flex gap-2 mb-2">
            <button class="admin-tab-btn active" onclick="switchAdminTab('active')">INFILTRATED (<span id="countActive">0</span>)</button>
            <button class="admin-tab-btn" onclick="switchAdminTab('waiting')">REQUESTS (<span id="countWaiting">0</span>)</button>
            <button class="admin-tab-btn text-red-800" onclick="switchAdminTab('kicked')">TERMINATED</button>
        </div>

        <div id="tabActive" class="user-list"></div>
        <div id="tabWaiting" class="user-list hidden"></div>
        <div id="tabKicked" class="user-list hidden"></div>
    </div>

    <!-- WAITING SCREEN -->
    <div id="waitingScreen">
        <div class="text-4xl text-yellow-500 mb-4 animate-pulse">WAITING FOR APPROVAL</div>
        <div class="text-sm tracking-[0.5em] text-gray-500 mb-8">CONNECTION PENDING HOST APPROVAL</div>
        <div class="font-mono text-xs text-green-900">
            ID: <span id="myUserIdDisplay">...</span><br>
            STATUS: <span id="myStatusDisplay" class="animate-pulse">WAITING_FOR_UPLINK</span>
        </div>
        <!-- Secret access for admin to click cog even here -->
    </div>

    <!-- INTRO -->
    <div id="introScreen">
        <div id="bootLog"></div>
        <div id="introContent" class="flex flex-col items-center z-10">
            <h1 class="hidden glitch-text" id="mainTitle">Create the Virus</h1>
            <div class="text-green-700 tracking-[0.5em] text-sm mb-12 opacity-0 transition-opacity duration-1000 font-bold" id="subTitle">ARCHITECT EDITION // V.99.0</div>
            <button class="btn-start" id="startBtn" onclick="tryStartGame()">REQUEST LOGIN</button>
        </div>
    </div>

    <!-- MAIN GAME -->
    <div id="gameScreen" class="hidden">
        
        <div id="virusStageWrapper">
            <div class="corner c-tl"></div><div class="corner c-tr"></div><div class="corner c-bl"></div><div class="corner c-br"></div>
            <div id="virusStage">
                <div class="stage-grid"></div>
                <canvas id="virusCanvas" width="360" height="360"></canvas>
                <div id="emptyState" class="absolute text-gray-700 font-bold text-center pointer-events-none tracking-widest text-xs z-0">
                    // AWAITING SYNTHESIS PARAMETERS //<br>
                    // SELECT INPUTS BELOW //
                </div>
            </div>
        </div>

        <div class="control-panel grid-bg">
            <div class="corner c-tl"></div><div class="corner c-tr"></div><div class="corner c-bl"></div><div class="corner c-br"></div>
            
            <div class="flex justify-between items-center border-b border-green-900/50 pb-2 mb-4">
                <span class="text-xs text-green-800 font-bold tracking-widest">CONTROL_MODULE_01</span>
                <span class="text-xs text-green-600 animate-pulse">● ONLINE</span>
            </div>

            <div class="select-group">
                <div class="input-wrapper">
                    <label>01 // TERRA SAMPLE</label>
                    <select id="starterSelect"></select>
                </div>
                <div class="input-wrapper">
                    <label>02 // VIRAL VECTOR</label>
                    <select id="virusSelect"></select>
                </div>
                <div class="input-wrapper">
                    <label>03 // COSMIC BINDER</label>
                    <select id="spaceSelect"></select>
                </div>
            </div>

            <div class="action-group">
                <button class="btn-action btn-create" onclick="synthesizeVirus()">
                    <span class="relative z-10">SYNTHESIZE STRAIN</span>
                </button>
                <button class="btn-action btn-ignite" onclick="igniteVirus()">
                    <span class="relative z-10">IGNITE</span>
                </button>
            </div>
            
            <button class="btn-preview" id="previewBtn" onclick="openScan()">
                INITIATE CLINICAL SIMULATION
            </button>

            <div class="data-readout" id="dataReadout">
                <div class="flex h-full items-center justify-center text-green-900 tracking-[0.2em] font-bold text-xs">
                    // WAITING FOR SEQUENCE GENERATION...
                </div>
            </div>
        </div>
        
        <div class="h-20"></div> <!-- Spacer for scrolling -->
    </div>

    <!-- PREVIEW OVERLAY -->
    <div id="scanOverlay">
        <button class="absolute top-5 left-5 border border-green-500 text-green-500 px-6 py-2 font-['Orbitron'] hover:bg-green-500 hover:text-black transition-colors z-50 uppercase tracking-widest text-sm" onclick="closeScan()">
            &lt; ABORT SIMULATION
        </button>
        
        <div class="w-full max-w-4xl p-4 flex flex-col md:flex-row gap-8 items-start justify-center mt-10">
            <!-- CANVAS CONTAINER -->
            <div class="relative border-2 border-green-900 bg-black shadow-[0_0_50px_rgba(0,50,0,0.5)] p-1">
                <div class="absolute top-2 left-2 text-[10px] text-green-600 font-mono">SUBJ: DUMMY_01</div>
                <canvas id="humanCanvas" width="380" height="420" class="bg-black/90"></canvas>
                <!-- Scan lines overlay -->
                <div class="absolute top-0 left-0 w-full h-full bg-[linear-gradient(rgba(0,255,0,0.05)_1px,transparent_1px)] bg-[size:100%_4px] pointer-events-none"></div>
            </div>

            <!-- TEXT REPORT -->
            <div class="flex-1 bg-black/80 border border-green-800 p-6 font-mono text-sm relative min-h-[400px]">
                <div class="absolute -top-3 left-4 bg-black px-2 text-green-500 text-xs border border-green-800">AUTOPSY_PREDICTION_LOG</div>
                
                <h2 class="text-2xl text-white font-['Orbitron'] mb-6 border-b border-gray-800 pb-2">FATAL ERROR ANALYSIS</h2>
                
                <div id="clinicalText" class="space-y-4 text-gray-300 leading-relaxed">
                    Awaiting Scan Data...
                </div>

                <div class="mt-8 pt-4 border-t border-dashed border-green-900">
                    <div class="grid grid-cols-2 gap-4 text-xs text-gray-500">
                        <div>SURVIVAL PROBABILITY:</div>
                        <div class="text-right" id="survivalText">0.000%</div>
                        <div>TIME TO TERMINATION:</div>
                        <div class="text-right text-yellow-500" id="timeToDeath">--</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="h-20"></div>
    </div>

    <script>
        /* --- FIREBASE SETUP --- */
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;
        let isAdmin = false;
        let myDocRef = null;
        let myName = "world-destroyer" + Math.floor(Math.random() * 9999);

        /* --- 1. AUTH & ADMIN LOGIC --- */
        
        async function initAuth() {
             if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await auth.signInWithCustomToken(__initial_auth_token);
            } else {
                await auth.signInAnonymously();
            }
        }

        initAuth();

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('myUserIdDisplay').innerText = user.uid.substring(0,8);
                
                // Set initial presence
                const usersCollection = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users');
                myDocRef = usersCollection.doc(user.uid);
                
                // Check if I exist already (persistence), otherwise create
                const doc = await myDocRef.get();
                
                if (!doc.exists) {
                    // Default state is 'standby' (invisible until request)
                    await myDocRef.set({
                        name: myName,
                        status: 'standby', 
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    startStatusListener();
                } else {
                    // If I exist, just listen
                    startStatusListener();
                }

                // Heartbeat
                setInterval(() => {
                    if(currentUser) myDocRef.update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
                }, 30000);
            }
        });

        function startStatusListener() {
            // Listen to my own status changes
            myDocRef.onSnapshot((doc) => {
                if(doc.exists) {
                    const data = doc.data();
                    const status = data.status;
                    document.getElementById('myStatusDisplay').innerText = status.toUpperCase();

                    if(status === 'active') {
                        // Granted!
                        document.getElementById('waitingScreen').classList.remove('active');
                        // Only auto-start if intro is done
                        if(introFinished && document.getElementById('gameScreen').classList.contains('hidden')) {
                           startGame(); 
                        }
                    } else if (status === 'kicked') {
                        // Rickroll
                        document.body.innerHTML = '<div style="color:red; font-size: 50px; text-align:center; padding-top:20%; font-family:monospace;">CONNECTION TERMINATED BY ADMIN</div>';
                        setTimeout(() => {
                            window.location.href = "https://www.youtube.com/watch?v=dQw4w9WgXcQ";
                        }, 2000);
                    } else if (status === 'waiting') {
                        // If game was active, hide it?
                         if(introFinished) {
                             document.getElementById('waitingScreen').classList.add('active');
                             document.getElementById('gameScreen').classList.add('hidden');
                             document.getElementById('introScreen').classList.add('hidden');
                         }
                    }
                }
            });
        }

        /* --- ADMIN UI LOGIC --- */
        function toggleAdminUI() {
            const modal = document.getElementById('adminModal');
            const panel = document.getElementById('adminPanel');
            
            if (!panel.classList.contains('hidden')) {
                closeAdminPanel();
            } else if (!modal.classList.contains('hidden')) {
                closeAdminAuth();
            } else {
                showAdminAuth();
            }
        }

        function showAdminAuth() {
            document.getElementById('adminModal').classList.remove('hidden');
            document.getElementById('adminCodeInput').value = '';
            document.getElementById('adminCodeInput').focus();
        }

        function closeAdminAuth() {
            document.getElementById('adminModal').classList.add('hidden');
        }

        function checkAdminCode() {
            const input = document.getElementById('adminCodeInput').value;
            if (input === '1090') {
                document.getElementById('adminMsg').innerText = "ACCESS GRANTED";
                document.getElementById('adminMsg').style.color = "#0f0";
                setTimeout(() => {
                    closeAdminAuth();
                    openAdminPanel();
                }, 500);
            } else if (input.length === 4) {
                document.getElementById('adminMsg').innerText = "INVALID CREDENTIALS";
                document.getElementById('adminMsg').style.color = "red";
            }
        }

        function openAdminPanel() {
            isAdmin = true;
            document.getElementById('adminPanel').classList.remove('hidden');
            // If I am admin, I self-approve
            myDocRef.update({ status: 'active', isAdmin: true });
            
            // Listen to all users
            const usersCollection = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users');
            usersCollection.onSnapshot(renderAdminList);
        }

        function closeAdminPanel() {
            document.getElementById('adminPanel').classList.add('hidden');
        }

        function renderAdminList(snapshot) {
            const tabActive = document.getElementById('tabActive');
            const tabWaiting = document.getElementById('tabWaiting');
            const tabKicked = document.getElementById('tabKicked');
            
            tabActive.innerHTML = '';
            tabWaiting.innerHTML = '';
            tabKicked.innerHTML = '';
            
            let cActive = 0, cWaiting = 0;

            snapshot.forEach(doc => {
                const u = doc.data();
                const uid = doc.id;
                
                // Format: Name - UID - Actions
                const div = document.createElement('div');
                div.className = 'user-row';
                div.innerHTML = `
                    <div>
                        <span class="font-bold text-white">${u.name}</span>
                        <span class="text-xs text-gray-500 ml-2">[${uid.substring(0,4)}]</span>
                    </div>
                `;

                const actions = document.createElement('div');

                if (u.status === 'active') {
                    cActive++;
                    if(uid !== currentUser.uid) { // Can't kick self easily
                        actions.innerHTML = `<button class="btn-kick" onclick="updateUserStatus('${uid}', 'kicked')">PURGE</button>`;
                    } else {
                         actions.innerHTML = `<span class="text-xs text-green-500">[HOST]</span>`;
                    }
                    div.appendChild(actions);
                    tabActive.appendChild(div);
                } else if (u.status === 'waiting') {
                    cWaiting++;
                    actions.innerHTML = `
                        <button class="btn-grant" onclick="updateUserStatus('${uid}', 'active')">GRANT</button>
                        <button class="btn-kick" onclick="updateUserStatus('${uid}', 'kicked')">DENY</button>
                    `;
                    div.appendChild(actions);
                    tabWaiting.appendChild(div);
                } else if (u.status === 'kicked') {
                     actions.innerHTML = `<button class="btn-grant" onclick="updateUserStatus('${uid}', 'waiting')">RESTORE</button>`;
                     div.appendChild(actions);
                     tabKicked.appendChild(div);
                }
            });

            document.getElementById('countActive').innerText = cActive;
            document.getElementById('countWaiting').innerText = cWaiting;
        }
        
        // Expose to window for onclick
        window.updateUserStatus = function(targetUid, newStatus) {
            if(!isAdmin) return;
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users')
                .doc(targetUid).update({ status: newStatus });
        };

        window.switchAdminTab = function(tabName) {
            ['active', 'waiting', 'kicked'].forEach(t => {
                document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('hidden');
            });
            document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.remove('hidden');
            event.target.classList.add('active');
        };

        /* --- 2. PROCEDURAL GENERATORS (Expanded) --- */
        function generateItems(adjList, nounList) {
            let items = [];
            for(let a of adjList) for(let n of nounList) items.push(`${a} ${n}`);
            return items.sort(() => Math.random() - 0.5);
        }
        
        const earthAdj = ["Radioactive", "Necrotic", "Crystalline", "Fossilized", "Bio-Luminescent", "Synthetic", "Corrupted", "Magnetic", "Fungal", "Metallic", "Liquid", "Gaseous", "Petrified", "Charred", "Hollow", "Screaming", "Weeping", "Pulsing", "Vibrating", "Frozen", "Boiling", "Shadowy", "Invisible", "Heavy", "Ancient", "Forbidden"];
        const earthNoun = ["Sludge", "Bone", "Mycelium", "Mercury", "Ash", "Sand", "Venom", "Sap", "Pollen", "Spore", "Glass", "Bile", "Marrow", "Teeth", "Obsidian", "Graphite", "Sulfur", "Acid", "Tar", "Plasma", "Silk", "Scale", "Chitin", "Quartz"];
        const starters = generateItems(earthAdj, earthNoun);

        const spaceAdj = ["Void", "Nebula", "Stellar", "Quantum", "Neutron", "Gravitational", "Dimensional", "Alien", "Zero-G", "Eldritch", "Psionic", "Temporal", "Infinite", "Abyssal", "Entropic", "Chaos", "Dark", "Anti-", "Hyper", "Solar", "Lunar"];
        const spaceNoun = ["Dust", "Shard", "Gas", "Matter", "Singularity", "Residue", "Crystal", "Radiation", "Essence", "Frequency", "Wave", "Goo", "Light", "Shadow", "Mist", "Memory", "Thought", "Time", "Space", "Color", "Silence", "Echo"];
        const spaceItems = generateItems(spaceAdj, spaceNoun);

        const virusPrefixes = ["Xeno", "Necro", "Bio", "Cyto", "Astro", "Cryo", "Pyro", "Neuro", "Omni", "Zeta", "Nano", "Exo", "Retro", "Lympho", "Hemo", "Viro", "Patho", "Chrono", "Techno", "Cyber", "Spectral", "Thalasso"];
        const virusRoots = ["phage", "virus", "pathogen", "scourge", "blight", "plague", "pox", "rot", "wither", "bane", "death", "morph", "doom", "fever", "strain", "vector", "parasite", "symbiote", "glitch", "void"];
        
        const virusList = [];
        for(let i=0; i<1000; i++) {
            const p = virusPrefixes[Math.floor(Math.random() * virusPrefixes.length)];
            const r = virusRoots[Math.floor(Math.random() * virusRoots.length)];
            const suffix = Math.random() > 0.7 ? `-${String.fromCharCode(65+Math.random()*26)}${Math.floor(Math.random()*9)}` : `-${Math.floor(Math.random()*999)}`;
            virusList.push(`${p.toUpperCase()}${r.toUpperCase()}${suffix}`);
        }

        /* --- 3. SETUP UI --- */
        const starterSelect = document.getElementById('starterSelect');
        const virusSelect = document.getElementById('virusSelect');
        const spaceSelect = document.getElementById('spaceSelect');
        
        // Populate with randomized selection but deterministic order for this session
        starters.slice(0, 500).forEach(item => starterSelect.add(new Option(item, item)));
        virusList.slice(0, 500).forEach(item => virusSelect.add(new Option(item, item)));
        spaceItems.slice(0, 500).forEach(item => spaceSelect.add(new Option(item, item)));

        /* --- 4. BACKGROUND ANIMATION (Enhanced) --- */
        const bgCanvas = document.getElementById('bgCanvas');
        const bgCtx = bgCanvas.getContext('2d');
        let width, height;

        function resizeBg() { 
            width = window.innerWidth; 
            height = window.innerHeight; 
            bgCanvas.width = width; 
            bgCanvas.height = height; 
        }
        window.addEventListener('resize', resizeBg);
        resizeBg();

        // Matrix/Bio Rain
        class Stream {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.speed = Math.random() * 2 + 1;
                this.chars = [];
                const len = Math.floor(Math.random() * 15) + 5;
                for(let i=0; i<len; i++) {
                    this.chars.push({
                        char: String.fromCharCode(0x30A0 + Math.random() * 96), // Katakana
                        alpha: (i / len)
                    });
                }
            }
            update() {
                this.y += this.speed;
                if(this.y > height) this.y = -100;
            }
            draw() {
                this.chars.forEach((c, i) => {
                    bgCtx.fillStyle = `rgba(0, 255, 65, ${c.alpha * 0.3})`;
                    bgCtx.font = '14px monospace';
                    bgCtx.fillText(c.char, this.x, this.y - i * 15);
                });
            }
        }
        
        let streams = [];
        for(let i=0; i<50; i++) streams.push(new Stream());

        function animateBg() { 
            bgCtx.clearRect(0, 0, width, height); 
            streams.forEach(s => { s.update(); s.draw(); }); 
            requestAnimationFrame(animateBg); 
        }
        animateBg();

        /* --- 5. INTRO BOOT SEQUENCE --- */
        const bootLog = document.getElementById('bootLog');
        const logs = [
            "BIOS CHECK...", "CPU: QUANTUM CORE [OK]", "MEMORY: 128ZB [OK]", "LOADING KERNEL...",
            "MOUNTING FILE SYSTEM...", "ACCESSING SECURE SECTOR...", "WARNING: BIO-CONTAINMENT ACTIVE",
            "INITIALIZING GRAPHICS ENGINE...", "LOADING... 10%", "LOADING... 34%", "LOADING... 68%",
            "LOADING... 99%", "SYSTEM READY."
        ];

        let introFinished = false;

        async function runIntro() {
            let delay = 100;
            for(let log of logs) {
                const div = document.createElement('div');
                div.className = log.includes('WARNING') ? 'log-line log-warn' : (log.includes('OK') || log.includes('READY')) ? 'log-line log-success' : 'log-line';
                div.textContent = `> ${log}`;
                bootLog.appendChild(div);
                bootLog.scrollTop = bootLog.scrollHeight;
                await new Promise(r => setTimeout(r, Math.random() * 200 + 50));
            }
            
            document.getElementById('mainTitle').classList.remove('hidden');
            await new Promise(r => setTimeout(r, 1000));
            document.getElementById('subTitle').style.opacity = '1';
            
            // ADMIN COG APPEARS HERE
            document.getElementById('adminCog').style.opacity = '1';

            await new Promise(r => setTimeout(r, 800));
            document.getElementById('startBtn').classList.add('visible');
            
            // Cleanup visual clutter after load
            setTimeout(() => { bootLog.style.opacity = '0'; }, 2000);

            introFinished = true;
        }
        window.onload = runIntro;

        /* --- 6. ULTRA VIRUS RENDER ENGINE --- */
        // Utility Functions
        function hash(str) {
            let h = 0xdeadbeef;
            for(let i=0; i<str.length; i++) h = Math.imul(h ^ str.charCodeAt(i), 2654435761);
            return ((h ^ h >>> 16) >>> 0);
        }
        
        // Deterministic Random Class
        class RNG {
            constructor(seed) { this.seed = seed; }
            next() {
                this.seed = (this.seed * 1664525 + 1013904223) % 4294967296;
                return this.seed / 4294967296;
            }
            range(min, max) { return min + this.next() * (max - min); }
            int(min, max) { return Math.floor(this.range(min, max)); }
            pick(arr) { return arr[this.int(0, arr.length)]; }
        }

        const ANOMALY_TYPES = {
            'DIVINE': { color: '#ffd700', label: 'DIVINE ENTITY' },
            'INFERNO': { color: '#ff4400', label: 'INFERNO CLASS' },
            'VOID': { color: '#888888', label: 'VOID SINGULARITY' },
            'FROST': { color: '#aaffff', label: 'ABSOLUTE ZERO' },
            'TOXIC': { color: '#00ff00', label: 'BIOHAZARD' },
            'GLITCH': { color: '#ff00ff', label: 'SYSTEM ERROR' },
            'NONE': { color: '#555555', label: 'NORMAL' }
        };

        class Virus {
            constructor(seedStr) {
                const seedVal = hash(seedStr);
                this.rng = new RNG(seedVal);
                this.time = 0;
                this.ignited = false;
                this.burnProgress = 0;
                this.particles = []; // For fire effect
                this.survivalProb = 0;
                
                // --- GENERATION LOGIC ---
                // 1. Color Palette (HSL)
                const hue = this.rng.int(0, 360);
                const sat = this.rng.int(60, 100);
                this.colors = {
                    base: `hsla(${hue}, ${sat}%, 50%, 1)`,
                    light: `hsla(${hue}, ${sat}%, 70%, 1)`,
                    glow: `hsla(${hue}, 100%, 60%, 0.5)`,
                    core: `hsla(${(hue + 180) % 360}, 90%, 60%, 1)`
                };

                // 2. Anomaly Check (5% chance)
                this.anomaly = 'NONE';
                if(this.rng.next() > 0.90) {
                    const keys = Object.keys(ANOMALY_TYPES).filter(k => k !== 'NONE');
                    this.anomaly = this.rng.pick(keys);
                    // Override colors
                    if(this.anomaly === 'INFERNO') this.colors = { base: '#f00', light: '#fa0', glow: '#f40', core: '#fff' };
                    if(this.anomaly === 'VOID') this.colors = { base: '#000', light: '#333', glow: '#555', core: '#fff' };
                }

                // 3. Morphology
                this.radius = this.rng.range(60, 90);
                this.spikes = this.rng.int(0, 20); // 0 = smooth/blobby
                this.spikeLength = this.rng.range(10, 60);
                this.layers = this.rng.int(2, 5);
                this.noiseScale = this.rng.range(0.1, 0.8);
                this.pulseRate = this.rng.range(0.02, 0.08);
                
                // 4. Internal Organs (Nuclei, etc)
                this.nucleiCount = this.rng.int(0, 6);
                this.nucleiArr = [];
                for(let i=0; i<this.nucleiCount; i++) {
                    this.nucleiArr.push({
                        x: this.rng.range(-30, 30),
                        y: this.rng.range(-30, 30),
                        r: this.rng.range(5, 15),
                        orbitSpeed: this.rng.range(-0.05, 0.05)
                    });
                }
                
                // 5. Surface Texture
                this.textureType = this.rng.int(0, 4); // 0:None, 1:Spots, 2:Veins, 3:Bands
                
                // 6. Generate Name
                this.name = `STRAIN-${seedVal.toString(16).toUpperCase().substring(0,6)}`;
                
                // 7. Text Generation
                this.desc = this.generateDescription();
            }
            
            generateDescription() {
                // EXPANDED BIO-TEXT ENGINE
                
                const transmission = [
                    "via aerosolized quantum particles in the upper atmosphere",
                    "through direct neural-link interface corruption",
                    "by resonant frequency transmission through liquids",
                    "via contaminated synthetic hydration supplies",
                    "through retinal exposure to hyper-geometric patterns",
                    "via localized gravitational distortions",
                    "through microscopic dermal abrasions",
                    "by ingestion of corrupted organic matter"
                ];
                
                const mechanism = [
                    "rewrites host DNA into silicate crystalline structures",
                    "causes rapid and violent liquefaction of the skeletal system",
                    "induces extreme hyper-evolution of cancerous progenitor cells",
                    "converts blood plasma into a mercury-like ferrofluid",
                    "digitizes consciousness, leaving the body as a hollow biological shell",
                    "causes spontaneous low-temperature combustion of internal organs",
                    "reverses cellular aging until the subject ceases to exist",
                    "fuses the central nervous system with the nearest electronic device"
                ];

                const symptom = [
                    "profuse bleeding of black fluid from ocular cavities",
                    "complete loss of motor control and rigid paralysis",
                    "manifestation of luminescent third-degree burns",
                    "rapid growth of metallic protrusions from the spine",
                    "uncontrollable vocalization in unknown dialects",
                    "skin turning translucent, revealing internal decay",
                    "calcification of the lungs causing asphyxiation",
                    "total sensory deprivation followed by mania"
                ];
                
                const prognosis = [
                    "Total organ failure expected within 4 hours of exposure.",
                    "Subject enters permanent vegetative state immediately.",
                    "Host becomes highly aggressive before terminal expiration.",
                    "Complete molecular disintegration occurs at 98% infection rate.",
                    "Subject begins transforming into a hive-mind drone.",
                    "Temporal displacement of the subject's biological mass.",
                    "Biosignature fades as the subject phases out of reality.",
                    "Rapid necrotic cascade results in dust-like remains."
                ];

                const t = this.rng.pick(transmission);
                const m = this.rng.pick(mechanism);
                const s = this.rng.pick(symptom);
                const p = this.rng.pick(prognosis);

                // COLOR CODED: Green, Blue, Red, Purple
                return `<span style="color:#00ff41; font-weight:bold;">TRANSMISSION:</span> Occurs ${t}.<br>
                        <span style="color:#0088ff; font-weight:bold;">MECHANISM:</span> The pathogen ${m}.<br>
                        <span style="color:#ff3333; font-weight:bold;">SYMPTOMS:</span> Victims exhibit ${s}.<br>
                        <span style="color:#aa00ff; font-weight:bold;">PROGNOSIS:</span> ${p}`;
            }

            draw(ctx, w, h) {
                this.time++;
                ctx.clearRect(0,0,w,h);
                ctx.save();
                ctx.translate(w/2, h/2);

                if(this.ignited) {
                    this.burnProgress += 0.005;
                    
                    // Darken effect using global composite or filtering
                    // We simulate darkening by drawing a black semi-transparent circle over it later, 
                    // or modulating the colors. Here we simply reduce global alpha for disappearance
                    // and use brightness filter for "darkening"
                    const darkness = Math.max(0, 1 - this.burnProgress * 0.8);
                    ctx.filter = `brightness(${darkness}) grayscale(${this.burnProgress}) blur(${this.burnProgress}px)`;
                    
                    // Disappear
                    ctx.globalAlpha = Math.max(0, 1 - this.burnProgress * 1.2);

                    // FIRE PARTICLES
                    if(Math.random() > 0.2 && this.burnProgress < 0.8) {
                        for(let k=0; k<3; k++) {
                            const angle = Math.random() * Math.PI * 2;
                            const dist = Math.random() * this.radius;
                            this.particles.push({
                                x: Math.cos(angle) * dist,
                                y: Math.sin(angle) * dist,
                                vx: (Math.random() - 0.5) * 2,
                                vy: -Math.random() * 3 - 1,
                                life: 1.0,
                                size: Math.random() * 5 + 2
                            });
                        }
                    }
                }

                // AURA
                const pulse = Math.sin(this.time * this.pulseRate) * 5;
                const auraGrad = ctx.createRadialGradient(0,0, this.radius, 0,0, this.radius * 2 + pulse);
                auraGrad.addColorStop(0, this.colors.glow);
                auraGrad.addColorStop(1, 'transparent');
                ctx.fillStyle = auraGrad;
                ctx.beginPath(); ctx.arc(0,0, this.radius * 2.5, 0, Math.PI*2); ctx.fill();

                // LAYERS (Membranes)
                for(let i = this.layers; i > 0; i--) {
                    ctx.beginPath();
                    const rBase = this.radius * (0.4 + (i/this.layers)*0.6);
                    
                    // Complex Shape Algorithm
                    for(let a=0; a < Math.PI*2; a+=0.05) {
                        // Noise function simulation
                        const n1 = Math.sin(a * (5 + this.spikes) + this.time * 0.02);
                        const n2 = Math.cos(a * 12 - this.time * 0.05);
                        
                        let r = rBase + (n1 * 5 * this.noiseScale) + (n2 * 2);
                        
                        // Spikes?
                        if(this.spikes > 0) {
                            const spikeMod = Math.sin(a * this.spikes);
                            if(spikeMod > 0.8) r += this.spikeLength * spikeMod;
                        }

                        // Wobble
                        r += Math.sin(this.time * 0.1) * 2;

                        const x = Math.cos(a) * r;
                        const y = Math.sin(a) * r;
                        if(a===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                    }
                    ctx.closePath();
                    
                    // Fill Logic
                    if(i === 1) { // Core
                         ctx.fillStyle = this.colors.core;
                         ctx.fill();
                    } else {
                         ctx.fillStyle = `rgba(0,0,0,0.3)`;
                         ctx.strokeStyle = this.colors.base;
                         ctx.lineWidth = 2;
                         ctx.stroke();
                         ctx.fill();
                    }
                }

                // TEXTURE
                if(this.textureType === 1) { // Spots
                    ctx.fillStyle = this.colors.light;
                    for(let i=0; i<8; i++) {
                        const angle = this.time * 0.01 + i;
                        const dist = this.radius * 0.6;
                        ctx.beginPath(); 
                        ctx.arc(Math.cos(angle)*dist, Math.sin(angle)*dist, 4, 0, Math.PI*2);
                        ctx.fill();
                    }
                } else if(this.textureType === 2) { // Veins
                     ctx.strokeStyle = this.colors.light;
                     ctx.lineWidth = 1;
                     ctx.beginPath();
                     for(let i=0; i<6; i++) {
                         ctx.moveTo(0,0);
                         const a = (Math.PI*2/6)*i + this.time*0.01;
                         ctx.quadraticCurveTo(Math.cos(a+0.5)*this.radius*0.5, Math.sin(a+0.5)*this.radius*0.5, Math.cos(a)*this.radius, Math.sin(a)*this.radius);
                     }
                     ctx.stroke();
                }

                // NUCLEI (Floating organs)
                this.nucleiArr.forEach((n, idx) => {
                    const ang = this.time * n.orbitSpeed + idx;
                    const nx = Math.cos(ang) * n.x * 2; // Move in ellipse-ish pattern
                    const ny = Math.sin(ang) * n.y * 2;
                    
                    ctx.fillStyle = '#fff';
                    ctx.shadowColor = this.colors.core;
                    ctx.shadowBlur = 10;
                    ctx.beginPath(); ctx.arc(nx, ny, n.r * (0.8 + Math.sin(this.time*0.1)*0.2), 0, Math.PI*2); ctx.fill();
                    ctx.shadowBlur = 0;
                });

                ctx.restore();

                // DRAW FIRE PARTICLES OVER VIRUS (Reset transform first)
                if(this.ignited && this.particles.length > 0) {
                    ctx.save();
                    ctx.translate(w/2, h/2); // Re-center for particles generated relative to center
                    // No filter for particles so they look bright
                    ctx.globalCompositeOperation = 'lighter';
                    
                    for(let i=this.particles.length-1; i>=0; i--) {
                        let p = this.particles[i];
                        p.x += p.vx;
                        p.y += p.vy;
                        p.life -= 0.05;
                        p.size *= 0.95;
                        
                        if(p.life <= 0) {
                            this.particles.splice(i, 1);
                            continue;
                        }
                        
                        const grad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size * 2);
                        grad.addColorStop(0, `rgba(255, 200, 50, ${p.life})`);
                        grad.addColorStop(0.5, `rgba(255, 50, 0, ${p.life * 0.8})`);
                        grad.addColorStop(1, `rgba(50, 0, 0, 0)`);
                        
                        ctx.fillStyle = grad;
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size * 2, 0, Math.PI*2);
                        ctx.fill();
                    }
                    ctx.restore();
                }
            }
        }

        /* --- 7. GAME LOGIC --- */
        let currentVirus = null;
        const vCanvas = document.getElementById('virusCanvas');
        const vCtx = vCanvas.getContext('2d');
        
        // MODIFIED START FUNCTION TO CHECK PERMISSION
        async function tryStartGame() {
            if(!myDocRef) return; // Wait for auth
            
            const doc = await myDocRef.get();
            if(doc.exists) {
                const status = doc.data().status;
                if(status === 'active') {
                    startGame();
                } else if (status === 'kicked') {
                    // Trigger rickroll logic if not already triggered by listener
                    document.body.innerHTML = '<div style="color:red; font-size: 50px; text-align:center; padding-top:20%; font-family:monospace;">CONNECTION TERMINATED BY ADMIN</div>';
                        setTimeout(() => {
                            window.location.href = "https://www.youtube.com/watch?v=dQw4w9WgXcQ";
                        }, 2000);
                } else {
                    // Move to waiting state
                    await myDocRef.update({ status: 'waiting' });
                    
                    document.getElementById('introScreen').classList.add('hidden');
                    document.getElementById('waitingScreen').classList.add('active');
                }
            }
        }

        function startGame() {
            document.getElementById('introScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            gameLoop();
        }

        function synthesizeVirus() {
            const s1 = document.getElementById('starterSelect').value;
            const s2 = document.getElementById('virusSelect').value;
            const s3 = document.getElementById('spaceSelect').value;
            
            // Generate
            const seed = `${s1}-${s2}-${s3}`;
            currentVirus = new Virus(seed);
            
            // UI Update
            document.getElementById('emptyState').style.opacity = '0';
            const readout = document.getElementById('dataReadout');
            
            // Stats Bars Calculation (Deterministic)
            const lethality = currentVirus.rng.int(50, 100);
            const spread = currentVirus.rng.int(30, 90);
            const resist = currentVirus.rng.int(10, 80);

            // Calculate Overall Score
            const overallScore = Math.floor((lethality + spread + resist) / 3);
            let dangerLabel = "SAFE";
            let dangerColor = "#00ff41";
            if(overallScore > 40) { dangerLabel = "DANGEROUS"; dangerColor = "#ffff00"; }
            if(overallScore > 75) { dangerLabel = "EXTREMELY DANGEROUS"; dangerColor = "#ff0000"; }
            
            // Determine Survival Prob (Inverse of overall score + randomness)
            let survivalBase = 100 - overallScore;
            // Add some variance
            survivalBase += (Math.random() * 20 - 10);
            currentVirus.survivalProb = Math.max(0, Math.min(99.9, survivalBase));

            const anomalyData = ANOMALY_TYPES[currentVirus.anomaly];

            readout.innerHTML = `
                <div class="stat-line">
                    <span class="stat-label">DESIGNATION</span>
                    <span class="text-white font-bold tracking-widest">${currentVirus.name}</span>
                </div>
                <div class="stat-line">
                    <span class="stat-label">CLASS</span>
                    <span style="color:${anomalyData.color}" class="font-bold tracking-widest animate-pulse">${anomalyData.label}</span>
                </div>
                <div class="stat-line">
                    <span class="stat-label">LETHALITY</span>
                    <div class="w-full bg-green-900/30 h-2 border border-green-900"><div style="width:${lethality}%; background:${currentVirus.colors.base}" class="h-full shadow-[0_0_10px_currentColor]"></div></div>
                </div>
                <div class="stat-line">
                    <span class="stat-label">CONTAGION</span>
                    <div class="w-full bg-green-900/30 h-2 border border-green-900"><div style="width:${spread}%; background:${currentVirus.colors.light}" class="h-full shadow-[0_0_10px_currentColor]"></div></div>
                </div>
                 <div class="stat-line">
                    <span class="stat-label">RESISTANCE</span>
                    <div class="w-full bg-green-900/30 h-2 border border-green-900"><div style="width:${resist}%; background:${currentVirus.colors.core}" class="h-full shadow-[0_0_10px_currentColor]"></div></div>
                </div>
                <div class="stat-line">
                    <span class="stat-label text-red-500 font-black">OVERALL</span>
                    <div class="w-full bg-red-900/20 h-3 border border-red-900 relative">
                        <div style="width:${overallScore}%; background:#ff0000;" class="h-full shadow-[0_0_15px_#ff0000]"></div>
                    </div>
                </div>
                <div class="text-center font-bold tracking-[0.3em] text-xs border-b border-gray-800 pb-2 mb-2" style="color:${dangerColor}; text-shadow:0 0 10px ${dangerColor}">
                    // STATUS: ${dangerLabel} //
                </div>
                <div class="mt-2 text-xs text-gray-400 font-normal border-t border-green-900/50 pt-2 leading-relaxed">
                    ${currentVirus.desc}
                </div>
            `;
            
            document.getElementById('previewBtn').classList.add('active');
        }

        function igniteVirus() {
            if(!currentVirus) return;

            // Check for Immunity
            if(currentVirus.anomaly === 'INFERNO') {
                const prev = document.getElementById('dataReadout').innerHTML;
                document.getElementById('dataReadout').innerHTML = `
                    <div class="flex h-full flex-col items-center justify-center text-orange-500 font-bold animate-pulse border-4 border-orange-500 bg-black">
                        <div class="text-2xl font-['Orbitron']">ERROR: FAILURE</div>
                        <div class="text-sm tracking-widest mt-2 text-center">TARGET IMMUNE TO THERMAL IGNITION<br>INFERNO CLASS DETECTED</div>
                    </div>
                `;
                // Revert text after 2 seconds
                setTimeout(() => {
                    document.getElementById('dataReadout').innerHTML = prev;
                }, 2500);
                return;
            }

            // Valid Ignition
            currentVirus.ignited = true;
            document.getElementById('dataReadout').innerHTML = `
                <div class="flex h-full flex-col items-center justify-center text-red-500 font-bold animate-pulse">
                    <div class="text-2xl font-['Orbitron']">IGNITION SEQUENCE</div>
                    <div class="text-xs tracking-widest mt-2">THERMAL INCINERATION ACTIVE</div>
                </div>
            `;
            document.getElementById('previewBtn').classList.remove('active');
            
            setTimeout(() => {
                currentVirus = null;
                vCtx.clearRect(0,0,360,360);
                document.getElementById('emptyState').style.opacity = '1';
                document.getElementById('dataReadout').innerHTML = `
                    <div class="flex h-full items-center justify-center text-green-900 tracking-[0.2em] font-bold text-xs">
                    // SYSTEM IDLE - READY //
                    </div>
                `;
            }, 3000); // Increased time for animation
        }

        function gameLoop() {
            if(currentVirus) currentVirus.draw(vCtx, 360, 360);
            requestAnimationFrame(gameLoop);
        }

        /* --- 8. PREVIEW SIMULATION --- */
        let hCtx = document.getElementById('humanCanvas').getContext('2d');
        let scanId;
        
        // Define Human Path (Simple Silhouette)
        const humanPath = new Path2D("M190,80 C210,80 220,95 220,115 C220,135 210,145 190,145 C170,145 160,135 160,115 C160,95 170,80 190,80 M165,150 L140,250 L150,260 L170,190 L170,280 L160,380 L180,390 L190,290 L200,390 L220,380 L210,280 L210,190 L230,260 L240,250 L215,150 Z");

        function openScan() {
            if(!currentVirus) return;
            document.getElementById('scanOverlay').classList.add('active');
            
            // Generate Text
            const time = currentVirus.rng.int(2, 48) + " HOURS";
            document.getElementById('timeToDeath').innerText = time;
            
            // Dynamic Survival Text Color
            let sProb = currentVirus.survivalProb.toFixed(3);
            let sColor = sProb > 50 ? 'text-green-500' : (sProb > 20 ? 'text-yellow-500' : 'text-red-500');
            document.getElementById('survivalText').className = `text-right ${sColor} font-bold`;
            document.getElementById('survivalText').innerText = sProb + "%";

            document.getElementById('clinicalText').innerHTML = `
                <strong class="text-green-400">PATHOGEN ID:</strong> ${currentVirus.name}<br>
                <strong class="text-green-400">VECTOR:</strong> Unknown Cosmic/Terra Hybrid<br><br>
                <span class="text-red-400">> CRITICAL FAILURE DETECTED</span><br>
                ${currentVirus.desc}
            `;
            
            scanY = 0;
            animateScan();
        }

        function closeScan() {
            document.getElementById('scanOverlay').classList.remove('active');
            cancelAnimationFrame(scanId);
        }

        let scanY = 0;
        function animateScan() {
            hCtx.fillStyle = '#000';
            hCtx.fillRect(0,0,380,420);
            
            // Draw Human
            hCtx.strokeStyle = '#004400';
            hCtx.lineWidth = 2;
            hCtx.stroke(humanPath);
            hCtx.fillStyle = 'rgba(0, 50, 0, 0.5)';
            hCtx.fill(humanPath);

            // Draw Organs (Abstract)
            hCtx.fillStyle = 'rgba(0,100,0,0.5)';
            hCtx.beginPath(); hCtx.arc(190, 170, 10, 0, Math.PI*2); hCtx.fill(); // Heart
            hCtx.beginPath(); hCtx.ellipse(175, 170, 8, 15, 0, 0, Math.PI*2); hCtx.fill(); // Lung L
            hCtx.beginPath(); hCtx.ellipse(205, 170, 8, 15, 0, 0, Math.PI*2); hCtx.fill(); // Lung R

            // Infection Overlay (Based on seed color)
            if(scanY > 150) {
                 hCtx.fillStyle = currentVirus.colors.glow;
                 hCtx.globalCompositeOperation = 'source-atop';
                 // Infection spreads from center
                 hCtx.beginPath(); hCtx.arc(190, 200, (scanY-150)*0.5, 0, Math.PI*2); 
                 hCtx.fill(humanPath);
                 hCtx.globalCompositeOperation = 'source-over';
            }

            // Scan Line
            scanY = (scanY + 2) % 500;
            hCtx.beginPath();
            hCtx.moveTo(0, scanY); hCtx.lineTo(380, scanY);
            hCtx.strokeStyle = '#00ff00';
            hCtx.lineWidth = 2;
            hCtx.shadowColor = '#0f0'; hCtx.shadowBlur = 10;
            hCtx.stroke();
            hCtx.shadowBlur = 0;

            // Scan Data Text
            hCtx.font = "10px monospace";
            hCtx.fillStyle = "#0f0";
            hCtx.fillText(`Z-SLICE: ${scanY}`, 10, scanY - 5);
            hCtx.fillText("ANALYZING TISSUE...", 250, scanY - 5);

            scanId = requestAnimationFrame(animateScan);
        }

    </script>
</body>
</html>


