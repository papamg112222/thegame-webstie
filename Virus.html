<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create the Virus - Architect Edition [ULTRA]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Libraries (Kept for compatibility) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&family=Share+Tech+Mono&display=swap');

        :root {
            --primary: #00ff41;
            --secondary: #008F11;
            --accent: #cdfc93;
            --danger: #ff3333;
            --bg-dark: #020402;
            --glass: rgba(0, 20, 0, 0.6);
            --border-glow: 0 0 10px rgba(0, 255, 65, 0.3);
        }

        /* --- GLOBAL SCROLL & LAYOUT --- */
        body {
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--primary);
            font-family: 'Share Tech Mono', monospace;
            /* UPDATED: Removed the radial spotlight, replaced with subtle linear gradient for uniformity */
            background-image: linear-gradient(180deg, #020402 0%, #051005 100%);
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* --- CRT & SCANLINE FX --- */
        .crt::before {
            content: " ";
            display: block; position: fixed; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 999; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }
        
        .scanline {
            width: 100%; height: 100px; z-index: 998;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(0, 255, 65, 0.04) 50%, rgba(0,0,0,0) 100%);
            opacity: 0.1; position: fixed; bottom: 100%; pointer-events: none;
            animation: scanline 10s linear infinite;
        }
        @keyframes scanline { 0% { bottom: 100%; } 100% { bottom: -100px; } }

        #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.3; pointer-events: none; }

        /* --- SCREENS --- */
        #introScreen, #gameScreen {
            position: relative;
            width: 100%; min-height: 100vh; z-index: 10;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s ease;
            padding: 40px 20px; box-sizing: border-box;
        }

        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        /* --- INTRO TYPOGRAPHY --- */
        h1 {
            font-family: 'Orbitron', sans-serif; font-weight: 900; 
            font-size: clamp(2.5rem, 8vw, 6rem);
            color: #fff;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.8), 2px 2px 0px var(--danger);
            margin-bottom: 0.5rem; text-align: center; letter-spacing: 5px; text-transform: uppercase;
            position: relative;
        }
        
        .glitch-text { animation: textGlitch 3s infinite; }
        @keyframes textGlitch {
            0% { transform: translate(0); text-shadow: 2px 2px 0px var(--danger); }
            2% { transform: translate(-2px, 2px); text-shadow: -2px -2px 0px var(--primary); }
            4% { transform: translate(2px, -2px); text-shadow: 2px 2px 0px var(--danger); }
            6% { transform: translate(0); text-shadow: 2px 2px 0px var(--danger); }
            100% { transform: translate(0); }
        }

        #bootLog {
            font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; color: #444;
            width: 300px; height: 150px; overflow: hidden; margin-bottom: 20px;
            border-left: 1px solid #333; padding-left: 10px; display: flex; flex-direction: column; justify-content: flex-end;
        }
        .log-line { color: #004400; margin: 1px 0; }
        .log-success { color: var(--primary); }
        .log-warn { color: #aaaa00; }

        .btn-start {
            background: rgba(0, 20, 0, 0.8); border: 1px solid var(--primary); color: var(--primary);
            padding: 1.5rem 5rem; font-size: 1.2rem; cursor: pointer;
            font-family: 'Orbitron', sans-serif; text-transform: uppercase; letter-spacing: 4px;
            transition: all 0.3s; position: relative; overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.1); opacity: 0; transform: translateY(20px);
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }
        .btn-start.visible { opacity: 1; transform: translateY(0); animation: float 4s ease-in-out infinite; }
        .btn-start:hover { background: var(--primary); color: #000; box-shadow: 0 0 60px rgba(0, 255, 65, 0.4); }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* --- GAME UI PANELS --- */
        .grid-bg {
            background-image: linear-gradient(rgba(0, 255, 65, 0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 255, 65, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .control-panel {
            background: var(--glass); border: 1px solid rgba(0, 255, 65, 0.2);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: 30px; width: 100%; max-width: 900px;
            display: flex; flex-direction: column; gap: 20px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8), inset 0 0 20px rgba(0, 50, 0, 0.3);
            position: relative; margin-top: 20px;
            border-radius: 2px;
        }
        /* Tech Corners */
        .corner { position: absolute; width: 15px; height: 15px; border: 2px solid var(--primary); transition: all 0.3s; pointer-events: none; }
        .c-tl { top: -1px; left: -1px; border-right: none; border-bottom: none; }
        .c-tr { top: -1px; right: -1px; border-left: none; border-bottom: none; }
        .c-bl { bottom: -1px; left: -1px; border-right: none; border-top: none; }
        .c-br { bottom: -1px; right: -1px; border-left: none; border-top: none; }

        /* Inputs */
        .select-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .input-wrapper { position: relative; }
        label { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.9rem; color: #698f6e; margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 2px; }
        select {
            background: rgba(0, 10, 0, 0.8); color: #fff; border: 1px solid #1a331a; padding: 15px;
            font-family: 'Share Tech Mono', monospace; width: 100%; cursor: pointer; font-size: 1rem; 
            transition: all 0.3s; appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300ff41%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 1rem center; background-size: 0.8em;
        }
        select:hover { border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 255, 65, 0.1); }
        select:focus { outline: none; border-color: var(--primary); background-color: #001a05; box-shadow: 0 0 20px rgba(0, 255, 65, 0.2); }

        /* Actions */
        .action-group { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 10px; }
        .btn-action {
            padding: 18px; font-weight: 700; font-family: 'Orbitron', sans-serif; font-size: 1.1rem;
            cursor: pointer; text-transform: uppercase; border: none;
            transition: all 0.2s; letter-spacing: 2px; position: relative; overflow: hidden;
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
        }
        /* Fancy Glitch Effect on buttons */
        .btn-action::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: skewX(-25deg); transition: 0.5s;
        }
        .btn-action:hover::after { left: 150%; }

        .btn-create { background: #003300; border: 1px solid var(--primary); color: var(--primary); }
        .btn-create:hover { background: var(--primary); color: #000; box-shadow: 0 0 30px var(--primary); }
        
        .btn-ignite { background: #220000; border: 1px solid var(--danger); color: var(--danger); }
        .btn-ignite:hover { background: var(--danger); color: #000; box-shadow: 0 0 30px var(--danger); }

        .btn-preview {
            background: rgba(0, 100, 200, 0.1); color: #00ffff; border: 1px solid rgba(0, 255, 255, 0.3);
            margin-top: 15px; width: 100%; padding: 15px; font-family: 'Rajdhani'; font-weight: bold; font-size: 1.2rem;
            cursor: pointer; text-transform: uppercase; letter-spacing: 3px; transition: 0.2s;
            clip-path: polygon(0 0, 100% 0, 99% 100%, 1% 100%); opacity: 0.3; pointer-events: none;
        }
        .btn-preview.active { opacity: 1; pointer-events: auto; }
        .btn-preview:hover { background: rgba(0, 255, 255, 0.2); box-shadow: 0 0 20px rgba(0, 255, 255, 0.2); border-color: #00ffff; }

        /* --- THE STAGE --- */
        #virusStageWrapper {
            position: relative; margin-bottom: 30px; 
            padding: 5px; border: 1px solid #111;
            background: linear-gradient(135deg, #111 0%, #000 100%);
            box-shadow: 0 0 40px rgba(0,0,0,1);
        }
        #virusStage {
            width: 360px; height: 360px;
            background: #000;
            position: relative; display: flex; align-items: center; justify-content: center;
            overflow: hidden;
            background-image: 
                radial-gradient(circle at center, #051005 0%, #000 70%);
        }
        #virusCanvas { 
            filter: drop-shadow(0 0 15px rgba(0,0,0,0.8)); 
            z-index: 2;
        }
        /* Animated Stage Elements */
        .stage-grid {
            position: absolute; top:0; left:0; width: 100%; height: 100%; opacity: 0.2;
            background-size: 40px 40px;
            background-image: linear-gradient(to right, #003300 1px, transparent 1px), linear-gradient(to bottom, #003300 1px, transparent 1px);
            z-index: 1; pointer-events: none;
        }

        /* --- READOUT --- */
        .data-readout {
            min-height: 180px; background: rgba(0,0,0,0.5); border-left: 2px solid var(--secondary);
            padding: 20px; font-size: 0.9rem; color: #bbb; display: grid; gap: 10px;
            font-family: 'Share Tech Mono'; position: relative;
        }
        .data-readout::before { content: "ANALYSIS_BUFFER"; position: absolute; top: -10px; right: 0; font-size: 0.6rem; color: #333; background: var(--primary); padding: 0 5px; color: #000; font-weight: bold; }
        
        .stat-line { display: grid; grid-template-columns: 140px 1fr; gap: 15px; align-items: center; border-bottom: 1px solid rgba(0, 255, 65, 0.1); padding-bottom: 6px; }
        .stat-label { color: #558855; font-weight: bold; font-size: 0.7rem; letter-spacing: 1px; text-transform: uppercase; }

        /* --- OVERLAYS --- */
        #scanOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 5, 0, 0.98); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding-top: 50px;
            opacity: 0; pointer-events: none; transition: opacity 0.5s; 
            overflow-y: auto;
        }
        #scanOverlay.active { opacity: 1; pointer-events: auto; }

        /* --- LOGIN MODAL --- */
        #loginPopup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 10, 0, 0.95); border: 2px solid var(--primary);
            padding: 40px; z-index: 5000; box-shadow: 0 0 100px rgba(0,255,65,0.2);
            color: var(--primary); font-family: 'Share Tech Mono';
            min-width: 320px; text-align: center;
            display: flex; flex-direction: column; align-items: center;
        }
        .code-input-lg {
            background: #000; border: 1px solid #333; color: var(--primary);
            padding: 15px; font-size: 2rem; text-align: center; letter-spacing: 15px; width: 200px;
            outline: none; margin: 20px 0; font-family: 'Orbitron';
        }
        .code-input-lg:focus { border-color: var(--primary); box-shadow: 0 0 20px var(--primary); }
        
        .login-btn {
            background: #004400; color: #fff; border: 1px solid #0f0;
            padding: 10px 30px; cursor: pointer; text-transform: uppercase; letter-spacing: 3px;
            transition: 0.2s; font-family: 'Rajdhani'; font-weight: bold;
        }
        .login-btn:hover { background: #0f0; color: #000; box-shadow: 0 0 20px #0f0; }

        /* Mobile Tweaks */
        @media (max-width: 768px) {
            .select-group { grid-template-columns: 1fr; }
            h1 { font-size: 2.5rem; letter-spacing: 2px; }
            .btn-start { padding: 1rem 3rem; width: 100%; }
            #virusStage { width: 300px; height: 300px; }
            .action-group { grid-template-columns: 1fr; }
            .control-panel { padding: 15px; }
        }
    </style>
</head>
<body class="crt">
    <div class="scanline"></div>
    <canvas id="bgCanvas"></canvas>

    <!-- LOGIN POPUP -->
    <div id="loginPopup" class="hidden">
        <h3 class="mb-2 text-green-500 font-bold tracking-widest text-xl">SECURE TERMINAL</h3>
        <div class="text-xs text-green-800 mb-4">ENTER ACCESS CODE</div>
        <input type="text" maxlength="4" id="loginInput" class="code-input-lg" placeholder="####">
        <div id="loginMsg" class="text-xs text-red-500 h-4 mb-4"></div>
        <div class="flex gap-4">
            <button class="text-red-900 border border-red-900 px-4 py-2 hover:bg-red-900 hover:text-black text-xs" onclick="toggleLoginPopup()">CANCEL</button>
            <button class="login-btn" onclick="submitLogin()">ENTER</button>
        </div>
    </div>

    <!-- INTRO -->
    <div id="introScreen">
        <div id="bootLog"></div>
        <div id="introContent" class="flex flex-col items-center z-10">
            <h1 class="hidden glitch-text" id="mainTitle">Create the Virus</h1>
            <div class="text-green-700 tracking-[0.5em] text-sm mb-12 opacity-0 transition-opacity duration-1000 font-bold" id="subTitle">ARCHITECT EDITION // V.99.0</div>
            <!-- BUTTON CHANGED TO LOGIN -->
            <button class="btn-start" id="startBtn" onclick="toggleLoginPopup()">LOGIN</button>
        </div>
    </div>

    <!-- MAIN GAME -->
    <div id="gameScreen" class="hidden">
        
        <div id="virusStageWrapper">
            <div class="corner c-tl"></div><div class="corner c-tr"></div><div class="corner c-bl"></div><div class="corner c-br"></div>
            <div id="virusStage">
                <div class="stage-grid"></div>
                <canvas id="virusCanvas" width="360" height="360"></canvas>
                <div id="emptyState" class="absolute text-gray-700 font-bold text-center pointer-events-none tracking-widest text-xs z-0">
                    // AWAITING SYNTHESIS PARAMETERS //<br>
                    // SELECT INPUTS BELOW //
                </div>
            </div>
        </div>

        <div class="control-panel grid-bg">
            <div class="corner c-tl"></div><div class="corner c-tr"></div><div class="corner c-bl"></div><div class="corner c-br"></div>
            
            <div class="flex justify-between items-center border-b border-green-900/50 pb-2 mb-4">
                <span class="text-xs text-green-800 font-bold tracking-widest">CONTROL_MODULE_01</span>
                <span class="text-xs text-green-600 animate-pulse">‚óè ONLINE</span>
            </div>

            <div class="select-group">
                <div class="input-wrapper">
                    <label>01 // TERRA SAMPLE</label>
                    <select id="starterSelect"></select>
                </div>
                <div class="input-wrapper">
                    <label>02 // VIRAL VECTOR</label>
                    <select id="virusSelect"></select>
                </div>
                <div class="input-wrapper">
                    <label>03 // COSMIC BINDER</label>
                    <select id="spaceSelect"></select>
                </div>
            </div>

            <div class="action-group">
                <button class="btn-action btn-create" onclick="synthesizeVirus()">
                    <span class="relative z-10">SYNTHESIZE STRAIN</span>
                </button>
                <button class="btn-action btn-ignite" onclick="igniteVirus()">
                    <span class="relative z-10">IGNITE</span>
                </button>
            </div>
            
            <button class="btn-preview" id="previewBtn" onclick="openScan()">
                INITIATE CLINICAL SIMULATION
            </button>

            <div class="data-readout" id="dataReadout">
                <div class="flex h-full items-center justify-center text-green-900 tracking-[0.2em] font-bold text-xs">
                    // WAITING FOR SEQUENCE GENERATION...
                </div>
            </div>
        </div>
        
        <div class="h-20"></div> <!-- Spacer for scrolling -->
    </div>

    <!-- PREVIEW OVERLAY -->
    <div id="scanOverlay">
        <button class="absolute top-5 left-5 border border-green-500 text-green-500 px-6 py-2 font-['Orbitron'] hover:bg-green-500 hover:text-black transition-colors z-50 uppercase tracking-widest text-sm" onclick="closeScan()">
            &lt; ABORT SIMULATION
        </button>
        
        <div class="w-full max-w-4xl p-4 flex flex-col md:flex-row gap-8 items-start justify-center mt-10">
            <!-- CANVAS CONTAINER -->
            <div class="relative border-2 border-green-900 bg-black shadow-[0_0_50px_rgba(0,50,0,0.5)] p-1">
                <div class="absolute top-2 left-2 text-[10px] text-green-600 font-mono">SUBJ: DUMMY_01</div>
                <canvas id="humanCanvas" width="380" height="420" class="bg-black/90"></canvas>
                <!-- Scan lines overlay -->
                <div class="absolute top-0 left-0 w-full h-full bg-[linear-gradient(rgba(0,255,0,0.05)_1px,transparent_1px)] bg-[size:100%_4px] pointer-events-none"></div>
            </div>

            <!-- TEXT REPORT -->
            <div class="flex-1 bg-black/80 border border-green-800 p-6 font-mono text-sm relative min-h-[400px]">
                <div class="absolute -top-3 left-4 bg-black px-2 text-green-500 text-xs border border-green-800">AUTOPSY_PREDICTION_LOG</div>
                
                <h2 class="text-2xl text-white font-['Orbitron'] mb-6 border-b border-gray-800 pb-2">FATAL ERROR ANALYSIS</h2>
                
                <div id="clinicalText" class="space-y-4 text-gray-300 leading-relaxed">
                    Awaiting Scan Data...
                </div>

                <div class="mt-8 pt-4 border-t border-dashed border-green-900">
                    <div class="grid grid-cols-2 gap-4 text-xs text-gray-500">
                        <!-- CHANGED LABEL BACK TO SURVIVAL -->
                        <div>SURVIVAL PROBABILITY:</div>
                        <div class="text-right" id="survivalText">0.000%</div>
                        <div>TIME TO TERMINATION:</div>
                        <div class="text-right text-yellow-500" id="timeToDeath">--</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="h-20"></div>
    </div>

    <script>
        /* --- 1. NEW LOGIN LOGIC --- */
        function toggleLoginPopup() {
            const popup = document.getElementById('loginPopup');
            if (popup.classList.contains('hidden')) {
                popup.classList.remove('hidden');
                document.getElementById('loginInput').value = '';
                document.getElementById('loginInput').focus();
                document.getElementById('loginMsg').innerText = '';
            } else {
                popup.classList.add('hidden');
            }
        }

        function submitLogin() {
            const code = document.getElementById('loginInput').value;
            if (code === '1090') {
                // Success
                document.getElementById('loginMsg').style.color = '#00ff00';
                document.getElementById('loginMsg').innerText = 'ACCESS GRANTED';
                setTimeout(() => {
                    toggleLoginPopup();
                    startGame();
                }, 800);
            } else {
                // Fail
                document.getElementById('loginMsg').style.color = 'red';
                document.getElementById('loginMsg').innerText = 'INVALID CREDENTIALS';
            }
        }

        /* --- 2. PROCEDURAL GENERATORS (Massive Expansion) --- */
        function generateItems(adjList, nounList) {
            let items = [];
            for(let a of adjList) for(let n of nounList) items.push(`${a} ${n}`);
            return items.sort(() => Math.random() - 0.5);
        }
        
        // Expanded to allow >1500 combinations
        const earthAdj = [
            "Radioactive", "Necrotic", "Crystalline", "Fossilized", "Bio-Luminescent", "Synthetic", "Corrupted", "Magnetic", "Fungal", "Metallic", 
            "Liquid", "Gaseous", "Petrified", "Charred", "Hollow", "Screaming", "Weeping", "Pulsing", "Vibrating", "Frozen", "Boiling", "Shadowy", 
            "Invisible", "Heavy", "Ancient", "Forbidden", "Volcanic", "Subterranean", "Oceanic", "Tectonic", "Seismic", "Primordial", "Granite", 
            "Basalt", "Limestone", "Erosion", "Glacial", "Tropical", "Arid", "Swamp", "Jungle", "Desert", "Canyon", "Mountain", "River", "Delta", 
            "Coral", "Abyssal", "Midnight", "Dawn", "Dusk", "Solar", "Lunar", "Eclipsed", "Tidal", "Atmospheric", "Stratospheric", "Thermal"
        ];
        const earthNoun = [
            "Sludge", "Bone", "Mycelium", "Mercury", "Ash", "Sand", "Venom", "Sap", "Pollen", "Spore", "Glass", "Bile", "Marrow", "Teeth", 
            "Obsidian", "Graphite", "Sulfur", "Acid", "Tar", "Plasma", "Silk", "Scale", "Chitin", "Quartz", "Clay", "Silt", "Rock", "Iron", 
            "Copper", "Zinc", "Lead", "Gold", "Silver", "Platinum", "Diamond", "Ruby", "Emerald", "Sapphire", "Opal", "Topaz", "Onyx", "Pearl", 
            "Shell", "Weed", "Moss", "Fern", "Root", "Bark", "Leaf", "Petal", "Thorn", "Seed", "Fruit", "Magma", "Lava", "Vapor", "Mist"
        ];
        // 58 * 57 = ~3300 combinations
        const starters = generateItems(earthAdj, earthNoun);

        const spaceAdj = [
            "Void", "Nebula", "Stellar", "Quantum", "Neutron", "Gravitational", "Dimensional", "Alien", "Zero-G", "Eldritch", "Psionic", "Temporal", 
            "Infinite", "Abyssal", "Entropic", "Chaos", "Dark", "Anti-", "Hyper", "Solar", "Lunar", "Galactic", "Universal", "Cosmic", "Astral", 
            "Planetary", "Orbital", "Meteoric", "Cometary", "Asteroid", "Eclipse", "Quasar", "Pulsar", "Blackhole", "Wormhole", "Warp", "Light", 
            "Matter", "Gravity", "Electric", "Plasma", "Fusion", "Fission", "Interstellar", "Celestial", "Radiant", "Vacuum", "Ether", "Phantom"
        ];
        const spaceNoun = [
            "Dust", "Shard", "Gas", "Matter", "Singularity", "Residue", "Crystal", "Radiation", "Essence", "Frequency", "Wave", "Goo", "Light", 
            "Shadow", "Mist", "Memory", "Thought", "Time", "Space", "Color", "Silence", "Echo", "Ray", "Beam", "Pulse", "Field", "Force", 
            "Energy", "Power", "Sound", "Heat", "Cold", "Ice", "Fire", "Liquid", "Solid", "Metal", "Life", "Death", "Dimension", "Reality", 
            "Nothing", "Fragment", "Particle", "String", "Loop", "Grid", "Matrix", "Code", "Signal"
        ];
        // 49 * 50 = ~2450 combinations
        const spaceItems = generateItems(spaceAdj, spaceNoun);

        const virusPrefixes = [
            "Xeno", "Necro", "Bio", "Cyto", "Astro", "Cryo", "Pyro", "Neuro", "Omni", "Zeta", "Nano", "Exo", "Retro", "Lympho", "Hemo", "Viro", 
            "Patho", "Chrono", "Techno", "Cyber", "Spectral", "Thalasso", "Ultra", "Mega", "Giga", "Tera", "Peta", "Exa", "Zetta", "Yotta", 
            "Micro", "Pico", "Femto", "Atto", "Zepto", "Yocto", "Auto", "Semi", "Hemi", "Uni", "Bi", "Tri", "Quad", "Penta", "Hexa", "Hepta", 
            "Octa", "Nona", "Deca", "Hyper", "Super", "Meta", "Proto"
        ];
        const virusRoots = [
            "phage", "virus", "pathogen", "scourge", "blight", "plague", "pox", "rot", "wither", "bane", "death", "morph", "doom", "fever", 
            "strain", "vector", "parasite", "symbiote", "glitch", "void", "kill", "murder", "slaughter", "genocide", "suicide", "homicide", 
            "regicide", "deicide", "bacteria", "fungus", "prion", "viroid", "toxin", "venom", "agent", "force", "swarm", "horde", "curse"
        ];
        
        const virusList = [];
        // Increased loop to generate more unique items
        for(let i=0; i<3000; i++) {
            const p = virusPrefixes[Math.floor(Math.random() * virusPrefixes.length)];
            const r = virusRoots[Math.floor(Math.random() * virusRoots.length)];
            const suffix = Math.random() > 0.7 ? `-${String.fromCharCode(65+Math.random()*26)}${Math.floor(Math.random()*9)}` : `-${Math.floor(Math.random()*999)}`;
            virusList.push(`${p.toUpperCase()}${r.toUpperCase()}${suffix}`);
        }

        /* --- 3. SETUP UI --- */
        const starterSelect = document.getElementById('starterSelect');
        const virusSelect = document.getElementById('virusSelect');
        const spaceSelect = document.getElementById('spaceSelect');
        
        // Increased to slice(0, 1500) to add "1000 more" (approx)
        starters.slice(0, 1500).forEach(item => starterSelect.add(new Option(item, item)));
        virusList.slice(0, 1500).forEach(item => virusSelect.add(new Option(item, item)));
        spaceItems.slice(0, 1500).forEach(item => spaceSelect.add(new Option(item, item)));

        /* --- 4. BACKGROUND ANIMATION --- */
        const bgCanvas = document.getElementById('bgCanvas');
        const bgCtx = bgCanvas.getContext('2d');
        let width, height;

        function resizeBg() { 
            width = window.innerWidth; 
            height = window.innerHeight; 
            bgCanvas.width = width; 
            bgCanvas.height = height; 
            
            // Re-init streams on resize to fill the new area
            streams = [];
            for(let i=0; i<60; i++) streams.push(new Stream());
        }
        window.addEventListener('resize', resizeBg);
        
        // Matrix/Bio Rain
        class Stream {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.speed = Math.random() * 2 + 1;
                this.chars = [];
                const len = Math.floor(Math.random() * 15) + 5;
                for(let i=0; i<len; i++) {
                    this.chars.push({
                        char: String.fromCharCode(0x30A0 + Math.random() * 96), // Katakana
                        alpha: (i / len)
                    });
                }
            }
            update() {
                this.y += this.speed;
                if(this.y > height) {
                     this.y = -100;
                     // Randomize X again on loop to prevent clumping patterns over time
                     this.x = Math.random() * width;
                }
            }
            draw() {
                this.chars.forEach((c, i) => {
                    bgCtx.fillStyle = `rgba(0, 255, 65, ${c.alpha * 0.3})`;
                    bgCtx.font = '14px monospace';
                    bgCtx.fillText(c.char, this.x, this.y - i * 15);
                });
            }
        }
        
        let streams = [];
        // Init after ensuring width is set
        resizeBg();

        function animateBg() { 
            bgCtx.clearRect(0, 0, width, height); 
            streams.forEach(s => { s.update(); s.draw(); }); 
            requestAnimationFrame(animateBg); 
        }
        animateBg();

        /* --- 5. INTRO BOOT SEQUENCE --- */
        const bootLog = document.getElementById('bootLog');
        const logs = [
            "BIOS CHECK...", "CPU: QUANTUM CORE [OK]", "MEMORY: 128ZB [OK]", "LOADING KERNEL...",
            "MOUNTING FILE SYSTEM...", "ACCESSING SECURE SECTOR...", "WARNING: BIO-CONTAINMENT ACTIVE",
            "INITIALIZING GRAPHICS ENGINE...", "LOADING... 10%", "LOADING... 34%", "LOADING... 68%",
            "LOADING... 99%", "SYSTEM READY."
        ];

        let introFinished = false;

        async function runIntro() {
            let delay = 100;
            for(let log of logs) {
                const div = document.createElement('div');
                div.className = log.includes('WARNING') ? 'log-line log-warn' : (log.includes('OK') || log.includes('READY')) ? 'log-line log-success' : 'log-line';
                div.textContent = `> ${log}`;
                bootLog.appendChild(div);
                bootLog.scrollTop = bootLog.scrollHeight;
                await new Promise(r => setTimeout(r, Math.random() * 200 + 50));
            }
            
            document.getElementById('mainTitle').classList.remove('hidden');
            await new Promise(r => setTimeout(r, 1000));
            document.getElementById('subTitle').style.opacity = '1';
            
            await new Promise(r => setTimeout(r, 800));
            document.getElementById('startBtn').classList.add('visible');
            
            // Cleanup visual clutter after load
            setTimeout(() => { bootLog.style.opacity = '0'; }, 2000);

            introFinished = true;
        }
        window.onload = runIntro;

        /* --- 6. ULTRA VIRUS RENDER ENGINE --- */
        // Utility Functions
        function hash(str) {
            let h = 0xdeadbeef;
            for(let i=0; i<str.length; i++) h = Math.imul(h ^ str.charCodeAt(i), 2654435761);
            return ((h ^ h >>> 16) >>> 0);
        }
        
        // Deterministic Random Class
        class RNG {
            constructor(seed) { this.seed = seed; }
            next() {
                this.seed = (this.seed * 1664525 + 1013904223) % 4294967296;
                return this.seed / 4294967296;
            }
            range(min, max) { return min + this.next() * (max - min); }
            int(min, max) { return Math.floor(this.range(min, max)); }
            pick(arr) { return arr[this.int(0, arr.length)]; }
        }

        const ANOMALY_TYPES = {
            'DIVINE': { color: '#ffd700', label: 'DIVINE ENTITY' },
            'INFERNO': { color: '#ff4400', label: 'INFERNO CLASS' },
            'VOID': { color: '#888888', label: 'VOID SINGULARITY' },
            'FROST': { color: '#aaffff', label: 'ABSOLUTE ZERO' },
            'TOXIC': { color: '#00ff00', label: 'BIOHAZARD' },
            'GLITCH': { color: '#ff00ff', label: 'SYSTEM ERROR' },
            'NONE': { color: '#555555', label: 'NORMAL' }
        };

        class Virus {
            constructor(seedStr) {
                const seedVal = hash(seedStr);
                this.rng = new RNG(seedVal);
                this.time = 0;
                this.ignited = false;
                this.burnProgress = 0;
                this.particles = []; // For fire effect
                this.survivalRate = 0;
                
                // --- GENERATION LOGIC ---
                // 1. Color Palette (HSL)
                const hue = this.rng.int(0, 360);
                const sat = this.rng.int(60, 100);
                this.colors = {
                    base: `hsla(${hue}, ${sat}%, 50%, 1)`,
                    light: `hsla(${hue}, ${sat}%, 70%, 1)`,
                    glow: `hsla(${hue}, 100%, 60%, 0.5)`,
                    core: `hsla(${(hue + 180) % 360}, 90%, 60%, 1)`
                };

                // 2. Anomaly Check (5% chance)
                this.anomaly = 'NONE';
                if(this.rng.next() > 0.90) {
                    const keys = Object.keys(ANOMALY_TYPES).filter(k => k !== 'NONE');
                    this.anomaly = this.rng.pick(keys);
                    // Override colors
                    if(this.anomaly === 'INFERNO') this.colors = { base: '#f00', light: '#fa0', glow: '#f40', core: '#fff' };
                    if(this.anomaly === 'VOID') this.colors = { base: '#000', light: '#333', glow: '#555', core: '#fff' };
                }

                // 3. Morphology
                this.radius = this.rng.range(60, 90);
                this.spikes = this.rng.int(0, 20); // 0 = smooth/blobby
                this.spikeLength = this.rng.range(10, 60);
                this.layers = this.rng.int(2, 5);
                this.noiseScale = this.rng.range(0.1, 0.8);
                this.pulseRate = this.rng.range(0.02, 0.08);
                
                // 4. Internal Organs (Nuclei, etc)
                this.nucleiCount = this.rng.int(0, 6);
                this.nucleiArr = [];
                for(let i=0; i<this.nucleiCount; i++) {
                    this.nucleiArr.push({
                        x: this.rng.range(-30, 30),
                        y: this.rng.range(-30, 30),
                        r: this.rng.range(5, 15),
                        orbitSpeed: this.rng.range(-0.05, 0.05)
                    });
                }
                
                // 5. Surface Texture
                this.textureType = this.rng.int(0, 4); // 0:None, 1:Spots, 2:Veins, 3:Bands
                
                // 6. Generate Name
                this.name = `STRAIN-${seedVal.toString(16).toUpperCase().substring(0,6)}`;
                
                // 7. Text Generation & Origin Mapping
                this.generateDescription();
            }
            
            generateDescription() {
                // EXPANDED COMBINATORIAL ENGINE ( > 10,000,000 Combinations )

                // 1. TRANSMISSION COMPONENTS
                const transVectors = ["aerosolized", "liquid", "psionic", "digital", "parasitic", "genetic", "quantum", "cosmic", "magnetic", "thermal", "sonic", "viral"];
                const transAgents = ["particles", "nanobots", "spores", "wavelengths", "bacteria", "crystals", "echoes", "shadows", "vapors", "fluids", "codes", "mutations"];
                const transMethods = ["inhaled", "injected", "beamed", "absorbed", "consumed", "transmitted", "downloaded", "grown", "fused", "radiated", "secreted", "manifested"];
                const transLocs = ["upper atmosphere", "contaminated water", "neural-link", "food supply", "solar radiation", "deep web", "infected blood", "ancient ruins", "laboratory air", "dark matter"];

                // 2. TARGET MAPPING
                const targets = [
                    { label: "LUNGS", x: 190, y: 170 }, { label: "CEREBRAL CORTEX", x: 190, y: 90 }, { label: "GASTRIC SYSTEM", x: 190, y: 230 },
                    { label: "OCULAR NERVE", x: 190, y: 100 }, { label: "SOLAR PLEXUS", x: 190, y: 200 }, { label: "DERMAL LAYER", x: 140, y: 200 },
                    { label: "INTESTINAL TRACT", x: 190, y: 240 }, { label: "CIRCULATORY SYSTEM", x: 190, y: 180 }, { label: "SKELETAL STRUCTURE", x: 190, y: 300 },
                    { label: "SPINAL COLUMN", x: 190, y: 140 }, { label: "CARDIAC MUSCLE", x: 200, y: 175 }, { label: "LIVER", x: 180, y: 210 }
                ];
                
                // 3. MECHANISM COMPONENTS
                const mechVerbs = ["rewrites", "liquefies", "crystallizes", "vaporizes", "digitizes", "petrifies", "combusts", "freezes", "teleports", "clones", "deletes", "scrambles"];
                const mechTargets = ["host DNA", "skeletal calcium", "neural pathways", "blood plasma", "cellular mitochondria", "water molecules", "carbon atoms", "synaptic responses", "tissue fibers", "bone marrow"];
                const mechResults = ["silicate structures", "radioactive sludge", "ferrofluid", "binary code", "necrotic dust", "pure energy", "crystalline shards", "sentient tumors", "void matter", "alien biomass"];

                // 4. SYMPTOM COMPONENTS
                const symAdjs = ["profuse", "glowing", "metallic", "translucent", "vibrating", "leaking", "rigid", "spasmodic", "psionic", "necrotic", "hollow", "magnetic"];
                const symParts = ["eyes", "veins", "skin", "bones", "teeth", "fingers", "spine", "pores", "tongue", "nails", "hair", "organs"];
                const symConditions = ["bleeding black ichor", "emitting light", "turning to glass", "growing thorns", "dissolving into gas", "freezing solid", "burning internally", "transmitting radio signals", "becoming invisible", "detaching painlessly"];

                // 5. PROGNOSIS COMPONENTS
                const progTimes = ["4 hours", "20 minutes", "3 days", "10 seconds", "1 week", "2 cycles", "instant", "variable"];
                const progOutcomes = ["total organ failure", "molecular disintegration", "hive-mind assimilation", "dimensional displacement", "biological combustion", "statue-like petrification", "digital ascension", "genetic reset", "liquid dissolution", "crystal cocooning"];

                // SELECTORS
                const tV = this.rng.pick(transVectors);
                const tA = this.rng.pick(transAgents);
                const tM = this.rng.pick(transMethods);
                const tL = this.rng.pick(transLocs);
                
                const targetObj = this.rng.pick(targets);
                this.origin = targetObj; // Important for scanning

                const mV = this.rng.pick(mechVerbs);
                const mT = this.rng.pick(mechTargets);
                const mR = this.rng.pick(mechResults);

                const sA = this.rng.pick(symAdjs);
                const sP = this.rng.pick(symParts);
                const sC = this.rng.pick(symConditions);

                const pT = this.rng.pick(progTimes);
                const pO = this.rng.pick(progOutcomes);

                // CONSTRUCT SENTENCES
                const transStr = `via ${tV} ${tA} ${tM} from ${tL}`;
                const mechStr = `${mV} ${mT} into ${mR}`;
                const symStr = `${sA} ${sP} ${sC}`;
                const progStr = `${pO} within ${pT}`;

                // COLOR CODED: Green, Blue, Red, Purple
                this.desc = `<span style="color:#00ff41; font-weight:bold;">TRANSMISSION:</span> Occurs ${transStr}.<br>
                        <span style="color:#ffcc00; font-weight:bold;">PRIMARY TARGET:</span> ${targetObj.label}<br>
                        <span style="color:#0088ff; font-weight:bold;">MECHANISM:</span> The pathogen ${mechStr}.<br>
                        <span style="color:#ff3333; font-weight:bold;">SYMPTOMS:</span> Victims exhibit ${symStr}.<br>
                        <span style="color:#aa00ff; font-weight:bold;">PROGNOSIS:</span> ${progStr}.`;
            }

            draw(ctx, w, h) {
                this.time++;
                ctx.clearRect(0,0,w,h);
                ctx.save();
                ctx.translate(w/2, h/2);

                if(this.ignited) {
                    this.burnProgress += 0.005;
                    
                    // Darken effect using global composite or filtering
                    // We simulate darkening by drawing a black semi-transparent circle over it later, 
                    // or modulating the colors. Here we simply reduce global alpha for disappearance
                    // and use brightness filter for "darkening"
                    const darkness = Math.max(0, 1 - this.burnProgress * 0.8);
                    ctx.filter = `brightness(${darkness}) grayscale(${this.burnProgress}) blur(${this.burnProgress}px)`;
                    
                    // Disappear
                    ctx.globalAlpha = Math.max(0, 1 - this.burnProgress * 1.2);

                    // FIRE PARTICLES
                    if(Math.random() > 0.2 && this.burnProgress < 0.8) {
                        for(let k=0; k<3; k++) {
                            const angle = Math.random() * Math.PI * 2;
                            const dist = Math.random() * this.radius;
                            this.particles.push({
                                x: Math.cos(angle) * dist,
                                y: Math.sin(angle) * dist,
                                vx: (Math.random() - 0.5) * 2,
                                vy: -Math.random() * 3 - 1,
                                life: 1.0,
                                size: Math.random() * 5 + 2
                            });
                        }
                    }
                }

                // AURA
                const pulse = Math.sin(this.time * this.pulseRate) * 5;
                const auraGrad = ctx.createRadialGradient(0,0, this.radius, 0,0, this.radius * 2 + pulse);
                auraGrad.addColorStop(0, this.colors.glow);
                auraGrad.addColorStop(1, 'transparent');
                ctx.fillStyle = auraGrad;
                ctx.beginPath(); ctx.arc(0,0, this.radius * 2.5, 0, Math.PI*2); ctx.fill();

                // LAYERS (Membranes)
                for(let i = this.layers; i > 0; i--) {
                    ctx.beginPath();
                    const rBase = this.radius * (0.4 + (i/this.layers)*0.6);
                    
                    // Complex Shape Algorithm
                    for(let a=0; a < Math.PI*2; a+=0.05) {
                        // Noise function simulation
                        const n1 = Math.sin(a * (5 + this.spikes) + this.time * 0.02);
                        const n2 = Math.cos(a * 12 - this.time * 0.05);
                        
                        let r = rBase + (n1 * 5 * this.noiseScale) + (n2 * 2);
                        
                        // Spikes?
                        if(this.spikes > 0) {
                            const spikeMod = Math.sin(a * this.spikes);
                            if(spikeMod > 0.8) r += this.spikeLength * spikeMod;
                        }

                        // Wobble
                        r += Math.sin(this.time * 0.1) * 2;

                        const x = Math.cos(a) * r;
                        const y = Math.sin(a) * r;
                        if(a===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                    }
                    ctx.closePath();
                    
                    // Fill Logic
                    if(i === 1) { // Core
                         ctx.fillStyle = this.colors.core;
                         ctx.fill();
                    } else {
                         ctx.fillStyle = `rgba(0,0,0,0.3)`;
                         ctx.strokeStyle = this.colors.base;
                         ctx.lineWidth = 2;
                         ctx.stroke();
                         ctx.fill();
                    }
                }

                // TEXTURE
                if(this.textureType === 1) { // Spots
                    ctx.fillStyle = this.colors.light;
                    for(let i=0; i<8; i++) {
                        const angle = this.time * 0.01 + i;
                        const dist = this.radius * 0.6;
                        ctx.beginPath(); 
                        ctx.arc(Math.cos(angle)*dist, Math.sin(angle)*dist, 4, 0, Math.PI*2);
                        ctx.fill();
                    }
                } else if(this.textureType === 2) { // Veins
                      ctx.strokeStyle = this.colors.light;
                      ctx.lineWidth = 1;
                      ctx.beginPath();
                      for(let i=0; i<6; i++) {
                          ctx.moveTo(0,0);
                          const a = (Math.PI*2/6)*i + this.time*0.01;
                          ctx.quadraticCurveTo(Math.cos(a+0.5)*this.radius*0.5, Math.sin(a+0.5)*this.radius*0.5, Math.cos(a)*this.radius, Math.sin(a)*this.radius);
                      }
                      ctx.stroke();
                }

                // NUCLEI (Floating organs)
                this.nucleiArr.forEach((n, idx) => {
                    const ang = this.time * n.orbitSpeed + idx;
                    const nx = Math.cos(ang) * n.x * 2; // Move in ellipse-ish pattern
                    const ny = Math.sin(ang) * n.y * 2;
                    
                    ctx.fillStyle = '#fff';
                    ctx.shadowColor = this.colors.core;
                    ctx.shadowBlur = 10;
                    ctx.beginPath(); ctx.arc(nx, ny, n.r * (0.8 + Math.sin(this.time*0.1)*0.2), 0, Math.PI*2); ctx.fill();
                    ctx.shadowBlur = 0;
                });

                ctx.restore();

                // DRAW FIRE PARTICLES OVER VIRUS (Reset transform first)
                if(this.ignited && this.particles.length > 0) {
                    ctx.save();
                    ctx.translate(w/2, h/2); // Re-center for particles generated relative to center
                    // No filter for particles so they look bright
                    ctx.globalCompositeOperation = 'lighter';
                    
                    for(let i=this.particles.length-1; i>=0; i--) {
                        let p = this.particles[i];
                        p.x += p.vx;
                        p.y += p.vy;
                        p.life -= 0.05;
                        p.size *= 0.95;
                        
                        if(p.life <= 0) {
                            this.particles.splice(i, 1);
                            continue;
                        }
                        
                        const grad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size * 2);
                        grad.addColorStop(0, `rgba(255, 200, 50, ${p.life})`);
                        grad.addColorStop(0.5, `rgba(255, 50, 0, ${p.life * 0.8})`);
                        grad.addColorStop(1, `rgba(50, 0, 0, 0)`);
                        
                        ctx.fillStyle = grad;
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size * 2, 0, Math.PI*2);
                        ctx.fill();
                    }
                    ctx.restore();
                }
            }
        }

        /* --- 7. GAME LOGIC --- */
        let currentVirus = null;
        const vCanvas = document.getElementById('virusCanvas');
        const vCtx = vCanvas.getContext('2d');
        
        function startGame() {
            document.getElementById('introScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            gameLoop();
        }

        function synthesizeVirus() {
            const s1 = document.getElementById('starterSelect').value;
            const s2 = document.getElementById('virusSelect').value;
            const s3 = document.getElementById('spaceSelect').value;
            
            // Generate
            const seed = `${s1}-${s2}-${s3}`;
            currentVirus = new Virus(seed);
            
            // UI Update
            document.getElementById('emptyState').style.opacity = '0';
            const readout = document.getElementById('dataReadout');
            
            // Stats Bars Calculation (Deterministic)
            const lethality = currentVirus.rng.int(50, 100);
            const spread = currentVirus.rng.int(30, 90);
            const resist = currentVirus.rng.int(10, 80);

            // Calculate Overall Score
            const overallScore = Math.floor((lethality + spread + resist) / 3);
            let dangerLabel = "SAFE";
            let dangerColor = "#00ff41";
            if(overallScore > 40) { dangerLabel = "DANGEROUS"; dangerColor = "#ffff00"; }
            if(overallScore > 75) { dangerLabel = "EXTREMELY DANGEROUS"; dangerColor = "#ff0000"; }
            
            // REVERSED SURVIVAL LOGIC
            // High Score (Dangerous) -> Low Survival
            // Low Score (Safe) -> High Survival
            let survivalBase = 100 - overallScore; 
            // Add variance
            survivalBase += (Math.random() * 10 - 5); 
            // Clamp
            currentVirus.survivalRate = Math.max(0.001, Math.min(99.999, survivalBase));

            const anomalyData = ANOMALY_TYPES[currentVirus.anomaly];

            readout.innerHTML = `
                <div class="stat-line">
                    <span class="stat-label">DESIGNATION</span>
                    <span class="text-white font-bold tracking-widest">${currentVirus.name}</span>
                </div>
                <div class="stat-line">
                    <span class="stat-label">CLASS</span>
                    <span style="color:${anomalyData.color}" class="font-bold tracking-widest animate-pulse">${anomalyData.label}</span>
                </div>
                <div class="stat-line">
                    <span class="stat-label">LETHALITY</span>
                    <div class="w-full bg-green-900/30 h-2 border border-green-900"><div style="width:${lethality}%; background:${currentVirus.colors.base}" class="h-full shadow-[0_0_10px_currentColor]"></div></div>
                </div>
                <div class="stat-line">
                    <span class="stat-label">CONTAGION</span>
                    <div class="w-full bg-green-900/30 h-2 border border-green-900"><div style="width:${spread}%; background:${currentVirus.colors.light}" class="h-full shadow-[0_0_10px_currentColor]"></div></div>
                </div>
                 <div class="stat-line">
                    <span class="stat-label">RESISTANCE</span>
                    <div class="w-full bg-green-900/30 h-2 border border-green-900"><div style="width:${resist}%; background:${currentVirus.colors.core}" class="h-full shadow-[0_0_10px_currentColor]"></div></div>
                </div>
                <div class="stat-line">
                    <span class="stat-label text-red-500 font-black">OVERALL</span>
                    <div class="w-full bg-red-900/20 h-3 border border-red-900 relative">
                        <div style="width:${overallScore}%; background:#ff0000;" class="h-full shadow-[0_0_15px_#ff0000]"></div>
                    </div>
                </div>
                <div class="text-center font-bold tracking-[0.3em] text-xs border-b border-gray-800 pb-2 mb-2" style="color:${dangerColor}; text-shadow:0 0 10px ${dangerColor}">
                    // STATUS: ${dangerLabel} //
                </div>
                <div class="mt-2 text-xs text-gray-400 font-normal border-t border-green-900/50 pt-2 leading-relaxed">
                    ${currentVirus.desc}
                </div>
            `;
            
            document.getElementById('previewBtn').classList.add('active');
        }

        function igniteVirus() {
            if(!currentVirus) return;

            // Check for Immunity
            if(currentVirus.anomaly === 'INFERNO') {
                const prev = document.getElementById('dataReadout').innerHTML;
                document.getElementById('dataReadout').innerHTML = `
                    <div class="flex h-full flex-col items-center justify-center text-orange-500 font-bold animate-pulse border-4 border-orange-500 bg-black">
                        <div class="text-2xl font-['Orbitron']">ERROR: FAILURE</div>
                        <div class="text-sm tracking-widest mt-2 text-center">TARGET IMMUNE TO THERMAL IGNITION<br>INFERNO CLASS DETECTED</div>
                    </div>
                `;
                // Revert text after 2 seconds
                setTimeout(() => {
                    document.getElementById('dataReadout').innerHTML = prev;
                }, 2500);
                return;
            }

            // Valid Ignition
            currentVirus.ignited = true;
            document.getElementById('dataReadout').innerHTML = `
                <div class="flex h-full flex-col items-center justify-center text-red-500 font-bold animate-pulse">
                    <div class="text-2xl font-['Orbitron']">IGNITION SEQUENCE</div>
                    <div class="text-xs tracking-widest mt-2">THERMAL INCINERATION ACTIVE</div>
                </div>
            `;
            document.getElementById('previewBtn').classList.remove('active');
            
            setTimeout(() => {
                currentVirus = null;
                vCtx.clearRect(0,0,360,360);
                document.getElementById('emptyState').style.opacity = '1';
                document.getElementById('dataReadout').innerHTML = `
                    <div class="flex h-full items-center justify-center text-green-900 tracking-[0.2em] font-bold text-xs">
                    // SYSTEM IDLE - READY //
                    </div>
                `;
            }, 3000); // Increased time for animation
        }

        function gameLoop() {
            if(currentVirus) currentVirus.draw(vCtx, 360, 360);
            requestAnimationFrame(gameLoop);
        }

        /* --- 8. PREVIEW SIMULATION (Targeted Infection Logic) --- */
        let hCtx = document.getElementById('humanCanvas').getContext('2d');
        let scanId;
        
        // Define Human Path (Simple Silhouette)
        const humanPath = new Path2D("M190,80 C210,80 220,95 220,115 C220,135 210,145 190,145 C170,145 160,135 160,115 C160,95 170,80 190,80 M165,150 L140,250 L150,260 L170,190 L170,280 L160,380 L180,390 L190,290 L200,390 L220,380 L210,280 L210,190 L230,260 L240,250 L215,150 Z");

        function openScan() {
            if(!currentVirus) return;
            document.getElementById('scanOverlay').classList.add('active');
            
            // Generate Text
            const time = currentVirus.rng.int(2, 48) + " HOURS";
            document.getElementById('timeToDeath').innerText = time;
            
            // Dynamic Survival Text Color (Green = High/Safe, Red = Low/Dangerous)
            let sRate = currentVirus.survivalRate.toFixed(3);
            let sColor = sRate > 80 ? 'text-green-500' : (sRate > 40 ? 'text-yellow-500' : 'text-red-500');
            document.getElementById('survivalText').className = `text-right ${sColor} font-bold`;
            document.getElementById('survivalText').innerText = sRate + "%";

            document.getElementById('clinicalText').innerHTML = `
                <strong class="text-green-400">PATHOGEN ID:</strong> ${currentVirus.name}<br>
                <strong class="text-green-400">VECTOR:</strong> Unknown Cosmic/Terra Hybrid<br><br>
                <span class="text-red-400">> CRITICAL FAILURE DETECTED</span><br>
                ${currentVirus.desc}
            `;
            
            scanY = 0;
            infectionRadius = 0; // Reset spread
            animateScan();
        }

        function closeScan() {
            document.getElementById('scanOverlay').classList.remove('active');
            cancelAnimationFrame(scanId);
        }

        let scanY = 0;
        let infectionRadius = 0;

        function animateScan() {
            hCtx.fillStyle = '#000';
            hCtx.fillRect(0,0,380,420);
            
            // Draw Human
            hCtx.strokeStyle = '#004400';
            hCtx.lineWidth = 2;
            hCtx.stroke(humanPath);
            hCtx.fillStyle = 'rgba(0, 50, 0, 0.5)';
            hCtx.fill(humanPath);

            // Draw Organs (Abstract) - Fixed Positions
            hCtx.fillStyle = 'rgba(0,100,0,0.5)';
            hCtx.beginPath(); hCtx.arc(190, 170, 10, 0, Math.PI*2); hCtx.fill(); // Heart
            hCtx.beginPath(); hCtx.ellipse(175, 170, 8, 15, 0, 0, Math.PI*2); hCtx.fill(); // Lung L
            hCtx.beginPath(); hCtx.ellipse(205, 170, 8, 15, 0, 0, Math.PI*2); hCtx.fill(); // Lung R

            // --- INFECTION SPREAD ANIMATION ---
            // Slowly increase the radius of infection
            if(infectionRadius < 300) {
                infectionRadius += 0.5;
            }

            // Draw infection clipped to human body
            hCtx.save();
            hCtx.clip(humanPath); // Ensure infection doesn't spill outside body
            
            hCtx.fillStyle = currentVirus.colors.glow;
            hCtx.globalCompositeOperation = 'source-atop'; 
            
            hCtx.beginPath();
            // Origin comes from the specific virus description now
            hCtx.arc(currentVirus.origin.x, currentVirus.origin.y, infectionRadius, 0, Math.PI*2);
            hCtx.fill();
            
            hCtx.restore();

            // Scan Line
            scanY = (scanY + 2) % 500;
            hCtx.beginPath();
            hCtx.moveTo(0, scanY); hCtx.lineTo(380, scanY);
            hCtx.strokeStyle = '#00ff00';
            hCtx.lineWidth = 2;
            hCtx.shadowColor = '#0f0'; hCtx.shadowBlur = 10;
            hCtx.stroke();
            hCtx.shadowBlur = 0;

            // Scan Data Text
            hCtx.font = "10px monospace";
            hCtx.fillStyle = "#0f0";
            hCtx.fillText(`Z-SLICE: ${scanY}`, 10, scanY - 5);
            hCtx.fillText("ANALYZING TISSUE...", 250, scanY - 5);
            hCtx.fillText(`TARGET: ${currentVirus.origin.label}`, 10, 400);

            scanId = requestAnimationFrame(animateScan);
        }

    </script>
</body>
</html>
