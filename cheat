-- SERVICES
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

-- SETTINGS & STATES
local lp = Players.LocalPlayer
local camera = workspace.CurrentCamera
local enabled = false
local espEnabled = false
local visualEnabled = false
local flyEnabled = false
local instantReload = false
local wallbangEnabled = false
local clicking = false
local dragging = false
local flySpeed = 50

-- 1. PREMIUM UI CONSTRUCTION (EXPANDED)
local sg = Instance.new("ScreenGui")
sg.Name = "MasterLock_V5_Ultra"
sg.IgnoreGuiInset = true
sg.ResetOnSpawn = false
sg.Parent = lp:WaitForChild("PlayerGui")

local main = Instance.new("Frame")
main.Size = UDim2.new(0, 240, 0, 500)
main.Position = UDim2.new(1, -260, 0.5, -250)
main.BackgroundColor3 = Color3.fromRGB(12, 12, 14)
main.BorderSizePixel = 0
main.Active = true
main.Draggable = true 
main.Visible = true -- Ensuring it starts visible
main.Parent = sg

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 15)
mainCorner.Parent = main

local mainStroke = Instance.new("UIStroke")
mainStroke.Thickness = 2
mainStroke.Color = Color3.fromRGB(40, 40, 45)
mainStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
mainStroke.Parent = main

local header = Instance.new("Frame")
header.Size = UDim2.new(1, 0, 0, 50)
header.BackgroundColor3 = Color3.fromRGB(18, 18, 22)
header.BorderSizePixel = 0
header.Parent = main

local headerCorner = Instance.new("UICorner")
headerCorner.CornerRadius = UDim.new(0, 15)
headerCorner.Parent = header

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 1, 0)
title.BackgroundTransparency = 1
title.Text = "MASTERLOCK V5 PREMIUM"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBlack
title.TextSize = 15
title.Parent = header

local accentLine = Instance.new("Frame")
accentLine.Size = UDim2.new(1, 0, 0, 2)
accentLine.Position = UDim2.new(0, 0, 1, -2)
accentLine.BackgroundColor3 = Color3.fromRGB(0, 255, 127)
accentLine.BorderSizePixel = 0
accentLine.Parent = header

-- TOGGLE GENERATOR FUNCTION
local function createButton(name, key, yPos)
    local btnFrame = Instance.new("Frame")
    btnFrame.Size = UDim2.new(0.9, 0, 0, 55)
    btnFrame.Position = UDim2.new(0.05, 0, 0, yPos)
    btnFrame.BackgroundColor3 = Color3.fromRGB(22, 22, 26)
    btnFrame.Parent = main
    Instance.new("UICorner", btnFrame).CornerRadius = UDim.new(0, 10)
    Instance.new("UIStroke", btnFrame).Color = Color3.fromRGB(35, 35, 40)

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.6, 0, 1, 0)
    label.Position = UDim2.new(0.05, 0, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = name .. " [" .. key .. "]"
    label.TextColor3 = Color3.fromRGB(220, 220, 220)
    label.Font = Enum.Font.GothamMedium
    label.TextSize = 13
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = btnFrame

    local toggleBg = Instance.new("Frame")
    toggleBg.Size = UDim2.new(0, 46, 0, 24)
    toggleBg.Position = UDim2.new(0.95, -46, 0.5, -12)
    toggleBg.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    toggleBg.Parent = btnFrame
    Instance.new("UICorner", toggleBg).CornerRadius = UDim.new(1, 0)

    local pill = Instance.new("Frame")
    pill.Size = UDim2.new(0, 20, 0, 20)
    pill.Position = UDim2.new(0, 2, 0.5, -10)
    pill.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    pill.Parent = toggleBg
    Instance.new("UICorner", pill).CornerRadius = UDim.new(1, 0)

    return toggleBg, pill
end

local lockBg, lockPill = createButton("Aimbot", "L", 65)
local espBg, espPill = createButton("Player ESP", ";", 125)
local visualBg, visualPill = createButton("Visuals", "K", 185)
local flyBg, flyPill = createButton("Flight", "I", 245)
local reloadBg, reloadPill = createButton("Instant Reload", "[", 305)
local wallBg, wallPill = createButton("Wallbang", "P", 365)

-- SLIDER (EXPANDED)
local sliderContainer = Instance.new("Frame")
sliderContainer.Size = UDim2.new(0.9, 0, 0, 50)
sliderContainer.Position = UDim2.new(0.05, 0, 0, 430)
sliderContainer.BackgroundColor3 = Color3.fromRGB(22, 22, 26)
sliderContainer.Parent = main
Instance.new("UICorner", sliderContainer).CornerRadius = UDim.new(0, 10)

local sTitle = Instance.new("TextLabel")
sTitle.Size = UDim2.new(1, 0, 0, 25)
sTitle.BackgroundTransparency = 1
sTitle.Text = "FLIGHT SPEED: 50"
sTitle.TextColor3 = Color3.fromRGB(150, 150, 150)
sTitle.Font = Enum.Font.GothamBold
sTitle.TextSize = 11
sTitle.Parent = sliderContainer

local sBack = Instance.new("Frame")
sBack.Size = UDim2.new(0.85, 0, 0, 5)
sBack.Position = UDim2.new(0.075, 0, 0.7, 0)
sBack.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
sBack.BorderSizePixel = 0
sBack.Parent = sliderContainer
Instance.new("UICorner", sBack)

local sMain = Instance.new("Frame")
sMain.Size = UDim2.new(0.2, 0, 1, 0)
sMain.BackgroundColor3 = Color3.fromRGB(0, 255, 127)
sMain.BorderSizePixel = 0
sMain.Parent = sBack
Instance.new("UICorner", sMain)

local sBtn = Instance.new("TextButton")
sBtn.Size = UDim2.new(1, 0, 1, 0)
sBtn.BackgroundTransparency = 1
sBtn.Text = ""
sBtn.Parent = sBack

-- 2. ANIMATION LOGIC
local function updateUI(state, pill, bg)
    local targetPos = state and UDim2.new(1, -22, 0.5, -10) or UDim2.new(0, 2, 0.5, -10)
    local targetCol = state and Color3.fromRGB(0, 255, 127) or Color3.fromRGB(40, 40, 45)
    TweenService:Create(pill, TweenInfo.new(0.2, Enum.EasingStyle.Back), {Position = targetPos}):Play()
    TweenService:Create(bg, TweenInfo.new(0.2), {BackgroundColor3 = targetCol}):Play()
end

-- 3. ESP & HEALTH BAR ENGINE
local function applyESP(player)
    if player == lp then return end
    local function addVisuals()
        local char = player.Character or player.CharacterAdded:Wait()
        local root = char:WaitForChild("HumanoidRootPart", 10)
        if not root then return end

        local highlight = char:FindFirstChild("ESPHighlight") or Instance.new("Highlight", char)
        highlight.Name = "ESPHighlight"
        highlight.FillTransparency = 0.5
        highlight.Enabled = espEnabled

        local bgui = char:FindFirstChild("HealthVisual") or Instance.new("BillboardGui", char)
        bgui.Name = "HealthVisual"
        bgui.Size = UDim2.new(4, 0, 0.6, 0)
        bgui.Adornee = root
        bgui.AlwaysOnTop = true
        bgui.ExtentsOffset = Vector3.new(-2.8, 0, 0)
        bgui.Enabled = espEnabled

        local back = bgui:FindFirstChild("Back") or Instance.new("Frame", bgui)
        back.Name = "Back"
        back.Size = UDim2.new(0.12, 0, 1, 0)
        back.BackgroundColor3 = Color3.new(0, 0, 0)

        local bar = back:FindFirstChild("Bar") or Instance.new("Frame", back)
        bar.Name = "Bar"
        bar.Size = UDim2.new(1, 0, 1, 0)
        bar.BackgroundColor3 = Color3.new(0, 1, 0)
        bar.BorderSizePixel = 0

        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then
            hum.HealthChanged:Connect(function()
                local p = math.clamp(hum.Health / hum.MaxHealth, 0, 1)
                bar.Size = UDim2.new(1, 0, p, 0)
                bar.Position = UDim2.new(0, 0, 1-p, 0)
                bar.BackgroundColor3 = Color3.fromHSV(p * 0.3, 1, 1)
            end)
        end
    end
    player.CharacterAdded:Connect(addVisuals)
    addVisuals()
end

for _, p in pairs(Players:GetPlayers()) do applyESP(p) end
Players.PlayerAdded:Connect(applyESP)

-- 4. CHEAT LOGIC
local bv, bg_gyro
RunService.Heartbeat:Connect(function()
    if flyEnabled and lp.Character and lp.Character:FindFirstChild("HumanoidRootPart") then
        if not bv then
            bv = Instance.new("BodyVelocity", lp.Character.HumanoidRootPart)
            bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            bg_gyro = Instance.new("BodyGyro", lp.Character.HumanoidRootPart)
            bg_gyro.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
            lp.Character.Humanoid.PlatformStand = true
        end
        bg_gyro.CFrame = camera.CFrame
        local dir = Vector3.new(0,0,0)
        if UIS:IsKeyDown(Enum.KeyCode.W) then dir = dir + camera.CFrame.LookVector end
        if UIS:IsKeyDown(Enum.KeyCode.S) then dir = dir - camera.CFrame.LookVector end
        if UIS:IsKeyDown(Enum.KeyCode.D) then dir = dir + camera.CFrame.RightVector end
        if UIS:IsKeyDown(Enum.KeyCode.A) then dir = dir - camera.CFrame.RightVector end
        bv.Velocity = dir * flySpeed
    elseif bv then
        bv:Destroy() bv = nil
        bg_gyro:Destroy() bg_gyro = nil
        if lp.Character and lp.Character:FindFirstChild("Humanoid") then lp.Character.Humanoid.PlatformStand = false end
    end

    if instantReload and lp.Character then
        local hum = lp.Character:FindFirstChildOfClass("Humanoid")
        if hum then
            for _, t in pairs(hum:GetPlayingAnimationTracks()) do
                if t.Name:lower():find("reload") then t:AdjustSpeed(10) end
            end
        end
    end

    if dragging then
        local mousePos = UIS:GetMouseLocation().X
        local rel = math.clamp((mousePos - sBack.AbsolutePosition.X) / sBack.AbsoluteSize.X, 0, 1)
        sMain.Size = UDim2.new(rel, 0, 1, 0)
        flySpeed = math.floor(10 + (rel * 490))
        sTitle.Text = "FLIGHT SPEED: " .. tostring(flySpeed)
    end
end)

-- 5. INPUTS & HIDE FEATURE
UIS.InputBegan:Connect(function(input, proc)
    if input.KeyCode == Enum.KeyCode.RightControl then -- HIDE TOGGLE
        main.Visible = not main.Visible
    end

    if proc then return end
    if input.KeyCode == Enum.KeyCode.L then enabled = not enabled updateUI(enabled, lockPill, lockBg)
    elseif input.KeyCode == Enum.KeyCode.Semicolon then 
        espEnabled = not espEnabled updateUI(espEnabled, espPill, espBg)
        for _, p in pairs(Players:GetPlayers()) do if p.Character then 
            if p.Character:FindFirstChild("ESPHighlight") then p.Character.ESPHighlight.Enabled = espEnabled end
            if p.Character:FindFirstChild("HealthVisual") then p.Character.HealthVisual.Enabled = espEnabled end
        end end
    elseif input.KeyCode == Enum.KeyCode.K then visualEnabled = not visualEnabled updateUI(visualEnabled, visualPill, visualBg)
    elseif input.KeyCode == Enum.KeyCode.I then flyEnabled = not flyEnabled updateUI(flyEnabled, flyPill, flyBg)
    elseif input.KeyCode == Enum.KeyCode.LeftBracket then instantReload = not instantReload updateUI(instantReload, reloadPill, reloadBg)
    elseif input.KeyCode == Enum.KeyCode.P then wallbangEnabled = not wallbangEnabled updateUI(wallbangEnabled, wallPill, wallBg)
    end
    if input.UserInputType == Enum.UserInputType.MouseButton2 then clicking = true end
end)

UIS.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then clicking = false end
    if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
end)

sBtn.MouseButton1Down:Connect(function() dragging = true end)

RunService.RenderStepped:Connect(function()
    if enabled and clicking then
        local target = nil
        local dist = math.huge
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= lp and p.Character and p.Character:FindFirstChild("Head") and p.Character.Humanoid.Health > 0 then
                local pos, vis = camera:WorldToViewportPoint(p.Character.Head.Position)
                if vis then
                    local mag = (Vector2.new(pos.X, pos.Y) - UIS:GetMouseLocation()).Magnitude
                    if mag < dist then dist = mag target = pos end
                end
            end
        end
        if target and mousemoverel then
            local mPos = UIS:GetMouseLocation()
            mousemoverel(target.X - mPos.X, target.Y - mPos.Y)
        end
    end
end)
