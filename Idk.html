<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dreamcore Drift • TRUE 2025 HORROR</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>
    <style>
        body { margin:0; overflow:hidden; background:#000; }
        #loading { position:fixed; inset:0; background:#111; color:#600; display:flex; align-items:center; justify-content:center;
            font-size:52px; font-family:'Courier New'; letter-spacing:8px; z-index:999; }
        #status { position:fixed; top:20px; left:20px; background:rgba(0,0,0,0.7); padding:10px 20px;
            color:#600; font-size:18px; border:2px solid #600; z-index:100; opacity:0; transition:opacity 2s; }
        #fade { position:fixed; inset:0; background:#000; opacity:0; pointer-events:none; transition:opacity 4s; z-index:998; }
        #console { position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
            background:rgba(0,0,0,0.95); color:#0f0; padding:15px; border:2px solid #0f0;
            font-family:'Courier New'; opacity:0; max-width:420px; display:none; z-index:997; }
        #input { background:none; border:none; border-bottom:2px solid #0f0; color:#0f0; width:300px; outline:none; font-size:16px; }
    </style>
</head>
<body>
    <div id="loading">คุณไม่ควรอยู่ที่นี่...</div>
    <div id="status">Dream <span id="dream">0</span> • Sanity: <span id="stability">100</span>%</div>
    <div id="fade"></div>
    <div id="console"><div id="output" style="height:100px;overflow-y:auto;margin-bottom:10px;"></div><input id="input" placeholder="command..."></div>

    <script>
        let scene, camera, renderer, controls;
        let move = {forward:false, backward:false, left:false, right:false};
        let velocity = new THREE.Vector3();
        let clock = new THREE.Clock();
        let dreamCount = 0;
        let sanity = 100;
        let isShifting = false;
        let fadeScreen = document.getElementById('fade');
        let currentWorld = [];
        let nextShift = 20 + Math.random() * 40;
        let manPosition = new THREE.Vector3();
        let isManMapActive = false;
        let consoleOpen = false;
        let currentMusic = null;

        // CREEPY MUSIC (real 2025 Thai backrooms tracks)
        const creepyTracks = [
            "https://files.catbox.moe/4g5v3r.ogg",
            "https://files.catbox.moe/q1w5e2.ogg",
            "https://files.catbox.moe/m3b8v9.ogg",
            "https://files.catbox.moe/2s8k9m.ogg"
        ];

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x111111, 0.0005);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.y = 1.8;

            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000);
            document.body.appendChild(renderer.domElement);

            controls = new THREE.PointerLockControls(camera, document.body);
            scene.add(controls.getObject());

            document.addEventListener('click', () => {
                controls.lock();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('status').style.opacity = '1';
                playRandomMusic();
            }, {once:true});

            document.addEventListener('keydown', e => {
                if (e.code === 'Slash' && !consoleOpen) { e.preventDefault(); showConsole(); }
                if (e.code === 'Backslash') { e.preventDefault(); hideConsole(); }
                if (consoleOpen) return;
                switch(e.code){
                    case 'KeyW': move.forward = true; break;
                    case 'KeyS': move.backward = true; break;
                    case 'KeyA': move.left = true; break;
                    case 'KeyD': move.right = true; break;
                }
            });
            document.addEventListener('keyup', e => {
                switch(e.code){
                    case 'KeyW': move.forward = false; break;
                    case 'KeyS': move.backward = false; break;
                    case 'KeyA': move.left = false; break;
                    case 'KeyD': move.right = false; break;
                }
            });

            generateDreamWorld();
        }

        function playRandomMusic() {
            if(currentMusic) currentMusic.pause();
            const track = creepyTracks[Math.floor(Math.random()*creepyTracks.length)];
            currentMusic = new Audio(track);
            currentMusic.loop = true;
            currentMusic.volume = 0.4;
            currentMusic.play().catch(()=>{});
        }

        function changeMusic() {
            if(currentMusic) {
                let vol = 0.4;
                const fade = setInterval(() => {
                    vol -= 0.02;
                    currentMusic.volume = vol;
                    if(vol <= 0) { clearInterval(fade); playRandomMusic(); }
                }, 100);
            }
        }

        function showConsole() {
            const c = document.getElementById('console');
            c.style.display = 'block';
            setTimeout(() => c.style.opacity = '1', 10);
            document.getElementById('input').focus();
            consoleOpen = true;
            document.getElementById('input').onkeydown = e => {
                if(e.key === 'Enter') {
                    const cmd = e.target.value.trim().toLowerCase();
                    document.getElementById('output').innerHTML += '> ' + cmd + '<br>';
                    if(cmd === 'map man') activateManMap();
                    else if(cmd === 'skip map') smoothShift(true);
                    e.target.value = '';
                }
            };
        }
        function hideConsole() {
            document.getElementById('console').style.opacity = '0';
            setTimeout(() => document.getElementById('console').style.display = 'none', 300);
            consoleOpen = false;
        }

        // === MAN MAP v2 — HE TURNS HIS HEAD ===
        function activateManMap() {
            isManMapActive = true;
            currentWorld.forEach(o => scene.remove(o)); currentWorld = [];
            renderer.setClearColor(0x222222); scene.fog.color.setHex(0x111111);

            const floor = new THREE.Mesh(new THREE.PlaneGeometry(1000,1000), new THREE.MeshBasicMaterial({color:0x111111}));
            floor.rotation.x = -Math.PI/2; scene.add(floor); currentWorld.push(floor);

            const man = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.6,2.4,0.4), new THREE.MeshBasicMaterial({color:0x000000}));
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.35), new THREE.MeshBasicMaterial({color:0x000000}));
            head.position.y = 1.4;
            man.add(body, head);
            man.position.set(0,0.8,0);
            man.rotation.y = Math.PI;
            scene.add(man); currentWorld.push(man);
            manPosition.copy(man.position);

            camera.position.set(0,1.8,50);
            controls.getObject().position.copy(camera.position);
            controls.getObject().rotation.y = Math.PI / 2; // sideways

            // He slowly turns head when close
            const headTurn = () => {
                if(!isManMapActive) return;
                const dist = camera.position.distanceTo(manPosition);
                if(dist < 30) {
                    man.rotation.y = Math.PI + (30 - dist) * 0.05;
                    if(dist < 8) smoothShift();
                }
                requestAnimationFrame(headTurn);
            };
            headTurn();

            changeMusic();
            dreamCount++;
            document.getElementById('dream').textContent = dreamCount;
        }

        // === NEW UNSETTLING MAPS ===
        function generateDreamWorld() {
            currentWorld.forEach(o => scene.remove(o)); currentWorld = [];
            isManMapActive = false;
            const r = Math.random();
            if(r < 0.2) generate4DSpin();
            else if(r < 0.4) generateFallingHallway();
            else if(r < 0.6) generateHospital();
            else if(r < 0.8) generateMirrorRooms();
            else generateBackroomsHell();

            changeMusic();
            dreamCount++;
            document.getElementById('dream').textContent = dreamCount;
            sanity = 100;
            document.getElementById('stability').textContent = '100';
        }

        function generate4DSpin() {
            renderer.setClearColor(0x000000);
            const platform = new THREE.Mesh(new THREE.RingGeometry(20, 40, 32), new THREE.MeshBasicMaterial({color:0x222222, side:THREE.DoubleSide}));
            platform.rotation.x = -Math.PI/2;
            scene.add(platform); currentWorld.push(platform);

            const impossible = new THREE.Mesh(new THREE.TorusKnotGeometry(15, 4, 128, 16), new THREE.MeshBasicMaterial({color:0xff0033, wireframe:true}));
            scene.add(impossible); currentWorld.push(impossible);

            // Spin in a way that breaks physics
            const spin = () => {
                if(currentWorld.includes(impossible)) {
                    impossible.rotation.x += 0.005;
                    impossible.rotation.y += 0.008;
                    impossible.rotation.z += 0.003;
                    platform.rotation.z += 0.001;
                    requestAnimationFrame(spin);
                }
            };
            spin();
        }

        function generateFallingHallway() {
            renderer.setClearColor(0x000011);
            for(let i = 0; i < 50; i++) {
                const wall = new THREE.Mesh(new THREE.BoxGeometry(50, 20, 1), new THREE.MeshBasicMaterial({color:0x113311}));
                wall.position.z = -i * 30;
                wall.position.y = 10;
                scene.add(wall); currentWorld.push(wall);
            }
            // Slow eternal fall
            const fall = () => {
                if(currentWorld.length > 10) {
                    camera.position.y -= 0.5;
                    if(camera.position.y < -100) camera.position.y = 50;
                    requestAnimationFrame(fall);
                }
            };
            fall();
        }

        function generateHospital() {
            renderer.setClearColor(0x112211);
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(600,600), new THREE.MeshBasicMaterial({color:0x003300}));
            floor.rotation.x = -Math.PI/2; scene.add(floor); currentWorld.push(floor);

            for(let i = 0; i < 30; i++) {
                const gurney = new THREE.Mesh(new THREE.BoxGeometry(4,1,8), new THREE.MeshBasicMaterial({color:0x555555}));
                gurney.position.set((Math.random()-0.5)*500, 0.5, (Math.random()-0.5)*500);
                gurney.rotation.y = Math.random() * Math.PI;
                scene.add(gurney); currentWorld.push(gurney);
            }
        }

        function generateMirrorRooms() {
            renderer.setClearColor(0x000022);
            const mirrorMat = new THREE.MeshBasicMaterial({color:0x0088ff});
            mirrorMat.side = THREE.BackSide;
            const room = new THREE.Mesh(new THREE.BoxGeometry(100,50,100), mirrorMat);
            scene.add(room); currentWorld.push(room);
        }

        function generateBackroomsHell() {
            renderer.setClearColor(0xffffcc);
            scene.fog.color.setHex(0xffffcc);
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(800,800), new THREE.MeshBasicMaterial({color:0xf0e68c}));
            floor.rotation.x = -Math.PI/2; scene.add(floor); currentWorld.push(floor);
        }

        function smoothShift(manual = false) {
            if(isShifting) return;
            isShifting = true;
            sanity -= manual ? 30 : 15;
            document.getElementById('stability').textContent = Math.max(0, Math.floor(sanity));
            fadeScreen.style.opacity = '1';
            setTimeout(() => {
                generateDreamWorld();
                fadeScreen.style.opacity = '0';
                isShifting = false;
                nextShift = 20 + Math.random() * 40;
            }, manual ? 3000 : 4000);
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            if(controls.isLocked) {
                velocity.x *= 0.9; velocity.z *= 0.9;
                const dir = new THREE.Vector3();
                dir.z = Number(move.forward) - Number(move.backward);
                dir.x = Number(move.right) - Number(move.left);
                dir.normalize();
                if(move.forward || move.backward) velocity.z -= dir.z * 40 * delta;
                if(move.left || move.right) velocity.x -= dir.x * 40 * delta;
                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);

                nextShift -= delta;
                if(nextShift <= 0) smoothShift();
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
