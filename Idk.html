
import React, { useState, useEffect, useRef } from 'react';
import { joinRoom } from 'https://esm.sh/trystero@0.22.0/torrent';
import { SHAPES, COLORS, ITEMS, getPixelDef, MAP_SIZE, MOVE_SPEED, THROW_FORCE, THROW_DECAY, GAME_STATE } from './constants';
import { Player, WorldItem, Vector2 } from './types';

// --- COMPONENTS ---

// 1. Detailed Pixel Art Component
const PixelItem = ({ index, size = 10 }: { index: number, size?: number }) => {
  if (index === -1 || !ITEMS[index]) return null;
  const itemDef = ITEMS[index];
  const pixelDef = getPixelDef(itemDef.type);
  
  return (
    <svg 
      viewBox={`0 0 ${pixelDef.w} ${pixelDef.h}`} 
      width={size * 4} 
      height={size * 4} 
      style={{ imageRendering: 'pixelated', overflow: 'visible' }}
    >
      <filter id="pixel-drop-shadow">
        <feDropShadow dx="0.5" dy="0.5" stdDeviation="0" floodColor="rgba(0,0,0,0.3)"/>
      </filter>
      <g filter="url(#pixel-drop-shadow)">
        {pixelDef.paths.map((p: any, i: number) => (
          <path 
            key={i} 
            d={p.d} 
            fill={p.color === 'var(--item-color)' ? itemDef.color : p.color} 
            stroke="none"
          />
        ))}
      </g>
    </svg>
  );
};

// 2. World Item (Dropped on ground)
const WorldItemComponent = ({ item }: { item: WorldItem }) => {
  return (
    <div 
      className="absolute flex items-center justify-center item-float z-10"
      style={{
        transform: `translate(${item.position.x}px, ${item.position.y}px)`,
      }}
    >
      <PixelItem index={item.itemIndex} size={6} />
    </div>
  );
};

// 3. Player Avatar
const PlayerAvatar = ({ player }: { player: Player }) => {
  const shapeStyle = SHAPES[player.shapeIndex]?.style || {};
  const isSwinging = player.lastActionTime && (Date.now() - player.lastActionTime < 300);

  return (
    <div
      className="absolute flex flex-col items-center justify-center transition-transform duration-100 ease-linear will-change-transform"
      style={{
        transform: `translate(${player.position.x}px, ${player.position.y}px)`,
        zIndex: player.isMe ? 50 : 10,
      }}
    >
      {/* Name Tag */}
      <div 
        className="absolute -top-10 px-2 py-0.5 bg-black/60 backdrop-blur-sm rounded-md text-white text-[10px] font-bold whitespace-nowrap shadow-sm border border-white/10"
      >
        {player.name}
      </div>

      {/* Avatar Body */}
      <div className="relative">
        <div
          className="w-12 h-12 shadow-lg flex items-center justify-center transition-all"
          style={{ 
            backgroundColor: player.color,
            boxShadow: `inset 0 2px 5px rgba(255,255,255,0.3), 0 5px 15px rgba(0,0,0,0.3)`,
            ...shapeStyle
          }}
        >
          {/* Eyes */}
          <div className="flex gap-2 pointer-events-none">
             <div className="w-1.5 h-1.5 bg-black/80 rounded-full" />
             <div className="w-1.5 h-1.5 bg-black/80 rounded-full" />
          </div>
        </div>

        {/* Held Item */}
        {player.heldItemIndex !== -1 && (
          <div 
            className={`absolute -right-4 top-2 origin-bottom-left ${isSwinging ? 'swing-action' : ''}`}
            key={player.lastActionTime} 
          >
            <PixelItem index={player.heldItemIndex} size={5} />
          </div>
        )}
      </div>
    </div>
  );
};

// 4. Chat Overlay
const ChatOverlay = ({ messages, onSend }: { messages: any[], onSend: (msg: string) => void }) => {
  const [inputValue, setInputValue] = useState('');
  const messagesEndRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (inputValue.trim()) {
      onSend(inputValue);
      setInputValue('');
    }
  };

  return (
    <div className="fixed bottom-6 left-6 w-80 max-w-[calc(100vw-3rem)] flex flex-col gap-2 z-[100]">
      <div className="bg-slate-900/80 backdrop-blur-md rounded-lg p-4 h-48 overflow-y-auto shadow-xl border border-slate-700/50 flex flex-col">
        <div className="flex-1" />
        {messages.map((msg) => (
          <div key={msg.id} className="mb-1.5 last:mb-0 text-sm animate-fade-in leading-snug">
            <span style={{ color: msg.color }} className="font-bold mr-2 text-xs uppercase tracking-wide">
              {msg.playerName}
            </span>
            <span className="text-slate-200 break-words">{msg.text}</span>
          </div>
        ))}
        <div ref={messagesEndRef} />
      </div>
      <form onSubmit={handleSubmit} className="relative group">
        <input
          type="text"
          value={inputValue}
          onChange={(e) => setInputValue(e.target.value)}
          placeholder="Chat here..."
          className="w-full bg-slate-800/90 text-white rounded-lg pl-4 pr-12 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-lg border border-slate-700 placeholder:text-slate-500"
        />
        <button
          type="submit"
          className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white transition-colors"
          disabled={!inputValue.trim()}
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
        </button>
      </form>
    </div>
  );
};

// --- MAIN APP ---

const App = () => {
  const [gameState, setGameState] = useState(GAME_STATE.LOBBY);
  const [me, setMe] = useState<Player | null>(null);
  const [peers, setPeers] = useState<Record<string, Player>>({});
  const [messages, setMessages] = useState<any[]>([]);
  const [worldItems, setWorldItems] = useState<WorldItem[]>([]);
  
  // Lobby State
  const [name, setName] = useState('');
  const [selectedColor, setSelectedColor] = useState(COLORS[0]);
  const [selectedShape, setSelectedShape] = useState(0); 
  const [selectedItemIndex, setSelectedItemIndex] = useState<number>(0);
  const [lobbyTab, setLobbyTab] = useState<'shape' | 'color' | 'item'>('shape');

  // Networking Refs
  const roomRef = useRef<any>(null);
  const actionsRef = useRef<any>(null);
  const keysPressed = useRef(new Set<string>());
  const viewportRef = useRef<HTMLDivElement>(null);
  const meRef = useRef<Player | null>(null);
  const worldItemsRef = useRef<WorldItem[]>([]);

  useEffect(() => { meRef.current = me; }, [me]);
  useEffect(() => { worldItemsRef.current = worldItems; }, [worldItems]);

  const joinGame = async () => {
    if (!name.trim()) return;
    
    // Setup Room
    const room = joinRoom({ appId: 'pixelgather-v3-pixelart' }, 'main-hall-v4');
    roomRef.current = room;

    const [sendMove, getMove] = room.makeAction('move');
    const [sendChat, getChat] = room.makeAction('chat');
    const [sendIdentity, getIdentity] = room.makeAction('identity');
    const [sendAction, getAction] = room.makeAction('action');
    const [sendDrop, getDrop] = room.makeAction('drop');
    const [sendPickup, getPickup] = room.makeAction('pickup');

    actionsRef.current = { sendMove, sendChat, sendIdentity, sendAction, sendDrop, sendPickup };

    // Init Player
    const myId = `p-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
    const initialMe: Player = {
      id: myId,
      name: name.trim(),
      color: selectedColor,
      shapeIndex: selectedShape,
      heldItemIndex: selectedItemIndex,
      position: { x: MAP_SIZE / 2 + (Math.random()*200 - 100), y: MAP_SIZE / 2 + (Math.random()*200 - 100) },
      isMe: true
    };
    setMe(initialMe);
    setGameState(GAME_STATE.CONNECTED);

    // Networking Handlers
    getIdentity((data: any, peerId: string) => {
      setPeers(prev => ({ ...prev, [peerId]: { ...data, isMe: false, peerId } }));
    });

    getMove((position: Vector2, peerId: string) => {
      setPeers(prev => prev[peerId] ? { ...prev, [peerId]: { ...prev[peerId], position } } : prev);
    });

    getChat((msg: any) => setMessages(prev => [...prev.slice(-49), msg]));

    getAction((_: any, peerId: string) => {
      setPeers(prev => {
        if(!prev[peerId]) return prev;
        return { ...prev, [peerId]: { ...prev[peerId], lastActionTime: Date.now() } };
      });
    });

    getDrop((item: WorldItem) => {
       setWorldItems(prev => [...prev, item]);
    });

    getPickup((itemId: string, peerId: string) => {
       setWorldItems(prev => prev.filter(i => i.id !== itemId));
    });

    room.onPeerJoin((peerId: string) => {
      if (meRef.current) sendIdentity(meRef.current, peerId);
    });

    room.onPeerLeave((peerId: string) => {
      setPeers(prev => {
        const next = { ...prev };
        delete next[peerId];
        return next;
      });
    });

    setTimeout(() => sendIdentity(initialMe), 500);
  };

  // Game Loop
  useEffect(() => {
    if (gameState !== GAME_STATE.CONNECTED) return;

    const handleKeyDown = (e: KeyboardEvent) => {
       if ((e.target as HTMLElement).tagName === 'INPUT') return;
       keysPressed.current.add(e.code);

       // Action: Swing
       if (e.code === 'Space' && meRef.current?.heldItemIndex !== -1) {
         setMe(prev => {
           if(!prev) return null;
           const updated = { ...prev, lastActionTime: Date.now() };
           actionsRef.current.sendAction(null);
           actionsRef.current.sendIdentity(updated);
           return updated;
         });
       }

       // Action: Throw/Drop
       if (e.code === 'KeyQ' && meRef.current?.heldItemIndex !== -1 && meRef.current) {
          const itemToDrop: WorldItem = {
             id: `item-${Date.now()}-${Math.random()}`,
             itemIndex: meRef.current.heldItemIndex,
             position: { ...meRef.current.position },
             droppedAt: Date.now()
          };
          
          setMe(prev => {
             if(!prev) return null;
             const updated = { ...prev, heldItemIndex: -1 };
             actionsRef.current.sendIdentity(updated);
             return updated;
          });

          setWorldItems(prev => [...prev, itemToDrop]);
          actionsRef.current.sendDrop(itemToDrop);
       }
    };
    
    const handleKeyUp = (e: KeyboardEvent) => keysPressed.current.delete(e.code);
    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('keyup', handleKeyUp);

    let rafId: number;
    const loop = () => {
      if (meRef.current) {
        let dx = 0, dy = 0;
        const keys = keysPressed.current;
        if (keys.has('ArrowUp') || keys.has('KeyW')) dy -= 1;
        if (keys.has('ArrowDown') || keys.has('KeyS')) dy += 1;
        if (keys.has('ArrowLeft') || keys.has('KeyA')) dx -= 1;
        if (keys.has('ArrowRight') || keys.has('KeyD')) dx += 1;

        if (dx !== 0 || dy !== 0) {
          const len = Math.sqrt(dx*dx + dy*dy);
          dx = (dx / len) * MOVE_SPEED;
          dy = (dy / len) * MOVE_SPEED;

          const newPos = {
            x: Math.max(0, Math.min(MAP_SIZE, meRef.current.position.x + dx)),
            y: Math.max(0, Math.min(MAP_SIZE, meRef.current.position.y + dy))
          };

          setMe(prev => prev ? ({ ...prev, position: newPos }) : null);
          actionsRef.current.sendMove(newPos);

          // Auto Pickup
          if (meRef.current.heldItemIndex === -1) {
             const pickupRange = 30;
             const item = worldItemsRef.current.find(i => {
                const dist = Math.sqrt(Math.pow(i.position.x - newPos.x, 2) + Math.pow(i.position.y - newPos.y, 2));
                return dist < pickupRange;
             });

             if (item) {
                setMe(prev => {
                   if(!prev) return null;
                   const updated = { ...prev, heldItemIndex: item.itemIndex };
                   actionsRef.current.sendIdentity(updated);
                   return updated;
                });
                setWorldItems(prev => prev.filter(i => i.id !== item.id));
                actionsRef.current.sendPickup(item.id);
             }
          }
        }
      }
      rafId = requestAnimationFrame(loop);
    };
    rafId = requestAnimationFrame(loop);

    return () => {
      window.removeEventListener('keydown', handleKeyDown);
      window.removeEventListener('keyup', handleKeyUp);
      cancelAnimationFrame(rafId);
    };
  }, [gameState]);

  useEffect(() => {
    if (gameState === GAME_STATE.CONNECTED && me && viewportRef.current) {
      const halfW = window.innerWidth / 2;
      const halfH = window.innerHeight / 2;
      viewportRef.current.scrollTo(me.position.x - halfW, me.position.y - halfH);
    }
  }, [me?.position, gameState]);

  const handleSendChat = (text: string) => {
    if (!me) return;
    const msg = {
      id: `msg-${Date.now()}`,
      playerId: me.id,
      playerName: me.name,
      color: me.color,
      text,
      timestamp: Date.now()
    };
    setMessages(prev => [...prev.slice(-49), msg]);
    actionsRef.current.sendChat(msg);
  };

  // --- RENDER LOBBY ---
  if (gameState === GAME_STATE.LOBBY) {
    return (
      <div className="w-full h-[100dvh] flex flex-col items-center justify-center bg-slate-900 text-white p-4 relative overflow-hidden">
        {/* Animated Background */}
        <div className="absolute inset-0 opacity-10 pointer-events-none">
           {SHAPES.slice(0,20).map((s, i) => (
             <div key={i} className="absolute animate-bounce-small" 
                  style={{ 
                    ...s.style, 
                    backgroundColor: COLORS[i], 
                    width: '60px', height: '60px', 
                    left: `${Math.random()*100}%`, top: `${Math.random()*100}%`,
                    animationDuration: `${3 + Math.random()*5}s`
                  }} />
           ))}
        </div>

        {/* Lobby Container - Flex col for mobile layout safety */}
        <div className="w-full max-w-2xl h-full max-h-[90dvh] bg-slate-800/95 backdrop-blur-lg rounded-2xl shadow-2xl border border-slate-700 flex flex-col md:flex-row overflow-hidden relative z-10">
          
          {/* Left: Preview (Sticky on desktop, top on mobile) */}
          <div className="w-full md:w-1/3 bg-slate-900/50 p-6 flex flex-col items-center justify-center border-b md:border-b-0 md:border-r border-slate-700 shrink-0">
             <h2 className="text-sm font-bold text-slate-400 mb-6 uppercase tracking-widest hidden md:block">Preview</h2>
             <div className="relative mb-6 transform scale-150">
                <div 
                  className="w-20 h-20 shadow-[0_0_30px_rgba(0,0,0,0.5)] transition-all duration-300 relative"
                  style={{ 
                    backgroundColor: selectedColor,
                    ...SHAPES[selectedShape].style
                  }}
                >
                  <div className="w-full h-full flex items-center justify-center gap-2">
                     <div className="w-1.5 h-1.5 bg-black/50 rounded-full" />
                     <div className="w-1.5 h-1.5 bg-black/50 rounded-full" />
                  </div>
                </div>
                {selectedItemIndex !== -1 && (
                   <div className="absolute -right-6 -top-2 animate-bounce-small">
                     <PixelItem index={selectedItemIndex} size={8} />
                   </div>
                )}
             </div>
             <p className="font-bold text-lg md:text-xl">{name || 'Player'}</p>
          </div>

          {/* Right: Controls (Scrollable) */}
          <div className="w-full md:w-2/3 flex flex-col h-full overflow-hidden">
             
             {/* Sticky Header inside Right Panel */}
             <div className="p-6 pb-2 shrink-0 bg-slate-800 z-10">
               <div className="mb-4">
                  <label className="block text-[10px] font-bold text-slate-500 mb-1 uppercase">Display Name</label>
                  <input
                     type="text" value={name} onChange={(e) => setName(e.target.value)} maxLength={12}
                     className="w-full bg-slate-950 border border-slate-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none text-white font-medium"
                     placeholder="Enter nickname..."
                  />
               </div>

               <div className="flex border-b border-slate-700">
                 {['shape', 'color', 'item'].map(tab => (
                   <button 
                     key={tab}
                     onClick={() => setLobbyTab(tab as any)}
                     className={`flex-1 py-2 text-xs font-bold uppercase tracking-wider transition-colors border-b-2 ${lobbyTab === tab ? 'border-blue-500 text-white' : 'border-transparent text-slate-500 hover:text-slate-300'}`}
                   >
                     {tab}
                   </button>
                 ))}
               </div>
             </div>

             {/* Scrollable Grid Content */}
             <div className="flex-1 overflow-y-auto overflow-x-hidden p-6 pt-2 min-h-0 touch-pan-y">
               {lobbyTab === 'shape' && (
                 <div className="grid grid-cols-4 gap-3">
                   {SHAPES.map((s, i) => (
                     <button key={i} onClick={() => setSelectedShape(i)} className={`aspect-square bg-slate-700 rounded-lg flex items-center justify-center hover:bg-slate-600 transition-all ${selectedShape === i ? 'ring-2 ring-blue-500 bg-slate-600' : ''}`}>
                       <div style={{...s.style, width: '50%', height: '50%', backgroundColor: '#cbd5e1'}} />
                     </button>
                   ))}
                 </div>
               )}

               {lobbyTab === 'color' && (
                 <div className="grid grid-cols-6 gap-3">
                   {COLORS.map((c, i) => (
                     <button key={i} onClick={() => setSelectedColor(c)} className={`aspect-square rounded-full transition-transform active:scale-95 ${selectedColor === c ? 'ring-2 ring-white scale-110' : ''}`} style={{ backgroundColor: c }} />
                   ))}
                 </div>
               )}

               {lobbyTab === 'item' && (
                 <div className="grid grid-cols-4 gap-2 pb-12">
                   <button onClick={() => setSelectedItemIndex(-1)} className={`aspect-square bg-slate-700 rounded-lg flex items-center justify-center text-xs text-slate-400 hover:bg-slate-600 ${selectedItemIndex === -1 ? 'ring-2 ring-blue-500' : ''}`}>None</button>
                   {ITEMS.map((item, i) => (
                     <button key={i} onClick={() => setSelectedItemIndex(i)} className={`aspect-square bg-slate-700 rounded-lg flex flex-col items-center justify-center hover:bg-slate-600 transition-all ${selectedItemIndex === i ? 'ring-2 ring-blue-500 bg-slate-600' : ''}`}>
                       <PixelItem index={i} size={5} />
                       <span className="text-[8px] text-slate-400 mt-1 truncate w-full text-center px-1">{item.name}</span>
                     </button>
                   ))}
                 </div>
               )}
             </div>

             {/* Sticky Footer */}
             <div className="p-4 border-t border-slate-700 bg-slate-800 shrink-0">
               <button
                  onClick={joinGame} disabled={!name.trim()}
                  className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 disabled:opacity-50 text-white font-bold py-3 rounded-lg shadow-lg transform active:scale-[0.98] transition-all"
               >
                  Enter World
               </button>
             </div>
          </div>
        </div>
      </div>
    );
  }

  // --- RENDER WORLD ---
  const allPlayers = [me, ...Object.values(peers)].filter((p): p is Player => !!p);

  return (
    <div className="relative w-full h-full bg-slate-950">
       <div ref={viewportRef} className="w-full h-full overflow-hidden relative cursor-crosshair">
          <div style={{ width: MAP_SIZE, height: MAP_SIZE }} className="relative bg-[#0f172a]">
             {/* Grid Pattern */}
             <div className="absolute inset-0 opacity-20 pointer-events-none" 
                  style={{ backgroundImage: 'linear-gradient(#334155 1px, transparent 1px), linear-gradient(90deg, #334155 1px, transparent 1px)', backgroundSize: '50px 50px' }} />
             
             {/* World Items */}
             {worldItems.map(item => <WorldItemComponent key={item.id} item={item} />)}

             {/* Players */}
             {allPlayers.map(p => <PlayerAvatar key={p.id || p.peerId} player={p} />)}
          </div>
       </div>

       {/* HUD */}
       <div className="fixed top-4 left-4 z-[90] flex gap-2">
         <div className="bg-black/40 backdrop-blur px-3 py-1.5 rounded-full text-slate-300 text-xs font-mono border border-white/10 flex items-center gap-2">
           <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
           {Object.keys(peers).length + 1} Online
         </div>
       </div>

       {/* Controls Guide */}
       <div className="fixed bottom-6 right-6 z-[90] text-right pointer-events-none">
          <div className="flex flex-col gap-1 text-[10px] text-white/40 font-mono">
            <span>[WASD] Move</span>
            <span>[SPACE] Swing</span>
            <span>[Q] Drop</span>
          </div>
       </div>

       <ChatOverlay messages={messages} onSend={handleSendChat} />
    </div>
  );
};

export default App;
