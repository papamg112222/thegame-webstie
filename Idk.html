<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Urban Survival Prototype</title>
<style>
  /* Basic styling for the entire page */
  body { margin: 0; overflow: hidden; background-color: black; }
  /* Styling for the instruction/info panel */
  #info { 
    position: absolute; 
    top: 10px; 
    left: 10px; 
    color: white; 
    font-family: Arial, sans-serif;
    background: rgba(0, 0, 0, 0.5); /* Semi-transparent background for readability */
    padding: 10px;
    border-radius: 5px;
  }
</style>
</head>
<body>
<div id="info">Click to start. Use WASD to move. Find the red cube (item).</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.156.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.156.0/examples/js/controls/PointerLockControls.js"></script>

<script>
// Core variables
let scene, camera, renderer, controls, item;
const playerHeight = 2; // The camera's initial height above the floor

// Initialize the scene, camera, and renderer
init();
// Start the main game loop
animate();

function init() {
    // --- Scene Setup ---
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb); // Light sky blue background

    // --- Camera Setup ---
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.y = playerHeight;
    // Note: The PointerLockControls automatically manages the camera's position/rotation.

    // --- Renderer Setup ---
    renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // --- Lighting ---
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(10, 20, 10);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x404040)); // Soft, general light

    // --- Floor ---
    const floorGeo = new THREE.PlaneGeometry(100, 100);
    const floorMat = new THREE.MeshStandardMaterial({color: 0x555555});
    const floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI/2; // Rotate to lie flat on the XZ plane
    scene.add(floor);

    // --- Controls ---
    controls = new THREE.PointerLockControls(camera, document.body);
    // Lock the cursor when the user clicks the screen to start movement
    document.body.addEventListener('click', () => controls.lock());

    // --- Item (Red Cube) ---
    const itemGeo = new THREE.BoxGeometry(1, 1, 1);
    const itemMat = new THREE.MeshStandardMaterial({color: 0xff0000});
    item = new THREE.Mesh(itemGeo, itemMat);
    item.position.set(5, 0.5, -5); // Positioned half-height (0.5) above the floor
    scene.add(item);

    // --- Event Listeners ---
    document.addEventListener('keydown', onKeyDown);
    document.addEventListener('keyup', onKeyUp);

    // Handle window resizing
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
}

// --- Movement State and Variables ---
const move = {forward:false, backward:false, left:false, right:false};
const velocity = new THREE.Vector3();
const speed = 0.1;

function onKeyDown(e){
    if(e.code==='KeyW') move.forward=true;
    if(e.code==='KeyS') move.backward=true;
    if(e.code==='KeyA') move.left=true;
    if(e.code==='KeyD') move.right=true;
}

function onKeyUp(e){
    if(e.code==='KeyW') move.forward=false;
    if(e.code==='KeyS') move.backward=false;
    if(e.code==='KeyA') move.left=false;
    if(e.code==='KeyD') move.right=false;
}

// --- Day/Night Cycle Logic ---
let time = 0;
function updateDayNight(){
    time += 0.01;
    if(time > 24) time = 0; // Reset time after a full cycle

    // Calculate intensity using a sine function, clamped at 0.2 for night
    const intensity = Math.max(Math.sin((time/24)*Math.PI), 0.2);
    
    // Apply intensity to the directional light
    scene.children.forEach(child => {
        if(child.type==='DirectionalLight') child.intensity = intensity;
    });
    
    // Update sky background color (Lightness scales with intensity)
    scene.background.setHSL(0.6, 0.6, 0.5 * intensity + 0.2);
}

// --- Main Animation Loop ---
function animate(){
    requestAnimationFrame(animate);

    // 1. Update Movement
    velocity.set(0,0,0);
    if(move.forward) velocity.z -= speed;
    if(move.backward) velocity.z += speed;
    if(move.left) velocity.x -= speed;
    if(move.right) velocity.x += speed;

    controls.moveRight(velocity.x);
    controls.moveForward(velocity.z);

    // 2. Item Pickup Check (Horizontal Distance Only)
    
    // Clone camera and item positions, setting Y to 0 to check ground-plane distance
    const playerXZ = camera.position.clone();
    playerXZ.y = 0; 
    
    const itemXZ = item.position.clone();
    itemXZ.y = 0; 

    // Check if the horizontal distance is less than 1.5 units and the item is visible
    if(playerXZ.distanceTo(itemXZ) < 1.5 && item.visible){
        item.visible = false;
        document.getElementById('info').innerText = 'Item Collected! ðŸŽ‰';
    }

    // 3. Update Environment
    updateDayNight();
    
    // 4. Render the scene
    renderer.render(scene, camera);
}
</script>
</body>
</html>
