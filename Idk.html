<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="https://picsum.photos/32/32" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PixelGather - Multiplayer</title>
    
    <!-- Styles & Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: #0f172a;
        font-family: 'Inter', system-ui, sans-serif;
        touch-action: none; /* Prevent scroll on mobile */
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }

      .animate-fade-in { animation: fadeIn 0.3s ease-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <!-- MAIN APPLICATION CODE -->
    <script type="text/babel" data-type="module">
      import { joinRoom } from 'https://esm.sh/trystero@0.22.0/torrent';

      // --- CONSTANTS ---
      const MAP_SIZE = 3000;
      const MOVE_SPEED = 10;
      const PLAYER_COLORS = [
        '#ef4444', '#f97316', '#eab308', '#22c55e', 
        '#06b6d4', '#3b82f6', '#a855f7', '#ec4899'
      ];
      const GAME_STATE = { LOBBY: 'LOBBY', CONNECTED: 'CONNECTED' };

      // --- COMPONENTS ---

      // 1. Player Avatar
      const PlayerAvatar = ({ player }) => {
        return (
          <div
            className="absolute flex flex-col items-center justify-center transition-transform duration-100 ease-linear pointer-events-none will-change-transform"
            style={{
              transform: `translate(${player.position.x}px, ${player.position.y}px)`,
              zIndex: player.isMe ? 50 : 10,
            }}
          >
            <div 
              className="mb-2 px-2 py-0.5 bg-black/50 backdrop-blur-sm rounded-full text-white text-xs font-medium whitespace-nowrap shadow-sm"
              style={{ border: player.isMe ? `1px solid ${player.color}` : 'none' }}
            >
              {player.name}
            </div>
            <div
              className="w-8 h-8 rounded-full shadow-lg flex items-center justify-center relative"
              style={{ 
                backgroundColor: player.color,
                boxShadow: `0 0 15px ${player.color}40`
              }}
            >
              <div className="w-2 h-2 bg-white/80 rounded-full" />
              {player.isMe && (
                <div className="absolute w-full h-full rounded-full animate-ping opacity-20 bg-white" />
              )}
            </div>
          </div>
        );
      };

      // 2. Chat Overlay
      const ChatOverlay = ({ messages, onSend }) => {
        const [inputValue, setInputValue] = React.useState('');
        const messagesEndRef = React.useRef(null);

        React.useEffect(() => {
          messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        }, [messages]);

        const handleSubmit = (e) => {
          e.preventDefault();
          if (inputValue.trim()) {
            onSend(inputValue);
            setInputValue('');
          }
        };

        return (
          <div className="fixed bottom-6 left-6 w-80 max-w-[calc(100vw-3rem)] flex flex-col gap-2 z-50">
            <div className="bg-slate-900/80 backdrop-blur-md rounded-lg p-4 h-64 overflow-y-auto shadow-xl border border-slate-700/50 flex flex-col">
              <div className="flex-1" />
              {messages.map((msg) => (
                <div key={msg.id} className="mb-2 last:mb-0 text-sm animate-fade-in">
                  <span style={{ color: msg.color }} className="font-bold mr-2">
                    {msg.playerName}:
                  </span>
                  <span className="text-slate-200 break-words">{msg.text}</span>
                </div>
              ))}
              <div ref={messagesEndRef} />
            </div>
            <form onSubmit={handleSubmit} className="relative group">
              <input
                type="text"
                value={inputValue}
                onChange={(e) => setInputValue(e.target.value)}
                placeholder="Say something..."
                className="w-full bg-slate-800/90 text-white rounded-lg pl-4 pr-10 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-lg border border-slate-700 transition-all placeholder:text-slate-500"
              />
              <button
                type="submit"
                className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white transition-colors"
                disabled={!inputValue.trim()}
              >
                Send
              </button>
            </form>
          </div>
        );
      };

      // --- MAIN APP LOGIC ---

      const App = () => {
        const [gameState, setGameState] = React.useState(GAME_STATE.LOBBY);
        const [me, setMe] = React.useState(null);
        const [peers, setPeers] = React.useState({}); // Map of peerId -> Player
        const [messages, setMessages] = React.useState([]);
        const [connecting, setConnecting] = React.useState(false);

        // Lobby inputs
        const [name, setName] = React.useState('');
        const [selectedColor, setSelectedColor] = React.useState(PLAYER_COLORS[0]);

        // Refs for networking and loop
        const roomRef = React.useRef(null);
        const actionsRef = React.useRef(null);
        const keysPressed = React.useRef(new Set());
        const viewportRef = React.useRef(null);
        const meRef = React.useRef(null); // Latest 'me' state for networking

        React.useEffect(() => {
          meRef.current = me;
        }, [me]);

        // --- NETWORKING (Trystero) ---
        const joinGame = async () => {
          if (!name.trim()) return;
          setConnecting(true);

          // 1. Setup Room
          const room = joinRoom({ appId: 'pixelgather-v-one-file' }, 'main-hall');
          roomRef.current = room;

          // 2. Setup Actions
          const [sendMove, getMove] = room.makeAction('move');
          const [sendChat, getChat] = room.makeAction('chat');
          const [sendIdentity, getIdentity] = room.makeAction('identity');
          actionsRef.current = { sendMove, sendChat, sendIdentity };

          // 3. Initialize My Player
          const myId = `p-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          const initialMe = {
             id: myId,
             name: name.trim(),
             color: selectedColor,
             position: { x: MAP_SIZE / 2 + (Math.random()*100 - 50), y: MAP_SIZE / 2 + (Math.random()*100 - 50) },
             isMe: true
          };
          setMe(initialMe);
          setGameState(GAME_STATE.CONNECTED);

          // 4. Network Handlers
          
          // Identity: When someone tells us who they are
          getIdentity((data, peerId) => {
            setPeers(prev => ({
              ...prev,
              [peerId]: { ...data, isMe: false, peerId }
            }));
          });

          // Move: When someone moves
          getMove((position, peerId) => {
             setPeers(prev => {
                if (!prev[peerId]) return prev; // Don't move unknown peers, wait for identity
                return {
                   ...prev,
                   [peerId]: { ...prev[peerId], position }
                };
             });
          });

          // Chat: When message received
          getChat((msg, peerId) => {
             setMessages(prev => [...prev.slice(-49), msg]);
          });

          // Peer Join: Send them my identity immediately
          room.onPeerJoin(peerId => {
             console.log('Peer joined:', peerId);
             if (meRef.current) {
                sendIdentity(meRef.current, peerId);
             }
          });

          // Peer Leave
          room.onPeerLeave(peerId => {
             setPeers(prev => {
                const next = { ...prev };
                delete next[peerId];
                return next;
             });
          });

          // Broadcast my identity to everyone just in case
          // Give network a moment to settle
          setTimeout(() => {
             sendIdentity(initialMe);
          }, 1000);

          setConnecting(false);
        };

        // --- GAME LOOP ---
        React.useEffect(() => {
          if (gameState !== GAME_STATE.CONNECTED) return;

          const handleKeyDown = (e) => keysPressed.current.add(e.code);
          const handleKeyUp = (e) => keysPressed.current.delete(e.code);
          window.addEventListener('keydown', handleKeyDown);
          window.addEventListener('keyup', handleKeyUp);

          let rafId;
          const loop = () => {
            if (meRef.current) {
               let dx = 0;
               let dy = 0;
               const keys = keysPressed.current;

               if (keys.has('ArrowUp') || keys.has('KeyW')) dy -= 1;
               if (keys.has('ArrowDown') || keys.has('KeyS')) dy += 1;
               if (keys.has('ArrowLeft') || keys.has('KeyA')) dx -= 1;
               if (keys.has('ArrowRight') || keys.has('KeyD')) dx += 1;

               if (dx !== 0 || dy !== 0) {
                  const len = Math.sqrt(dx*dx + dy*dy);
                  dx = (dx / len) * MOVE_SPEED;
                  dy = (dy / len) * MOVE_SPEED;

                  const newPos = {
                     x: Math.max(0, Math.min(MAP_SIZE, meRef.current.position.x + dx)),
                     y: Math.max(0, Math.min(MAP_SIZE, meRef.current.position.y + dy))
                  };

                  // Local Update
                  setMe(prev => ({ ...prev, position: newPos }));
                  
                  // Network Update (Rate limit could be added here for optimization)
                  if (actionsRef.current) {
                     actionsRef.current.sendMove(newPos);
                  }
               }
            }
            rafId = requestAnimationFrame(loop);
          };
          rafId = requestAnimationFrame(loop);

          return () => {
             window.removeEventListener('keydown', handleKeyDown);
             window.removeEventListener('keyup', handleKeyUp);
             cancelAnimationFrame(rafId);
          };
        }, [gameState]);

        // Camera Follow
        React.useEffect(() => {
           if (gameState === GAME_STATE.CONNECTED && me && viewportRef.current) {
              const halfW = window.innerWidth / 2;
              const halfH = window.innerHeight / 2;
              viewportRef.current.scrollTo(me.position.x - halfW, me.position.y - halfH);
           }
        }, [me?.position, gameState]);

        const handleSendChat = (text) => {
           if (!me) return;
           const msg = {
              id: `msg-${Date.now()}`,
              playerId: me.id,
              playerName: me.name,
              color: me.color,
              text,
              timestamp: Date.now()
           };
           // Local Add
           setMessages(prev => [...prev.slice(-49), msg]);
           // Network Send
           if (actionsRef.current) actionsRef.current.sendChat(msg);
        };

        // --- RENDER LOBBY ---
        if (gameState === GAME_STATE.LOBBY) {
           return (
             <div className="w-full h-full flex items-center justify-center bg-slate-900 text-white p-4">
               <div className="max-w-md w-full bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700">
                 <h1 className="text-3xl font-bold text-center mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">PixelGather</h1>
                 <p className="text-center text-slate-400 mb-8 text-sm">Real-time P2P Multiplayer</p>

                 <div className="space-y-6">
                   <div>
                     <label className="block text-xs font-medium text-slate-400 mb-2 uppercase tracking-wider">Display Name</label>
                     <input
                       type="text" value={name} onChange={(e) => setName(e.target.value)} maxLength={12}
                       className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                       placeholder="Enter your name"
                     />
                   </div>
                   <div>
                     <label className="block text-xs font-medium text-slate-400 mb-2 uppercase tracking-wider">Avatar Color</label>
                     <div className="flex flex-wrap gap-3">
                       {PLAYER_COLORS.map(c => (
                         <button
                           key={c} onClick={() => setSelectedColor(c)}
                           className={`w-10 h-10 rounded-full transition-transform hover:scale-110 ${selectedColor === c ? 'ring-2 ring-white scale-110' : ''}`}
                           style={{ backgroundColor: c }}
                         />
                       ))}
                     </div>
                   </div>
                   <button
                     onClick={joinGame} disabled={!name.trim() || connecting}
                     className="w-full bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white font-bold py-3 rounded-lg transition-all transform active:scale-95 shadow-lg"
                   >
                     {connecting ? 'Connecting...' : 'Join World'}
                   </button>
                   <p className="text-center text-xs text-slate-600">No AI • Real People • P2P Connection</p>
                 </div>
               </div>
             </div>
           );
        }

        // --- RENDER WORLD ---
        const allPlayers = [me, ...Object.values(peers)].filter(Boolean);

        return (
          <div className="relative w-full h-full bg-slate-950">
             <div ref={viewportRef} className="w-full h-full overflow-hidden relative" style={{ scrollBehavior: 'auto' }}>
                <div style={{ width: MAP_SIZE, height: MAP_SIZE }} className="relative bg-[#0f172a]">
                   <div className="absolute inset-0 opacity-20 pointer-events-none" 
                        style={{ backgroundImage: 'linear-gradient(#334155 1px, transparent 1px), linear-gradient(90deg, #334155 1px, transparent 1px)', backgroundSize: '50px 50px' }} />
                   <div className="absolute inset-0 border-4 border-red-500/30 pointer-events-none" />
                   
                   {allPlayers.map(p => <PlayerAvatar key={p.id || p.peerId} player={p} />)}
                </div>
             </div>

             {/* HUD */}
             <div className="fixed top-4 left-4 z-50">
               <div className="bg-black/40 backdrop-blur px-4 py-2 rounded-full text-slate-300 text-xs font-mono border border-white/10 flex items-center gap-2">
                 <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                 Peers: {Object.keys(peers).length}
               </div>
             </div>

             <div className="fixed top-4 right-4 z-50 text-slate-500 text-xs font-mono pointer-events-none">
                {Math.round(me.position.x)}, {Math.round(me.position.y)}
             </div>

             <ChatOverlay messages={messages} onSend={handleSendChat} />
             
             <div className="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none opacity-0 animate-fade-in text-white/50 text-xl font-bold" style={{ animationDelay: '1s', animationDirection: 'reverse', animationFillMode: 'forwards' }}>
               WASD to Move
             </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
