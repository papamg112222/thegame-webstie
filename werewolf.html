<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Werewolf: The Ritual</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Quicksand:wght@400;500;700&display=swap');

        :root {
            --bg-dark: #0a0514;
            --purple-main: #1e0b3a;
            --purple-accent: #7c3aed;
            --gold: #ffd700;
            --gold-glow: rgba(255, 215, 0, 0.2);
        }

        body {
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(46, 16, 101, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(30, 11, 58, 0.4) 0%, transparent 50%);
            color: #e0d7f0;
            font-family: 'Quicksand', sans-serif;
            margin: 0;
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        h1, h2, h3, .role-name, .btn {
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
        }

        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 1rem;
            text-align: center;
            overflow-y: auto;
        }

        @media (min-width: 640px) {
            .screen { padding: 2rem; }
        }

        .screen.active {
            display: flex;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn {
            background: linear-gradient(135deg, #4c1d95, #2e1065);
            color: white;
            padding: 1rem 2rem;
            border-radius: 4px;
            font-weight: 700;
            letter-spacing: 2px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(124, 58, 237, 0.5);
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            position: relative;
            overflow: hidden;
            width: 100%;
            font-size: 0.9rem;
        }

        @media (min-width: 640px) {
            .btn {
                padding: 1.2rem 3rem;
                letter-spacing: 3px;
                font-size: 1rem;
            }
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px var(--gold-glow);
            border-color: var(--gold);
            background: linear-gradient(135deg, #5b21b6, #4c1d95);
        }

        .btn:active { transform: translateY(1px); }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .btn-sm {
            padding: 0.6rem 1.2rem;
            font-size: 0.7rem;
            letter-spacing: 1px;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
            margin-right: 6px;
        }
        .status-dot.online {
            background: #22c55e;
            box-shadow: 0 0 10px #22c55e;
        }

        .slot-outer {
            position: relative;
            width: 100%;
            height: 380px;
            background: rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            border-top: 1px solid rgba(255, 215, 0, 0.1);
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
        }

        .slot-container {
            position: relative;
            width: 100%;
            height: 360px;
            overflow: visible;
            display: flex;
            align-items: center;
        }

        .slot-track {
            display: flex;
            position: absolute;
            left: 0;
            transition: transform 6s cubic-bezier(0.1, 0, 0.05, 1);
            will-change: transform;
            align-items: center;
        }

        .card {
            min-width: 200px;
            height: auto;
            min-height: 280px;
            max-height: 340px;
            margin: 0 10px;
            background: #000;
            border: 1px solid rgba(76, 29, 149, 0.5);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }

        @media (min-width: 640px) {
            .card {
                min-width: 220px;
                margin: 0 12px;
            }
        }

        .card.winner {
            transform: scale(1.1);
            border: 2px solid var(--gold);
            box-shadow: 0 0 40px var(--gold-glow);
            z-index: 100;
        }

        .card-media-box {
            width: 100%;
            height: auto;
            min-height: 160px;
            max-height: 220px;
            background: #000;
            margin-bottom: 1rem;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .card-media-box img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .card-label {
            font-size: 0.85rem;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            color: var(--gold);
            letter-spacing: 2px;
            text-align: center;
        }

        .selector-box {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 220px;
            height: 300px;
            border: 2px solid var(--gold);
            pointer-events: none;
            z-index: 50;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.15), inset 0 0 20px rgba(255, 215, 0, 0.1);
        }

        .role-reveal-title {
            font-size: 3.5rem;
            color: var(--gold);
            margin: 0.5rem 0;
            text-shadow: 0 0 40px rgba(255, 215, 0, 0.5);
            font-weight: 900;
            letter-spacing: -2px;
        }

        @media (min-width: 640px) {
            .role-reveal-title { font-size: 4.5rem; }
        }

        .player-indicator {
            background: rgba(124, 58, 237, 0.15);
            padding: 0.6rem 2rem;
            border-radius: 2px;
            border: 1px solid rgba(124, 58, 237, 0.3);
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            letter-spacing: 2px;
            margin-bottom: 1rem;
            color: #c4b5fd;
        }

        .sync-pnl {
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(124, 58, 237, 0.3);
            padding: 2rem;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            backdrop-filter: blur(5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        .illustration-container {
            width: 240px;
            height: auto;
            min-height: 240px;
            margin: 1.5rem auto;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--gold);
            background: #000;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        @media (min-width: 640px) {
            .illustration-container { width: 280px; min-height: 280px; }
        }

        .illustration-container img {
            width: 100%;
            height: auto;
            display: block;
        }

        #loading-overlay {
            position: fixed;
            inset: 0;
            background: #05020a;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .grimoire-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            width: 100%;
            max-width: 1200px;
            padding: 0.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .grimoire-grid { grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
        }
        @media (min-width: 1024px) {
            .grimoire-grid { grid-template-columns: repeat(5, 1fr); }
        }

        .grimoire-item {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,215,0,0.2);
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            height: fit-content;
        }

        .grimoire-img {
            width: 100%;
            height: auto;
            max-height: 220px;
            background: #000;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            object-fit: contain;
            display: block;
        }

        .quick-edit-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            width: 100%;
            max-width: 1100px;
            padding: 1rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .quick-edit-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .quick-edit-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #2e1065; border-radius: 10px; }

        .reset-trigger {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 200;
            opacity: 0.2;
            transition: opacity 0.3s;
            cursor: pointer;
            color: var(--gold);
        }
        .reset-trigger:hover { opacity: 1; }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            z-index: 300;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        
        .modal-box {
            background: var(--purple-main);
            border: 1px solid var(--gold);
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            max-width: 300px;
            width: 90%;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-gold"></div>
        <p class="mt-6 font-bold tracking-[0.3em] text-gold/60 uppercase text-xs">Awakening...</p>
    </div>

    <!-- GLOBAL RESET TRIGGER -->
    <div class="reset-trigger" onclick="window.showResetModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
            <path d="M3 3v5h5"></path>
        </svg>
    </div>

    <!-- RESET MODAL -->
    <div id="reset-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="text-gold font-bold mb-4 tracking-widest text-sm">PURGE RITUAL DATA</h3>
            <p class="text-[10px] opacity-60 mb-6 uppercase tracking-widest">Enter Code to reset all pictures and names</p>
            <input type="password" id="reset-code-input" class="w-full bg-black/40 border border-gold/30 rounded px-3 py-2 text-center text-gold mb-6 outline-none focus:border-gold" placeholder="CODE">
            <div class="flex gap-2">
                <button class="btn btn-sm grow !py-3 !bg-transparent !border-white/10" onclick="window.hideResetModal()">Cancel</button>
                <button class="btn btn-sm grow !py-3 !border-red-500/50" onclick="window.confirmReset()">Reset</button>
            </div>
        </div>
    </div>

    <!-- START SCREEN -->
    <div id="screen-start" class="screen active">
        <div class="mb-8 sm:mb-12">
            <svg class="w-16 h-16 sm:w-24 sm:h-24 mx-auto text-gold opacity-80" viewBox="0 0 100 100" fill="currentColor">
                <path d="M50 10 L60 40 L90 40 L65 60 L75 90 L50 70 L25 90 L35 60 L10 40 L40 40 Z" />
            </svg>
        </div>
        <h1 class="text-6xl sm:text-8xl font-black mb-2 text-white tracking-tighter italic">WEREWOLF</h1>
        <p class="text-[10px] sm:text-xs opacity-40 tracking-[0.4em] sm:tracking-[0.8em] uppercase mb-12 sm:mb-16">The Ritual of Deception</p>
        
        <div class="flex flex-col gap-4 w-full max-w-[280px] sm:max-w-xs">
            <button class="btn" onclick="window.goTo('screen-select')">Join Ritual</button>
            <button class="btn !bg-transparent !border-white/20 !shadow-none" onclick="window.openGrimoire()">The Grimoire</button>
        </div>
    </div>

    <!-- GRIMOIRE (DETAILS) SCREEN -->
    <div id="screen-grimoire" class="screen">
        <div class="flex items-center gap-1.5 mb-6">
            <h2 class="text-2xl sm:text-3xl font-bold tracking-[0.2em] text-gold uppercase">THE GRIMOIRE</h2>
            <button onclick="window.openQuickEditor()" class="opacity-20 hover:opacity-100 transition-opacity cursor-pointer p-0.5 mt-1" title="Quick Edit Deck">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </button>
        </div>
        <p class="text-[9px] sm:text-[10px] tracking-widest uppercase opacity-40 mb-6 italic">Study the roles before the moon rises</p>
        
        <div id="grimoire-container" class="grimoire-grid mb-8"></div>

        <div class="flex flex-col sm:flex-row gap-3 w-full max-w-[300px] sm:max-w-md">
             <button class="btn btn-sm !py-3 sm:!py-4 !bg-transparent !border-white/10 !text-[10px]" onclick="window.openCustomizer()">Host Room</button>
             <button class="btn btn-sm !py-3 sm:!py-4 !bg-transparent !border-white/10" onclick="window.goTo('screen-start')">Return</button>
        </div>
    </div>

    <!-- QUICK EDITOR SCREEN -->
    <div id="screen-quick-edit" class="screen">
        <h2 class="text-xl sm:text-2xl font-bold mb-4 tracking-[0.2em] text-gold">DECK PAINTER</h2>
        <p class="text-[9px] sm:text-[10px] opacity-40 uppercase tracking-[0.3em] mb-6">Rename and Illustrate standard roles</p>
        
        <div id="quick-edit-container" class="quick-edit-grid mb-8"></div>

        <div class="flex gap-4 w-full max-w-sm">
            <button class="btn !py-3 !bg-transparent !border-white/10" onclick="window.goTo('screen-grimoire')">Cancel</button>
            <button class="btn !py-3" onclick="window.saveQuickEdits()">Save</button>
        </div>
    </div>

    <!-- CUSTOMIZER SCREEN (NOW HOST ROOM) -->
    <div id="screen-custom" class="screen">
        <h2 class="text-xl sm:text-2xl font-bold mb-8 tracking-[0.2em] text-gold">HOST ROOM</h2>
        
        <div class="sync-pnl text-left text-[10px]">
            <div class="flex items-center justify-between mb-6">
                <div class="uppercase tracking-widest font-bold opacity-60">
                    <span id="sync-dot" class="status-dot"></span> 
                    <span id="sync-status-text">Local Only</span>
                </div>
                <div id="room-display" class="text-gold font-bold hidden">ROOM: <span id="room-id-val" class="tracking-widest">----</span></div>
            </div>
            
            <div id="sync-controls" class="flex flex-col gap-4">
                <div class="flex flex-col sm:flex-row gap-2">
                    <button class="btn btn-sm grow !py-2 !text-[9px] !px-4" onclick="window.hostSession()">Host Sync</button>
                    <div class="flex grow gap-2">
                        <input type="text" id="join-id-input" placeholder="Room ID" class="grow bg-black/40 border border-white/10 rounded px-3 text-xs font-bold uppercase tracking-widest outline-none focus:border-gold/50">
                        <button class="btn btn-sm !py-2" onclick="window.joinSession()">Join</button>
                    </div>
                </div>
                
                <button id="disconnect-btn" class="btn btn-sm w-full !bg-red-950/20 !border-red-500/30 !text-red-400 !py-3 tracking-[0.2em] hidden" onclick="window.disconnectSession()">Terminate Connection</button>
            </div>
        </div>

        <div class="mt-12 w-full max-w-xs">
            <button class="btn !py-3 !bg-transparent !border-white/10" onclick="window.goTo('screen-grimoire')">Back to Grimoire</button>
        </div>
    </div>

    <!-- SELECTOR PAGE -->
    <div id="screen-select" class="screen">
        <h2 class="text-2xl sm:text-3xl font-bold mb-8 tracking-widest opacity-80">SUMMON VILLAGERS</h2>
        <div class="text-7xl sm:text-9xl font-black text-white mb-4" id="player-count-display">4</div>
        <p class="text-xs sm:text-sm tracking-[0.4em] uppercase opacity-40 mb-10 sm:mb-12">Participants</p>
        
        <input type="range" id="player-range" min="4" max="16" value="4" step="1" 
               class="w-full max-w-md h-1 bg-purple-900 rounded-lg appearance-none cursor-pointer accent-gold mb-12 sm:mb-16"
               oninput="window.updateCount(this.value)">

        <p class="text-[9px] font-bold tracking-widest uppercase py-2 px-6 rounded-full border border-white/5 bg-white/5 mb-10 sm:mb-12" id="mode-indicator">Mode: Standard Roles</p>
        
        <button class="btn max-w-[240px]" onclick="window.setupGame()">Proceed</button>
    </div>

    <!-- RNG ANIMATION PAGE -->
    <div id="screen-rng" class="screen" style="max-width: 100%; padding: 0; overflow: hidden;">
        <div id="player-turn-info" class="player-indicator">Player 1's Turn</div>
        <h2 class="text-[10px] mb-6 tracking-[0.4em] uppercase opacity-30">Casting the Lots...</h2>
        
        <div class="slot-outer">
            <div class="selector-box"></div>
            <div class="slot-container">
                <div id="slot-track" class="slot-track"></div>
            </div>
        </div>

        <button id="spin-btn" class="btn max-w-[240px]" onclick="window.startSpin()">Draw My Fate</button>
    </div>

    <!-- RESULT PAGE -->
    <div id="screen-result" class="screen">
        <div class="player-indicator" id="result-player-title">Player 1</div>
        
        <div id="result-illustration" class="illustration-container"></div>
        
        <div id="final-role-display" class="role-reveal-title">WEREWOLF</div>
        <div id="role-description" class="text-sm sm:text-md opacity-60 mb-10 sm:mb-12 max-w-md px-4 leading-relaxed italic font-medium"></div>
        
        <div class="p-3 sm:p-4 bg-red-950/20 rounded border border-red-500/20 mb-8 sm:mb-10 animate-pulse">
            <p class="text-[9px] sm:text-[10px] font-bold text-red-400 tracking-[0.2em] sm:tracking-[0.3em] uppercase">Private: Do not show others</p>
        </div>

        <button id="next-player-btn" class="btn max-w-[240px]" onclick="window.nextPlayer()">I Understand</button>
    </div>

    <script>
        // Global State
        window.totalPlayers = 4;
        window.currentPlayerIndex = 0;
        window.gameRoles = [];
        window.isSpinning = false;
        window.customRolesData = Array(20).fill(null).map(() => ({ name: '', img: '', desc: '' }));
        window.standardOverrides = {}; 
        window.customRolesPool = [];
        window.useCustomDeck = false;

        // P2P State
        let peer = null;
        let connections = [];
        let isHost = false;

        const roleData = {
            'Werewolf': { desc: 'The classic predator. Hunt with your pack under the cover of night.' },
            'Alpha Wolf': { desc: 'The apex killer. Your vote is supreme within the werewolf pack.' },
            'Villager': { desc: 'A simple soul. Use your intuition to root out the evil among you.' },
            'Seer': { desc: 'Gifted with vision. Peek into the hearts of others once per night.' },
            'Doctor': { desc: 'The healer. Choose one soul to protect from the claws of the pack.' },
            'Hunter': { desc: 'Dying breath. Take one player with you to the grave upon your death.' },
            'Witch': { desc: 'Master of potions. You possess the power to save or to kill once.' },
            'Bodyguard': { desc: 'The shield. Defend a player nightly, but never the same twice.' },
            'Tanner': { desc: 'The martyr. You win only if the village votes for your execution.' },
            'Cupid': { desc: 'The weaver. Bind two souls together in an eternal, tragic link.' }
        };

        const getSimilarity = (s1, s2) => {
            s1 = (s1 || "").toLowerCase().trim();
            s2 = (s2 || "").toLowerCase().trim();
            if (s1 === s2) return 1;
            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) costs[j] = j;
                    else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1))
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            const maxLength = Math.max(s1.length, s2.length);
            return (maxLength - costs[s2.length]) / maxLength;
        };

        window.onload = () => {
            const savedSlots = localStorage.getItem('werewolf_p2p_deck_v2');
            if (savedSlots) window.customRolesData = JSON.parse(savedSlots);
            
            const savedOverrides = localStorage.getItem('werewolf_standard_overrides');
            if (savedOverrides) window.standardOverrides = JSON.parse(savedOverrides);
            
            updateInternalPool();

            setTimeout(() => {
                document.getElementById('loading-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 500);
            }, 800);
        };

        window.showResetModal = () => {
            document.getElementById('reset-modal').classList.add('active');
            document.getElementById('reset-code-input').focus();
        };

        window.hideResetModal = () => {
            document.getElementById('reset-modal').classList.remove('active');
            document.getElementById('reset-code-input').value = '';
        };

        window.confirmReset = () => {
            const input = document.getElementById('reset-code-input').value;
            if (input === '1090') {
                localStorage.removeItem('werewolf_p2p_deck_v2');
                localStorage.removeItem('werewolf_standard_overrides');
                window.customRolesData = Array(20).fill(null).map(() => ({ name: '', img: '', desc: '' }));
                window.standardOverrides = {};
                updateInternalPool();
                broadcastDeck();
                hideResetModal();
                window.goTo('screen-start');
            } else {
                document.getElementById('reset-code-input').classList.add('border-red-500');
                setTimeout(() => document.getElementById('reset-code-input').classList.remove('border-red-500'), 1000);
            }
        };

        window.hostSession = () => {
            if (peer) peer.destroy();
            const roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            peer = new Peer('WOLF-' + roomCode);
            isHost = true;
            peer.on('open', () => {
                document.getElementById('room-id-val').innerText = roomCode;
                document.getElementById('room-display').classList.remove('hidden');
                document.getElementById('sync-dot').classList.add('online');
                document.getElementById('sync-status-text').innerText = "Hosting Session";
                document.getElementById('disconnect-btn').classList.remove('hidden');
            });
            peer.on('connection', (conn) => {
                connections.push(conn);
                conn.on('open', () => conn.send({ 
                    type: 'DECK_UPDATE', 
                    data: window.customRolesData,
                    overrides: window.standardOverrides 
                }));
                conn.on('data', handleData);
            });
        };

        window.joinSession = () => {
            const id = document.getElementById('join-id-input').value.toUpperCase();
            if (!id) return;
            if (peer) peer.destroy();
            peer = new Peer();
            isHost = false;
            peer.on('open', () => {
                const conn = peer.connect('WOLF-' + id);
                conn.on('open', () => {
                    connections.push(conn);
                    document.getElementById('sync-dot').classList.add('online');
                    document.getElementById('sync-status-text').innerText = "Sync Active";
                    document.getElementById('room-id-val').innerText = id;
                    document.getElementById('room-display').classList.remove('hidden');
                    document.getElementById('disconnect-btn').classList.remove('hidden');
                });
                conn.on('data', handleData);
            });
        };

        window.disconnectSession = () => {
            if (peer) peer.destroy();
            peer = null;
            connections = [];
            isHost = false;
            document.getElementById('room-id-val').innerText = "----";
            document.getElementById('room-display').classList.add('hidden');
            document.getElementById('sync-dot').classList.remove('online');
            document.getElementById('sync-status-text').innerText = "Local Only";
            document.getElementById('disconnect-btn').classList.add('hidden');
        };

        const handleData = (payload) => {
            if (payload.type === 'DECK_UPDATE') {
                if (payload.data) {
                    window.customRolesData = payload.data;
                    localStorage.setItem('werewolf_p2p_deck_v2', JSON.stringify(payload.data));
                }
                if (payload.overrides) {
                    window.standardOverrides = payload.overrides;
                    localStorage.setItem('werewolf_standard_overrides', JSON.stringify(payload.overrides));
                }
                updateInternalPool();
            }
        };

        const broadcastDeck = () => {
            connections.forEach(conn => { 
                if (conn.open) conn.send({ 
                    type: 'DECK_UPDATE', 
                    data: window.customRolesData,
                    overrides: window.standardOverrides 
                }); 
            });
        };

        window.updateInternalPool = () => {
            window.customRolesPool = window.customRolesData.filter(r => r && r.name && r.img && r.img.length > 50);
            window.useCustomDeck = window.customRolesPool.length > 0;
            const msg = document.getElementById('mode-indicator');
            if (window.useCustomDeck) {
                msg.innerText = `SYNCED DECK: ${window.customRolesPool.length} ROLES`;
                msg.classList.add('text-yellow-400');
            } else {
                msg.innerText = "STANDARD RITUAL DECK";
                msg.classList.remove('text-yellow-400');
            }
        };

        const findFuzzyOverride = (standardName) => {
            if (window.standardOverrides[standardName]) {
                const ov = window.standardOverrides[standardName];
                if (ov.name || ov.img) return ov;
            }
            let bestMatch = null;
            let highestScore = 0;
            const threshold = 0.7; 
            window.customRolesPool.forEach(custom => {
                const score = getSimilarity(custom.name, standardName);
                if (score > highestScore && score >= threshold) {
                    highestScore = score;
                    bestMatch = custom;
                }
            });
            return bestMatch;
        };

        window.openQuickEditor = () => {
            const container = document.getElementById('quick-edit-container');
            container.innerHTML = '';
            Object.keys(roleData).forEach(stdName => {
                const override = window.standardOverrides[stdName] || { name: stdName, img: '' };
                const card = document.createElement('div');
                card.className = 'quick-edit-card';
                card.innerHTML = `
                    <div class="relative group flex-shrink-0">
                        <img id="quick-prev-${stdName}" class="img-preview w-12 h-12" src="${override.img || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}">
                        <input type="file" id="quick-file-${stdName}" class="hidden" accept="image/*" onchange="window.handleQuickFile(event, '${stdName}')">
                        <button onclick="document.getElementById('quick-file-${stdName}').click()" class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex items-center justify-center text-[8px] font-bold">SET</button>
                    </div>
                    <div class="flex flex-col grow gap-1">
                        <span class="text-[8px] text-white/40 font-bold tracking-widest uppercase">${stdName}</span>
                        <input type="text" id="quick-name-${stdName}" value="${override.name}" class="bg-black/40 border border-white/10 rounded px-2 py-1 text-xs text-gold">
                    </div>
                `;
                container.appendChild(card);
            });
            window.goTo('screen-quick-edit');
        };

        window.handleQuickFile = (event, stdName) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const imgEl = document.getElementById(`quick-prev-${stdName}`);
                imgEl.src = e.target.result;
                imgEl.dataset.newImg = e.target.result; 
            };
            reader.readAsDataURL(file);
        };

        window.saveQuickEdits = () => {
            const newOverrides = { ...window.standardOverrides };
            Object.keys(roleData).forEach(stdName => {
                const nameVal = document.getElementById(`quick-name-${stdName}`).value.trim();
                const imgEl = document.getElementById(`quick-prev-${stdName}`);
                const imgVal = imgEl.dataset.newImg || (window.standardOverrides[stdName]?.img || '');
                newOverrides[stdName] = { 
                    name: nameVal, 
                    img: imgVal,
                    desc: roleData[stdName].desc 
                };
            });
            window.standardOverrides = newOverrides;
            localStorage.setItem('werewolf_standard_overrides', JSON.stringify(newOverrides));
            broadcastDeck();
            window.openGrimoire();
        };

        window.openGrimoire = () => {
            const container = document.getElementById('grimoire-container');
            container.innerHTML = '';
            const displayed = new Set();
            Object.keys(roleData).forEach(name => {
                const override = findFuzzyOverride(name);
                const role = override ? override : { name, img: 'standard', desc: roleData[name].desc };
                addGrimoireItem(container, role);
                displayed.add(role.name.toLowerCase());
            });
            window.customRolesPool.forEach(custom => {
                if (!displayed.has(custom.name.toLowerCase())) {
                    addGrimoireItem(container, custom);
                }
            });
            window.goTo('screen-grimoire');
        };

        const addGrimoireItem = (container, role) => {
            const item = document.createElement('div');
            item.className = 'grimoire-item';
            const media = (role.img && role.img.length > 50) ? `<img src="${role.img}" class="grimoire-img">` : `<div class="grimoire-img bg-black border border-white/5 flex items-center justify-center text-[8px] opacity-20" style="height:100px">NO ART</div>`;
            const desc = role.desc || roleData[role.name]?.desc || "A mysterious soul in the ritual.";
            item.innerHTML = `
                ${media}
                <div class="text-gold font-bold text-[10px] sm:text-xs mb-1 tracking-widest">${role.name}</div>
                <div class="text-[9px] opacity-60 leading-tight italic">${desc}</div>
            `;
            container.appendChild(item);
        };

        window.openCustomizer = () => {
            window.goTo('screen-custom');
        };

        window.goTo = (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        };

        window.updateCount = (val) => {
            window.totalPlayers = parseInt(val);
            document.getElementById('player-count-display').innerText = val;
        };

        window.setupGame = () => {
            const stdNames = calculateStandardRoles(window.totalPlayers);
            let assigned = stdNames.map(name => {
                const override = findFuzzyOverride(name);
                if (override) return { ...override, desc: roleData[name]?.desc || override.desc };
                return { name, img: 'standard', desc: roleData[name]?.desc || 'A mysterious member of the ritual.' };
            });
            const usedNames = new Set(assigned.filter(r => r.img !== 'standard').map(r => r.name.toLowerCase().trim()));
            let unused = window.customRolesPool.filter(c => !usedNames.has(c.name.toLowerCase().trim()));
            if (unused.length > 0) {
                for (let i = 0; i < assigned.length; i++) {
                    if (assigned[i].name === 'Villager' && assigned[i].img === 'standard' && unused.length > 0) {
                        assigned[i] = unused.shift();
                    }
                }
            }
            window.gameRoles = assigned.sort(() => Math.random() - 0.5);
            window.currentPlayerIndex = 0;
            window.prepareSpin();
            window.goTo('screen-rng');
        };

        const calculateStandardRoles = (count) => {
            let roles = [];
            let wolfCount = Math.max(1, Math.floor(count / 4));
            roles.push('Alpha Wolf');
            for (let i = 1; i < wolfCount; i++) roles.push('Werewolf');
            roles.push('Seer'); roles.push('Doctor');
            if (count >= 6) roles.push('Hunter');
            if (count >= 8) roles.push('Witch');
            if (count >= 10) roles.push('Bodyguard');
            if (count >= 12) roles.push('Cupid');
            if (count >= 14) roles.push('Tanner');
            while (roles.length < count) roles.push('Villager');
            return roles;
        };

        const getRoleMedia = (roleObj) => {
            if (roleObj && roleObj.img && roleObj.img.length > 50) {
                return `<div class="card-media-box"><img src="${roleObj.img}" alt="${roleObj.name}"></div>`;
            }
            return `<div class="card-media-box bg-black"></div>`;
        };

        window.prepareSpin = () => {
            const track = document.getElementById('slot-track');
            const spinBtn = document.getElementById('spin-btn');
            spinBtn.disabled = false;
            document.getElementById('player-turn-info').innerText = `Player ${window.currentPlayerIndex + 1}`;
            track.style.transition = 'none';
            track.style.transform = 'translateX(0px)';
            const targetIndex = 45; 
            track.innerHTML = '';
            let fluff = [...window.customRolesPool];
            Object.keys(roleData).forEach(k => {
                const ov = findFuzzyOverride(k);
                fluff.push(ov ? ov : { name: k, img: 'standard' });
            });
            for (let i = 0; i < 50; i++) {
                const card = document.createElement('div');
                card.className = 'card';
                card.id = `card-slot-${i}`;
                let role = (i === targetIndex) ? window.gameRoles[window.currentPlayerIndex] : fluff[Math.floor(Math.random() * fluff.length)];
                card.innerHTML = `${getRoleMedia(role)}<div class="card-label">${role.name}</div>`;
                track.appendChild(card);
            }
        };

        window.startSpin = () => {
            if (window.isSpinning) return;
            window.isSpinning = true;
            const track = document.getElementById('slot-track');
            const spinBtn = document.getElementById('spin-btn');
            spinBtn.disabled = true;
            const containerWidth = window.innerWidth;
            const cardWidth = window.innerWidth < 640 ? 220 : 244; 
            const targetIndex = 45; 
            const centerOffset = (containerWidth / 2) - (cardWidth / 2);
            const targetPos = -(targetIndex * cardWidth) + centerOffset;
            track.style.transition = 'transform 6s cubic-bezier(0.1, 0, 0.05, 1)';
            track.style.transform = `translateX(${targetPos}px)`;
            setTimeout(() => {
                const winner = document.getElementById(`card-slot-${targetIndex}`);
                if (winner) winner.classList.add('winner');
            }, 5500);
            setTimeout(() => {
                window.showResult();
                window.isSpinning = false;
            }, 7500);
        };

        window.showResult = () => {
            const role = window.gameRoles[window.currentPlayerIndex];
            document.getElementById('result-player-title').innerText = `Player ${window.currentPlayerIndex + 1}`;
            document.getElementById('final-role-display').innerText = role.name;
            document.getElementById('role-description').innerText = role.desc || "A secret role within the pack.";
            document.getElementById('result-illustration').innerHTML = getRoleMedia(role);
            const nextBtn = document.getElementById('next-player-btn');
            nextBtn.innerText = (window.currentPlayerIndex === window.totalPlayers - 1) ? "Seal the Ritual" : "Pass Device";
            window.goTo('screen-result');
        };

        window.nextPlayer = () => {
            window.currentPlayerIndex++;
            if (window.currentPlayerIndex < window.totalPlayers) {
                window.prepareSpin();
                window.goTo('screen-rng');
            } else {
                window.goTo('screen-start');
            }
        };
    </script>
</body>
</html>
